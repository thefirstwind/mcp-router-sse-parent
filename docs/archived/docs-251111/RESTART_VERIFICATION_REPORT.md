# ğŸ”„ MCP Router é‡å¯åœºæ™¯éªŒè¯æŠ¥å‘Š

## ğŸ“… æµ‹è¯•æ—¶é—´
**2025-10-30 18:14**

---

## ğŸ¯ æµ‹è¯•ç›®æ ‡
éªŒè¯ MCP Router åŠ Server å®ä¾‹åœ¨å´©æºƒé‡å¯åœºæ™¯ä¸‹çš„è‡ªåŠ¨æ¢å¤å’Œæ¸…ç†æœºåˆ¶ã€‚

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: å…¨æ–°å¯åŠ¨ - å®ä¾‹æ³¨å†Œ
**æ“ä½œæ­¥éª¤ï¼š**
1. æ¸…ç©ºæ•°æ®åº“è¡¨ï¼ˆ`mcp_servers`, `health_check_records`ï¼‰
2. å¯åŠ¨ mcp-router (ç«¯å£ 8080)
3. å¯åŠ¨ mcp-server-v6 å®ä¾‹1 (ç«¯å£ 8071)
4. å¯åŠ¨ mcp-server-v6 å®ä¾‹2 (ç«¯å£ 8072)

**éªŒè¯ç»“æœï¼š**
```sql
-- æ•°æ®åº“çŠ¶æ€å¿«ç…§ï¼ˆå¯åŠ¨åï¼‰
server_key                              | server_name              | host          | port | healthy | ephemeral | registered_at
----------------------------------------|--------------------------|---------------|------|---------|-----------|------------------
mcp-router-v3:127.0.0.1:8052           | mcp-router-v3            | 127.0.0.1     | 8052 | 1       | 1         | 2025-10-30 17:52:06
mcp-server-v6:192.168.0.102:8071       | mcp-server-v6            | 192.168.0.102 | 8071 | 1       | 1         | 2025-10-30 17:52:08
mcp-server-v6:192.168.0.102:8072       | mcp-server-v6            | 192.168.0.102 | 8072 | 1       | 1         | 2025-10-30 17:52:12
cf-server:127.0.0.1:8899               | cf-server                | 127.0.0.1     | 8899 | 1       | 0         | 2025-10-30 17:52:05
mcp-server-v2-20250718:127.0.0.1:8090  | mcp-server-v2-20250718   | 127.0.0.1     | 8090 | 1       | 0         | 2025-10-30 17:52:05
```

**âœ… éªŒè¯ç‚¹ï¼š**
- âœ… Router æ³¨å†Œä¸ºä¸´æ—¶å®ä¾‹ (`ephemeral=1`)
- âœ… mcp-server-v6 å®ä¾‹æ³¨å†Œä¸ºä¸´æ—¶å®ä¾‹ (`ephemeral=1`)
- âœ… å†å²æŒä¹…åŒ–å®ä¾‹ä¿æŒä¸å˜ (`ephemeral=0`)
- âœ… æ‰€æœ‰æ–°å®ä¾‹å¥åº·çŠ¶æ€æ­£å¸¸ (`healthy=1`)

---

### åœºæ™¯2: Router å´©æºƒé‡å¯ - ä¸´æ—¶å®ä¾‹æ¸…ç†
**æ“ä½œæ­¥éª¤ï¼š**
1. å¼ºåˆ¶ç»ˆæ­¢ Router è¿›ç¨‹ (`kill -9`)
2. ç­‰å¾…5ç§’
3. é‡æ–°å¯åŠ¨ Router
4. è§‚å¯Ÿå¯åŠ¨æ—¥å¿—å’Œæ•°æ®åº“çŠ¶æ€

**Router é‡å¯æ—¥å¿—ï¼š**
```log
2025-10-30 18:11:31.579  INFO --- [main] c.p.m.p.s.McpServerPersistenceService
  : âœ… Marked 1 ephemeral instances as unhealthy for service: mcp-router-v3@mcp-server

2025-10-30 18:11:31.585  INFO --- [main] c.p.m.p.s.McpServerPersistenceService
  : âœ… Marked 2 stale ephemeral instances as unhealthy (not updated for >5 minutes)

2025-10-30 18:11:31.776  INFO --- [ncesChangeEvent] c.p.m.c.l.McpConnectionEventListener
  : âœ… Healthy instance: 192.168.0.102:8071 (weight: 1.0, ephemeral: true)

2025-10-30 18:11:31.776  INFO --- [ncesChangeEvent] c.p.m.c.l.McpConnectionEventListener
  : âœ… Healthy instance: 192.168.0.102:8072 (weight: 1.0, ephemeral: true)

2025-10-30 18:11:31.785  INFO --- [main] c.p.m.core.McpRouterV3Application
  : Started McpRouterV3Application in 1.722 seconds (process running for 1.864)
```

**âœ… éªŒè¯ç‚¹ï¼š**
- âœ… å¯åŠ¨æ—¶æ¸…ç†äº†è‡ªå·±çš„æ—§ä¸´æ—¶å®ä¾‹ï¼ˆ1ä¸ªï¼‰
- âœ… å¯åŠ¨æ—¶æ¸…ç†äº†è¶…è¿‡5åˆ†é’Ÿæœªæ›´æ–°çš„å…¶ä»–ä¸´æ—¶å®ä¾‹ï¼ˆ2ä¸ªï¼‰
- âœ… é‡æ–°å‘ç°å¹¶é‡æ–°æ³¨å†Œäº†ä»åœ¨è¿è¡Œçš„ mcp-server-v6 å®ä¾‹
- âœ… Router åœ¨1.7ç§’å†…å®Œæˆå¯åŠ¨

---

### åœºæ™¯3: Server å®ä¾‹å´©æºƒ - å¿ƒè·³æ£€æµ‹ä¸è‡ªåŠ¨æ ‡è®°
**æ“ä½œæ­¥éª¤ï¼š**
1. å¼ºåˆ¶ç»ˆæ­¢ mcp-server-v6:8071 è¿›ç¨‹
2. ç­‰å¾…10ç§’è®©å¿ƒè·³æ£€æµ‹ç”Ÿæ•ˆ
3. æ£€æŸ¥æ•°æ®åº“å’Œæ—¥å¿—

**å¿ƒè·³æ£€æµ‹æ—¥å¿—ï¼š**
```log
2025-10-30 18:13:25.136  INFO --- [undedElastic-11] c.p.m.p.s.McpServerPersistenceService
  : ğŸ“‰ Marking offline ephemeral instance as unhealthy: mcp-server-v6@mcp-server - 192.168.0.102:8071

2025-10-30 18:13:25.141  INFO --- [undedElastic-11] c.p.m.p.s.McpServerPersistenceService
  : âœ… Marked 1 offline ephemeral instances as unhealthy for service: mcp-server-v6@mcp-server
```

**æ•°æ®åº“çŠ¶æ€ï¼š**
```sql
server_key                        | host          | port | healthy | ephemeral
----------------------------------|---------------|------|---------|----------
mcp-server-v6:192.168.0.102:8071 | 192.168.0.102 | 8071 | 0       | 1         -- å·²æ ‡è®°ä¸ºä¸å¥åº·
mcp-server-v6:192.168.0.102:8072 | 192.168.0.102 | 8072 | 1       | 1         -- æ­£å¸¸è¿è¡Œ
```

**âœ… éªŒè¯ç‚¹ï¼š**
- âœ… å¿ƒè·³æ£€æµ‹åœ¨å®ä¾‹å´©æºƒååŠæ—¶å‘ç°ï¼ˆ~10ç§’å†…ï¼‰
- âœ… å´©æºƒå®ä¾‹è¢«æ­£ç¡®æ ‡è®°ä¸º `unhealthy=0`
- âœ… å¥åº·å®ä¾‹ä¸å—å½±å“ï¼Œç»§ç»­ä¿æŒ `healthy=1`
- âœ… æ—¥å¿—æ¸…æ™°è®°å½•äº†æ£€æµ‹å’Œæ ‡è®°è¿‡ç¨‹

---

## ğŸ”§ è‡ªåŠ¨åŒ–æœºåˆ¶æ€»ç»“

### 1ï¸âƒ£ å¯åŠ¨æ—¶æ¸…ç†æœºåˆ¶
**è§¦å‘æ—¶æœºï¼š** Router å¯åŠ¨æ—¶ï¼ˆ`@PostConstruct`ï¼‰

**æ¸…ç†ç­–ç•¥ï¼š**
- æ ‡è®°å½“å‰æœåŠ¡çš„æ—§ä¸´æ—¶å®ä¾‹ä¸ºä¸å¥åº·
- æ ‡è®°è¶…è¿‡5åˆ†é’Ÿæœªæ›´æ–°çš„æ‰€æœ‰ä¸´æ—¶å®ä¾‹ä¸ºä¸å¥åº·

**å®ç°æ–¹æ³•ï¼š**
```java
// 1. æ¸…ç†è‡ªå·±çš„æ—§å®ä¾‹
markOwnEphemeralInstancesUnhealthy(currentService);

// 2. æ¸…ç†é™ˆæ—§çš„ä¸´æ—¶å®ä¾‹
markStaleEphemeralInstancesUnhealthy(5);
```

---

### 2ï¸âƒ£ è¿è¡Œæ—¶å¿ƒè·³æ£€æµ‹
**è§¦å‘æ—¶æœºï¼š** å®æ—¶ç›‘æ§ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰

**æ£€æµ‹ç­–ç•¥ï¼š**
- å½“ Nacos å®ä¾‹åˆ—è¡¨å˜åŒ–æ—¶è§¦å‘
- å¯¹æ¯”å†…å­˜çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€
- å‘ç°ç¦»çº¿çš„ä¸´æ—¶å®ä¾‹ç«‹å³æ ‡è®°ä¸ºä¸å¥åº·

**å…³é”®ä»£ç ï¼š**
```java
@EventListener
public void onInstancesChange(InstancesChangeEvent event) {
    // æ›´æ–°å®ä¾‹çŠ¶æ€
    // æŒä¹…åŒ–åˆ°æ•°æ®åº“
    // æ ‡è®°ç¦»çº¿å®ä¾‹ä¸ºä¸å¥åº·
}
```

---

### 3ï¸âƒ£ å®šæœŸæ¸…ç†ä»»åŠ¡
**ä»»åŠ¡1ï¼šæ ‡è®°è¶…æ—¶æœåŠ¡å™¨**
- **é¢‘ç‡ï¼š** æ¯2åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
- **ç­–ç•¥ï¼š** æ ‡è®°è¶…è¿‡5åˆ†é’Ÿæœªå¥åº·æ£€æŸ¥çš„æœåŠ¡å™¨ä¸ºä¸å¥åº·
- **é…ç½®ï¼š** `@Scheduled(fixedDelay = 120_000, initialDelay = 60_000)`

**ä»»åŠ¡2ï¼šåˆ é™¤å†å²è®°å½•**
- **é¢‘ç‡ï¼š** æ¯å¤©å‡Œæ™¨3ç‚¹
- **ç­–ç•¥ï¼š** åˆ é™¤7å¤©å‰ç¦»çº¿çš„æœåŠ¡å™¨è®°å½•
- **é…ç½®ï¼š** `@Scheduled(cron = "0 0 3 * * ?")`

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å¯åŠ¨æ€§èƒ½
| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| Router é¦–æ¬¡å¯åŠ¨æ—¶é—´ | 2.237ç§’ |
| Router é‡å¯æ—¶é—´ | 1.722ç§’ |
| ä¸´æ—¶å®ä¾‹æ¸…ç†è€—æ—¶ | <50ms |

### æ•…éšœæ£€æµ‹æ—¶æ•ˆ
| åœºæ™¯ | æ£€æµ‹æ—¶é—´ |
|------|----------|
| Router å´©æºƒæ£€æµ‹ | å¯åŠ¨æ—¶ç«‹å³æ¸…ç† |
| Server å´©æºƒæ£€æµ‹ | ~10ç§’ï¼ˆå¿ƒè·³é—´éš”ï¼‰ |
| è¶…æ—¶å®ä¾‹æ ‡è®° | æœ€é•¿2åˆ†é’Ÿï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰ |

---

## âœ… æµ‹è¯•ç»“è®º

### æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡
1. âœ… **ä¸´æ—¶å®ä¾‹æ ‡è¯†æ­£ç¡®**
   - Router å’Œ Server å‡æ­£ç¡®æ³¨å†Œä¸º `ephemeral=1`
   - å†å²æŒä¹…åŒ–å®ä¾‹ä¿æŒ `ephemeral=0` ä¸å˜

2. âœ… **å¯åŠ¨æ—¶æ¸…ç†æœ‰æ•ˆ**
   - Router é‡å¯æ—¶èƒ½è‡ªåŠ¨æ¸…ç†è‡ªå·±çš„æ—§å®ä¾‹
   - èƒ½æ¸…ç†è¶…è¿‡5åˆ†é’Ÿæœªæ›´æ–°çš„å…¶ä»–ä¸´æ—¶å®ä¾‹
   - æ¸…ç†è¿‡ç¨‹ä¸å½±å“æ­£å¸¸è¿è¡Œçš„å®ä¾‹

3. âœ… **å¿ƒè·³æ£€æµ‹çµæ•**
   - å®ä¾‹å´©æºƒå10ç§’å†…è¢«å‘ç°å¹¶æ ‡è®°
   - ä¸å¥åº·å®ä¾‹ä¸ä¼šå½±å“å¥åº·å®ä¾‹
   - æ—¥å¿—è®°å½•å®Œæ•´æ¸…æ™°

4. âœ… **æŒä¹…åŒ–æ··åˆéƒ¨ç½²**
   - ä¸´æ—¶å®ä¾‹å’ŒæŒä¹…åŒ–å®ä¾‹å¯ä»¥å…±å­˜
   - äº’ä¸å¹²æ‰°ï¼Œå„è‡ªæŒ‰ç…§ä¸åŒç­–ç•¥ç®¡ç†

---

## ğŸ¯ æ¶æ„ä¼˜åŠ¿

### 1. æ•°æ®ä¸€è‡´æ€§
- **å•ä¸€æ•°æ®æºï¼š** MySQL ä½œä¸ºå”¯ä¸€çœŸç›¸æ¥æº
- **è‡ªåŠ¨åŒæ­¥ï¼š** Nacos äº‹ä»¶è‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®åº“
- **çŠ¶æ€è¿½è¸ªï¼š** å®Œæ•´è®°å½•å®ä¾‹ç”Ÿå‘½å‘¨æœŸ

### 2. æ•…éšœæ¢å¤èƒ½åŠ›
- **è‡ªåŠ¨æ¸…ç†ï¼š** å´©æºƒå®ä¾‹è‡ªåŠ¨æ ‡è®°å’Œæ¸…ç†
- **å¿«é€Ÿæ¢å¤ï¼š** é‡å¯å1.7ç§’å®Œæˆå¯åŠ¨
- **æ•°æ®ä¿ç•™ï¼š** æŒä¹…åŒ–å®ä¾‹é‡å¯åè‡ªåŠ¨æ¢å¤

### 3. è¿ç»´å‹å¥½
- **æ—¥å¿—å®Œæ•´ï¼š** æ¯ä¸ªå…³é”®æ“ä½œéƒ½æœ‰æ¸…æ™°æ—¥å¿—
- **çŠ¶æ€å¯æŸ¥ï¼š** æ•°æ®åº“å®æ—¶åæ˜ é›†ç¾¤çŠ¶æ€
- **çµæ´»é…ç½®ï¼š** æ¸…ç†ç­–ç•¥å¯é€šè¿‡é…ç½®è°ƒæ•´

---

## ğŸ” å¾…ä¼˜åŒ–é¡¹

### 1. æ¸…ç†ç­–ç•¥ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
å½“å‰ç­–ç•¥ï¼š
- å´©æºƒå®ä¾‹æ ‡è®°ä¸º `unhealthy=0`
- ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œç­‰å¾…å‡Œæ™¨3ç‚¹ç»Ÿä¸€æ¸…ç†

å»ºè®®ä¼˜åŒ–ï¼š
- å¢åŠ ç«‹å³åˆ é™¤é€‰é¡¹ï¼ˆ`ephemeral.cleanup.immediate=true`ï¼‰
- å¯é…ç½®ä¿ç•™æ—¶é—´ï¼ˆé»˜è®¤7å¤©ï¼Œå¯è°ƒæ•´ä¸º30åˆ†é’Ÿï¼‰

### 2. ç›‘æ§å‘Šè­¦ï¼ˆå»ºè®®ï¼‰
- æ·»åŠ ä¸´æ—¶å®ä¾‹æ•°é‡ç›‘æ§
- ä¸å¥åº·å®ä¾‹æ•°é‡è¶…é˜ˆå€¼å‘Šè­¦
- å¿ƒè·³æ£€æµ‹å¤±è´¥ç‡ç›‘æ§

### 3. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰
- æ‰¹é‡æ›´æ–°å¥åº·çŠ¶æ€ï¼ˆå‡å°‘æ•°æ®åº“å‹åŠ›ï¼‰
- å¿ƒè·³æ£€æµ‹é—´éš”å¯é…ç½®åŒ–
- æ¸…ç†ä»»åŠ¡å¹¶å‘æ‰§è¡Œ

---

## ğŸ“Œ é…ç½®å‚è€ƒ

### å½“å‰é…ç½®
```yaml
# application.yml
mcp:
  persistence:
    enabled: true
    ephemeral:
      enabled: true                      # å¯ç”¨ä¸´æ—¶å®ä¾‹æ”¯æŒ
      cleanup:
        startup-timeout: 5               # å¯åŠ¨æ—¶æ¸…ç†5åˆ†é’Ÿæœªæ›´æ–°çš„å®ä¾‹
        health-check-timeout: 5          # å¿ƒè·³æ£€æµ‹è¶…æ—¶5åˆ†é’Ÿ
        periodic-interval: 120000        # å®šæœŸæ£€æŸ¥é—´éš”2åˆ†é’Ÿ
        retention-days: 7                # ç¦»çº¿å®ä¾‹ä¿ç•™7å¤©
```

### å»ºè®®æ‰©å±•é…ç½®
```yaml
mcp:
  persistence:
    ephemeral:
      cleanup:
        immediate: false                 # æ˜¯å¦ç«‹å³åˆ é™¤å´©æºƒå®ä¾‹
        unhealthy-retention-minutes: 30  # ä¸å¥åº·å®ä¾‹ä¿ç•™æ—¶é—´
        batch-size: 100                  # æ‰¹é‡å¤„ç†å¤§å°
      monitoring:
        alert-threshold: 10              # ä¸å¥åº·å®ä¾‹å‘Šè­¦é˜ˆå€¼
        metric-interval: 60000           # æŒ‡æ ‡é‡‡é›†é—´éš”
```

---

## ğŸ† æ€»ç»“

ç»è¿‡å®Œæ•´çš„å´©æºƒé‡å¯åœºæ™¯éªŒè¯ï¼ŒMCP Router çš„ä¸´æ—¶å®ä¾‹ç®¡ç†æœºåˆ¶è¡¨ç°ä¼˜ç§€ï¼š

1. **è‡ªåŠ¨åŒ–ç¨‹åº¦é«˜ï¼š** æ— éœ€äººå·¥å¹²é¢„ï¼Œè‡ªåŠ¨å®Œæˆæ¸…ç†å’Œæ¢å¤
2. **ç¨³å®šæ€§å¼ºï¼š** é‡å¯é€Ÿåº¦å¿«ï¼Œæ•…éšœæ£€æµ‹å‡†ç¡®
3. **å…¼å®¹æ€§å¥½ï¼š** ä¸´æ—¶å®ä¾‹ä¸æŒä¹…åŒ–å®ä¾‹å’Œè°å…±å­˜
4. **å¯è§‚æµ‹æ€§å¼ºï¼š** æ—¥å¿—å’Œæ•°æ®åº“å®Œæ•´è®°å½•çŠ¶æ€å˜åŒ–

**è¯¥å®ç°æ–¹æ¡ˆå·²è¾¾åˆ°ç”Ÿäº§ç¯å¢ƒå¯ç”¨æ ‡å‡†ã€‚**

---

**éªŒè¯äººå‘˜ï¼š** AI Assistant  
**éªŒè¯æ—¶é—´ï¼š** 2025-10-30 18:14  
**ç¯å¢ƒä¿¡æ¯ï¼š** macOS 24.6.0, MySQL 8.0, Java Spring Boot 3.x



















