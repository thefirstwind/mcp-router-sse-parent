# MCP Router V3 持久化功能实施检查清单

> **版本**: v1.0  
> **创建日期**: 2025-10-30  
> **用途**: 开发过程跟踪和验收标准

---

## 📋 使用说明

- ✅ 已完成
- 🚧 进行中
- ⏳ 待开始
- ❌ 已阻塞
- ⏭️ 已跳过

---

## 🎯 第一阶段: 核心功能 (P0)

### 📦 基础设施搭建

#### 1. 数据库准备
- [ ] ⏳ 创建数据库 `mcp_bridge`
- [ ] ⏳ 执行 `schema.sql` 初始化表结构
- [ ] ⏳ 验证所有表和索引创建成功
- [ ] ⏳ 配置数据库连接池 (HikariCP)
- [ ] ⏳ 测试数据库连接

#### 2. MyBatis 配置
- [ ] ⏳ 添加 MyBatis 依赖到 `pom.xml`
- [ ] ⏳ 配置 `mybatis-config.xml`
- [ ] ⏳ 配置 `application.yml` 数据源
- [ ] ⏳ 创建 TypeHandler (JSON, LocalDateTime)
- [ ] ⏳ 测试 MyBatis 配置

#### 3. 核心框架组件
- [ ] ⏳ 创建 `PersistenceEventPublisher` 组件
- [ ] ⏳ 实现 `BatchWriter` 批量写入逻辑
- [ ] ⏳ 实现 `PersistenceFallbackHandler` 降级处理
- [ ] ⏳ 实现 `PartitionManager` 分区管理
- [ ] ⏳ 创建独立线程池 `persistenceExecutor`

---

### 1️⃣ 路由日志持久化 (3人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `RoutingLog.java`
- [ ] ⏳ 创建 Mapper 接口 `RoutingLogMapper.java`
- [ ] ⏳ 创建 XML Mapper `RoutingLogMapper.xml`
- [ ] ⏳ 实现单条插入 `insert(RoutingLog log)`
- [ ] ⏳ 实现批量插入 `batchInsert(List<RoutingLog> logs)`
- [ ] ⏳ 实现查询方法 `selectByRequestId`, `selectByTimeRange`

#### 业务集成
- [ ] ⏳ 在 `McpRouterService` 注入 `PersistenceEventPublisher`
- [ ] ⏳ 在 `routeRequest()` 方法开始时创建 `RoutingLog` 对象
- [ ] ⏳ 在 `doOnSuccess` 中填充响应信息并发布事件
- [ ] ⏳ 在 `doOnError` 中填充错误信息并发布事件
- [ ] ⏳ 在 `smartRoute()` 中添加相同逻辑

#### 批量写入
- [ ] ⏳ 配置 `routingLogSink` (Sinks.Many)
- [ ] ⏳ 实现批量写入器 (2秒或500条触发)
- [ ] ⏳ 实现降级逻辑 (数据库失败→磁盘队列)
- [ ] ⏳ 实现磁盘队列重试机制

#### 分区管理
- [ ] ⏳ 实现按天分区创建 SQL
- [ ] ⏳ 配置定时任务: 每天创建未来分区
- [ ] ⏳ 配置定时任务: 每周归档旧数据
- [ ] ⏳ 测试分区自动创建
- [ ] ⏳ 测试分区查询性能

#### 测试验证
- [ ] ⏳ 单元测试: `RoutingLogMapper`
- [ ] ⏳ 集成测试: 路由请求→持久化完整流程
- [ ] ⏳ 性能测试: 5000 TPS 路由 + 持久化
- [ ] ⏳ 故障测试: 数据库故障降级
- [ ] ⏳ 查询测试: 按时间范围查询性能

---

### 2️⃣ 健康检查记录持久化 (2人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `HealthCheckRecord.java`
- [ ] ⏳ 创建 Mapper 接口 `HealthCheckRecordMapper.java`
- [ ] ⏳ 创建 XML Mapper `HealthCheckRecordMapper.xml`
- [ ] ⏳ 实现批量插入 `batchInsert(List<HealthCheckRecord> records)`
- [ ] ⏳ 实现查询方法 `selectByServerKey`, `selectFailures`

#### 业务集成
- [ ] ⏳ 在 `HealthCheckService` 注入 `PersistenceEventPublisher`
- [ ] ⏳ 在 `performHealthCheck()` 创建 `HealthCheckRecord`
- [ ] ⏳ 实现采样策略 (失败必记录，成功10%采样)
- [ ] ⏳ 在健康检查完成后发布事件

#### 批量写入
- [ ] ⏳ 配置 `healthCheckSink` (Sinks.Many)
- [ ] ⏳ 实现批量写入器 (5秒或100条触发)
- [ ] ⏳ 实现降级逻辑

#### 分区管理
- [ ] ⏳ 实现按周分区创建 SQL
- [ ] ⏳ 配置分区自动创建和归档

#### 测试验证
- [ ] ⏳ 单元测试: `HealthCheckRecordMapper`
- [ ] ⏳ 集成测试: 健康检查→持久化
- [ ] ⏳ 测试采样逻辑
- [ ] ⏳ 测试分区查询

---

### 3️⃣ 服务器注册信息持久化 (2人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `McpServer.java`
- [ ] ⏳ 创建 Mapper 接口 `McpServerMapper.java`
- [ ] ⏳ 创建 XML Mapper `McpServerMapper.xml`
- [ ] ⏳ 实现插入或更新 `insertOrUpdate(McpServer server)`
- [ ] ⏳ 实现查询方法 `selectByServerKey`, `selectAllHealthy`
- [ ] ⏳ 实现删除方法 `deleteByServerKey`
- [ ] ⏳ 实现更新健康状态 `updateHealthStatus`

#### 业务集成
- [ ] ⏳ 在 `McpServerRegistry` 注入 `McpServerMapper`
- [ ] ⏳ 在 `registerServer()` 中同步写入数据库
- [ ] ⏳ 在 `deregisterServer()` 中更新数据库
- [ ] ⏳ 在 `updateServerHealth()` 中更新数据库
- [ ] ⏳ 实现启动时从数据库加载服务器列表

#### 测试验证
- [ ] ⏳ 单元测试: `McpServerMapper`
- [ ] ⏳ 集成测试: 服务注册→持久化→加载
- [ ] ⏳ 测试 insertOrUpdate 幂等性
- [ ] ⏳ 测试启动时数据恢复

---

### 4️⃣ 错误日志持久化 (1人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `ErrorLog.java`
- [ ] ⏳ 创建 Mapper 接口 `ErrorLogMapper.java`
- [ ] ⏳ 创建 XML Mapper `ErrorLogMapper.xml`
- [ ] ⏳ 实现插入方法 `insert(ErrorLog log)`
- [ ] ⏳ 实现查询方法 `selectByTimeRange`, `selectByErrorType`

#### 业务集成
- [ ] ⏳ 创建 `GlobalExceptionHandler`
- [ ] ⏳ 在异常处理中构造 `ErrorLog` 对象
- [ ] ⏳ 异步持久化错误日志
- [ ] ⏳ 在关键业务节点添加 try-catch 记录错误

#### 批量写入
- [ ] ⏳ 配置 `errorLogSink` (Sinks.Many)
- [ ] ⏳ 实现批量写入器 (3秒或50条触发)

#### 分区管理
- [ ] ⏳ 实现按周分区创建 SQL
- [ ] ⏳ 配置分区自动管理

#### 测试验证
- [ ] ⏳ 单元测试: `ErrorLogMapper`
- [ ] ⏳ 集成测试: 异常→持久化
- [ ] ⏳ 测试不同错误类型记录
- [ ] ⏳ 测试分区查询

---

### 🎯 第一阶段验收标准

#### 功能验收
- [ ] ⏳ 所有 P0 节点持久化功能正常工作
- [ ] ⏳ 批量写入成功率 > 99.9%
- [ ] ⏳ 降级策略验证通过
- [ ] ⏳ 分区自动创建和归档正常
- [ ] ⏳ 启动时数据恢复正常

#### 性能验收
- [ ] ⏳ 路由吞吐量保持 5000+ TPS
- [ ] ⏳ 路由延迟增加 < 1ms (P99)
- [ ] ⏳ 数据库写入延迟 < 2ms (P99)
- [ ] ⏳ 数据库连接数 < 50
- [ ] ⏳ CPU 增加 < 5%
- [ ] ⏳ 内存增加 < 100MB

#### 可靠性验收
- [ ] ⏳ 数据库故障时系统正常运行
- [ ] ⏳ 磁盘降级自动触发
- [ ] ⏳ 数据库恢复后自动补录数据
- [ ] ⏳ 查询性能稳定 < 50ms

---

## 🚀 第二阶段: 增强功能 (P1)

### 5️⃣ SSE会话管理持久化 (2人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `SseSessionRecord.java`
- [ ] ⏳ 创建 Mapper 接口 `SseSessionRecordMapper.java`
- [ ] ⏳ 创建 XML Mapper
- [ ] ⏳ 实现插入和更新方法

#### 业务集成
- [ ] ⏳ 在 `McpSseTransportProvider` 注入持久化组件
- [ ] ⏳ 在连接建立时创建会话记录
- [ ] ⏳ 定期更新活跃会话统计 (30秒)
- [ ] ⏳ 在连接断开时更新会话记录

#### 批量写入
- [ ] ⏳ 配置 `sseSessionSink`
- [ ] ⏳ 实现批量写入器

#### 测试验证
- [ ] ⏳ 单元测试
- [ ] ⏳ 集成测试
- [ ] ⏳ 会话统计准确性测试

---

### 6️⃣ 工具调用记录持久化 (2人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `ToolCallRecord.java`
- [ ] ⏳ 创建 Mapper 接口
- [ ] ⏳ 实现批量插入

#### 业务集成
- [ ] ⏳ 在 `McpClientManager.callTool()` 中记录
- [ ] ⏳ 关联到路由日志 (request_id)

#### 批量写入
- [ ] ⏳ 配置批量写入器 (2秒或500条)

#### 分区管理
- [ ] ⏳ 按天分区

#### 测试验证
- [ ] ⏳ 单元测试
- [ ] ⏳ 集成测试
- [ ] ⏳ 关联查询测试

---

### 7️⃣ 性能指标持久化 (3人日)

#### 数据模型
- [ ] ⏳ 创建实体类 `PerformanceMetrics.java`
- [ ] ⏳ 创建 Mapper 接口

#### 业务集成
- [ ] ⏳ 创建 `MetricsCollector` 组件
- [ ] ⏳ 实现内存指标聚合
- [ ] ⏳ 配置定时任务: 每分钟持久化

#### 指标收集
- [ ] ⏳ 路由指标: TPS, 延迟, 错误率
- [ ] ⏳ 资源指标: CPU, 内存, GC
- [ ] ⏳ 业务指标: 工具调用统计

#### 测试验证
- [ ] ⏳ 单元测试
- [ ] ⏳ 指标准确性测试
- [ ] ⏳ 性能影响测试

---

### 🎯 第二阶段验收标准

- [ ] ⏳ P1 功能全部正常工作
- [ ] ⏳ 会话统计准确
- [ ] ⏳ 工具调用记录完整
- [ ] ⏳ 性能指标可用于监控告警
- [ ] ⏳ 性能无明显下降

---

## 🎨 第三阶段: 优化完善 (P2)

### 8️⃣ 连接池统计持久化 (1人日)

- [ ] ⏳ 创建数据模型
- [ ] ⏳ 实现定期采样 (60秒)
- [ ] ⏳ 批量持久化
- [ ] ⏳ 测试验证

---

### 9️⃣ 负载均衡决策持久化 (2人日)

- [ ] ⏳ 创建数据模型
- [ ] ⏳ 实现采样策略 (1%)
- [ ] ⏳ 批量持久化
- [ ] ⏳ 测试验证

---

### 🔟 熔断器状态持久化 (1人日)

- [ ] ⏳ 创建数据模型
- [ ] ⏳ 状态变更时实时持久化
- [ ] ⏳ 测试验证

---

### 🎯 第三阶段验收标准

- [ ] ⏳ P2 功能全部正常工作
- [ ] ⏳ 提供完整的监控分析数据
- [ ] ⏳ 支持智能运维决策
- [ ] ⏳ 系统稳定性和性能达标

---

## 🔧 运维配置

### 监控告警
- [ ] ⏳ 配置批量写入失败告警
- [ ] ⏳ 配置磁盘队列积压告警
- [ ] ⏳ 配置数据库连接池告警
- [ ] ⏳ 配置分区创建失败告警
- [ ] ⏳ 配置查询性能告警

### 定时任务
- [ ] ⏳ 分区自动创建 (每天 02:00)
- [ ] ⏳ 分区自动归档 (每周日 03:00)
- [ ] ⏳ 磁盘队列重试 (每分钟)
- [ ] ⏳ 性能指标聚合 (每分钟)

### 数据管理
- [ ] ⏳ 配置数据保留策略
- [ ] ⏳ 配置自动归档脚本
- [ ] ⏳ 配置数据备份
- [ ] ⏳ 配置慢查询监控

---

## 📊 性能压测

### 压测场景
- [ ] ⏳ 场景1: 5000 TPS 路由请求
- [ ] ⏳ 场景2: 10000 TPS 路由请求
- [ ] ⏳ 场景3: 数据库故障降级
- [ ] ⏳ 场景4: 长时间运行稳定性 (24小时)
- [ ] ⏳ 场景5: 查询并发性能

### 压测指标
- [ ] ⏳ 路由吞吐量: ≥ 5000 TPS
- [ ] ⏳ 路由延迟 P50: < 20ms
- [ ] ⏳ 路由延迟 P99: < 100ms
- [ ] ⏳ 批量写入延迟 P99: < 2ms
- [ ] ⏳ 查询延迟 P99: < 50ms
- [ ] ⏳ 数据丢失率: < 0.001%
- [ ] ⏳ CPU 使用率: < 70%
- [ ] ⏳ 内存使用: < 2GB

---

## 📖 文档完善

### 技术文档
- [ ] ⏳ 持久化架构设计文档
- [ ] ⏳ 数据库Schema说明文档
- [ ] ⏳ API使用文档
- [ ] ⏳ 故障排查手册

### 运维文档
- [ ] ⏳ 部署指南
- [ ] ⏳ 监控配置指南
- [ ] ⏳ 数据管理指南
- [ ] ⏳ 性能调优指南

### 开发文档
- [ ] ⏳ 代码规范
- [ ] ⏳ 扩展指南
- [ ] ⏳ 测试指南

---

## ✅ 最终验收

### 功能完整性
- [ ] ⏳ 所有 P0 功能完成
- [ ] ⏳ 所有 P1 功能完成
- [ ] ⏳ 所有 P2 功能完成
- [ ] ⏳ 所有测试通过

### 性能达标
- [ ] ⏳ 所有性能指标达标
- [ ] ⏳ 压测通过
- [ ] ⏳ 长时间稳定性验证

### 可靠性验证
- [ ] ⏳ 故障演练通过
- [ ] ⏳ 降级策略验证
- [ ] ⏳ 数据恢复验证

### 运维就绪
- [ ] ⏳ 监控告警配置完成
- [ ] ⏳ 定时任务配置完成
- [ ] ⏳ 文档完善

### 生产部署
- [ ] ⏳ 灰度发布计划
- [ ] ⏳ 回滚方案
- [ ] ⏳ 应急预案
- [ ] ⏳ 正式上线

---

## 📝 备注

### 风险点
1. 数据库连接池可能成为瓶颈 → 独立线程池 + 降级
2. 批量写入可能积压 → 监控告警 + 自动扩容
3. 分区管理可能失败 → 定时任务监控 + 手动备份

### 注意事项
1. 所有持久化操作必须异步，不能阻塞主流程
2. 批量写入大小要根据实际压测调整
3. 分区策略要根据数据增长速度调整
4. 降级策略必须经过充分测试
5. 性能测试要在生产级环境进行

---

**文档版本**: v1.0  
**创建日期**: 2025-10-30  
**维护者**: MCP Router V3 Team  
**最后更新**: 2025-10-30


