<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pajk.mcpbridge.persistence.mapper.HealthCheckRecordMapper">

    <!-- Result Map -->
    <resultMap id="HealthCheckRecordResultMap" type="com.pajk.mcpbridge.persistence.entity.HealthCheckRecord">
        <id column="id" property="id"/>
        <result column="server_key" property="serverKey"/>
        <result column="check_time" property="checkTime"/>
        <result column="check_type" property="checkType"/>
        <result column="check_level" property="checkLevel"/>
        <result column="status" property="status"/>
        <result column="health_score" property="healthScore"/>
        <result column="response_time" property="responseTime"/>
        <result column="connection_time" property="connectionTime"/>
        <result column="check_duration" property="checkDuration"/>
        <result column="consecutive_successes" property="consecutiveSuccesses"/>
        <result column="consecutive_failures" property="consecutiveFailures"/>
        <result column="total_checks" property="totalChecks"/>
        <result column="error_message" property="errorMessage"/>
        <result column="error_code" property="errorCode"/>
        <result column="details" property="details"/>
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- 插入单条记录 -->
    <insert id="insert" parameterType="com.pajk.mcpbridge.persistence.entity.HealthCheckRecord"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO health_check_records (
            server_key, check_time, check_type, check_level, status, health_score,
            response_time, connection_time, check_duration,
            consecutive_successes, consecutive_failures, total_checks,
            error_message, error_code, details, created_at
        ) VALUES (
            #{serverKey}, #{checkTime}, #{checkType}, #{checkLevel}, #{status}, #{healthScore},
            #{responseTime}, #{connectionTime}, #{checkDuration},
            #{consecutiveSuccesses}, #{consecutiveFailures}, #{totalChecks},
            #{errorMessage}, #{errorCode}, #{details}, NOW()
        )
    </insert>

    <!-- 批量插入 -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO health_check_records (
            server_key, check_time, check_type, check_level, status, health_score,
            response_time, connection_time, check_duration,
            consecutive_successes, consecutive_failures, total_checks,
            error_message, error_code, details, created_at
        ) VALUES
        <foreach collection="records" item="record" separator=",">
            (
                #{record.serverKey}, #{record.checkTime}, #{record.checkType}, 
                #{record.checkLevel}, #{record.status}, #{record.healthScore},
                #{record.responseTime}, #{record.connectionTime}, #{record.checkDuration},
                #{record.consecutiveSuccesses}, #{record.consecutiveFailures}, #{record.totalChecks},
                #{record.errorMessage}, #{record.errorCode}, #{record.details}, NOW()
            )
        </foreach>
    </insert>

    <!-- 根据服务器标识查询 -->
    <select id="selectByServerKey" resultMap="HealthCheckRecordResultMap">
        SELECT * FROM health_check_records
        WHERE server_key = #{serverKey}
        ORDER BY check_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询失败的健康检查记录 -->
    <select id="selectFailures" resultMap="HealthCheckRecordResultMap">
        SELECT * FROM health_check_records
        WHERE status = 'UNHEALTHY'
        <if test="startTime != null">
            AND check_time BETWEEN #{startTime} AND #{endTime}
        </if>
        ORDER BY check_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据时间范围查询 -->
    <select id="selectByTimeRange" resultMap="HealthCheckRecordResultMap">
        SELECT * FROM health_check_records
        WHERE check_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY check_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 统计健康率 -->
    <select id="calculateHealthRate" resultType="java.lang.Double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0
                ELSE (SUM(CASE WHEN status = 'HEALTHY' THEN 1 ELSE 0 END) * 100.0 / COUNT(*))
            END AS health_rate
        FROM health_check_records
        WHERE server_key = #{serverKey}
        <if test="startTime != null">
            AND check_time BETWEEN #{startTime} AND #{endTime}
        </if>
    </select>

    <!-- 统计数量 -->
    <select id="countByTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*) FROM health_check_records
        WHERE check_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <!-- 删除指定时间之前的记录 -->
    <delete id="deleteByTimeBefore">
        DELETE FROM health_check_records
        WHERE check_time &lt; #{cutoffTime}
    </delete>

</mapper>



