<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pajk.mcpbridge.persistence.mapper.RoutingLogMapper">

    <!-- ============================================================================ -->
    <!-- Result Map - 完整字段映射 -->
    <!-- ============================================================================ -->
    <resultMap id="RoutingLogResultMap" type="com.pajk.mcpbridge.persistence.entity.RoutingLog">
        <!-- 主键和标识 -->
        <id column="id" property="id"/>
        <result column="request_id" property="requestId"/>
        <result column="trace_id" property="traceId"/>
        <result column="parent_id" property="parentId"/>
        
        <!-- 路由信息 -->
        <result column="server_key" property="serverKey"/>
        <result column="server_name" property="serverName"/>
        <result column="load_balance_strategy" property="loadBalanceStrategy"/>
        
        <!-- 请求信息 -->
        <result column="method" property="method"/>
        <result column="path" property="path"/>
        <result column="mcp_method" property="mcpMethod"/>
        <result column="tool_name" property="toolName"/>
        <result column="query_params" property="queryParams"/>
        <result column="request_headers" property="requestHeaders" 
                typeHandler="com.pajk.mcpbridge.persistence.typehandler.RequestHeadersTypeHandler"/>
        <result column="request_body" property="requestBody" 
                typeHandler="com.pajk.mcpbridge.persistence.typehandler.RequestBodyTypeHandler"/>
        <result column="request_size" property="requestSize"/>
        
        <!-- 响应信息 -->
        <result column="response_status" property="responseStatus"/>
        <result column="response_headers" property="responseHeaders" 
                typeHandler="com.pajk.mcpbridge.persistence.typehandler.ResponseHeadersTypeHandler"/>
        <result column="response_body" property="responseBody" 
                typeHandler="com.pajk.mcpbridge.persistence.typehandler.ResponseBodyTypeHandler"/>
        <result column="response_size" property="responseSize"/>
        
        <!-- 时间信息 -->
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="duration" property="duration"/>
        <result column="queue_time" property="queueTime"/>
        <result column="connect_time" property="connectTime"/>
        <result column="process_time" property="processTime"/>
        
        <!-- 客户端信息 -->
        <result column="client_id" property="clientId"/>
        <result column="client_ip" property="clientIp"/>
        <result column="real_ip" property="realIp"/>
        <result column="forwarded_for" property="forwardedFor"/>
        <result column="user_agent" property="userAgent"/>
        <result column="referer" property="referer"/>
        <result column="origin" property="origin"/>
        <result column="host" property="host"/>
        <result column="session_id" property="sessionId"/>
        
        <!-- 状态标识 -->
        <result column="is_success" property="isSuccess"/>
        <result column="is_cached" property="isCached"/>
        <result column="is_retry" property="isRetry"/>
        <result column="retry_count" property="retryCount"/>
        
        <!-- 错误信息 -->
        <result column="error_message" property="errorMessage"/>
        <result column="error_code" property="errorCode"/>
        <result column="error_type" property="errorType"/>
        
        <!-- 元数据 -->
        <result column="metadata" property="metadata"/>
        <result column="tags" property="tags"/>
        
        <!-- 时间戳 -->
        <result column="created_at" property="createdAt"/>
    </resultMap>

    <!-- ============================================================================ -->
    <!-- 插入单条记录 - 完整字段 -->
    <!-- ============================================================================ -->
    <insert id="insert" parameterType="com.pajk.mcpbridge.persistence.entity.RoutingLog"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO routing_logs (
            <!-- 请求标识 -->
            request_id, trace_id, parent_id,
            <!-- 路由信息 -->
            server_key, server_name, load_balance_strategy,
            <!-- 请求信息 -->
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            <!-- 响应信息 -->
            response_status, response_headers, response_body, response_size,
            <!-- 时间信息 -->
            start_time, end_time, duration, queue_time, connect_time, process_time,
            <!-- 客户端信息 -->
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            <!-- 状态标识 -->
            is_success, is_cached, is_retry, retry_count,
            <!-- 错误信息 -->
            error_message, error_code, error_type,
            <!-- 元数据 -->
            metadata, tags,
            <!-- 时间戳 -->
            created_at
        ) VALUES (
            <!-- 请求标识 -->
            #{requestId}, #{traceId}, #{parentId},
            <!-- 路由信息 -->
            #{serverKey}, #{serverName}, #{loadBalanceStrategy},
            <!-- 请求信息 -->
            #{method}, #{path}, #{mcpMethod}, #{toolName}, #{queryParams},
            #{requestHeaders, typeHandler=com.pajk.mcpbridge.persistence.typehandler.RequestHeadersTypeHandler}, 
            #{requestBody, typeHandler=com.pajk.mcpbridge.persistence.typehandler.RequestBodyTypeHandler}, 
            #{requestSize},
            <!-- 响应信息 -->
            #{responseStatus}, 
            #{responseHeaders, typeHandler=com.pajk.mcpbridge.persistence.typehandler.ResponseHeadersTypeHandler}, 
            #{responseBody, typeHandler=com.pajk.mcpbridge.persistence.typehandler.ResponseBodyTypeHandler}, 
            #{responseSize},
            <!-- 时间信息 -->
            #{startTime}, #{endTime}, #{duration}, #{queueTime}, #{connectTime}, #{processTime},
            <!-- 客户端信息 -->
            #{clientId}, #{clientIp}, #{realIp}, #{forwardedFor}, #{userAgent}, #{referer}, #{origin}, #{host}, #{sessionId},
            <!-- 状态标识 -->
            #{isSuccess}, #{isCached}, #{isRetry}, #{retryCount},
            <!-- 错误信息 -->
            #{errorMessage}, #{errorCode}, #{errorType},
            <!-- 元数据 -->
            #{metadata}, #{tags},
            <!-- 时间戳 -->
            NOW()
        )
    </insert>

    <!-- ============================================================================ -->
    <!-- 批量插入 - 完整字段 -->
    <!-- ============================================================================ -->
    <insert id="batchInsert" parameterType="java.util.List">
        INSERT INTO routing_logs (
            <!-- 请求标识 -->
            request_id, trace_id, parent_id,
            <!-- 路由信息 -->
            server_key, server_name, load_balance_strategy,
            <!-- 请求信息 -->
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            <!-- 响应信息 -->
            response_status, response_headers, response_body, response_size,
            <!-- 时间信息 -->
            start_time, end_time, duration, queue_time, connect_time, process_time,
            <!-- 客户端信息 -->
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            <!-- 状态标识 -->
            is_success, is_cached, is_retry, retry_count,
            <!-- 错误信息 -->
            error_message, error_code, error_type,
            <!-- 元数据 -->
            metadata, tags,
            <!-- 时间戳 -->
            created_at
        ) VALUES
        <foreach collection="logs" item="log" separator=",">
            (
                <!-- 请求标识 -->
                #{log.requestId}, #{log.traceId}, #{log.parentId},
                <!-- 路由信息 -->
                #{log.serverKey}, #{log.serverName}, #{log.loadBalanceStrategy},
                <!-- 请求信息 -->
                #{log.method}, #{log.path}, #{log.mcpMethod}, #{log.toolName}, #{log.queryParams},
                #{log.requestHeaders, typeHandler=com.pajk.mcpbridge.persistence.typehandler.RequestHeadersTypeHandler}, 
                #{log.requestBody, typeHandler=com.pajk.mcpbridge.persistence.typehandler.RequestBodyTypeHandler}, 
                #{log.requestSize},
                <!-- 响应信息 -->
                #{log.responseStatus}, 
                #{log.responseHeaders, typeHandler=com.pajk.mcpbridge.persistence.typehandler.ResponseHeadersTypeHandler}, 
                #{log.responseBody, typeHandler=com.pajk.mcpbridge.persistence.typehandler.ResponseBodyTypeHandler}, 
                #{log.responseSize},
                <!-- 时间信息 -->
                #{log.startTime}, #{log.endTime}, #{log.duration}, #{log.queueTime}, #{log.connectTime}, #{log.processTime},
                <!-- 客户端信息 -->
                #{log.clientId}, #{log.clientIp}, #{log.realIp}, #{log.forwardedFor}, #{log.userAgent}, #{log.referer}, #{log.origin}, #{log.host}, #{log.sessionId},
                <!-- 状态标识 -->
                #{log.isSuccess}, #{log.isCached}, #{log.isRetry}, #{log.retryCount},
                <!-- 错误信息 -->
                #{log.errorMessage}, #{log.errorCode}, #{log.errorType},
                <!-- 元数据 -->
                #{log.metadata}, #{log.tags},
                <!-- 时间戳 -->
                NOW()
            )
        </foreach>
    </insert>

    <!-- ============================================================================ -->
    <!-- 查询语句 -->
    <!-- ============================================================================ -->

    <!-- 根据请求ID查询 -->
    <select id="selectByRequestId" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE request_id = #{requestId}
        LIMIT 1
    </select>

    <!-- 根据 sessionId 查询路由日志 -->
    <select id="selectBySessionId" resultMap="RoutingLogResultMap" parameterType="map">
        SELECT
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags, created_at
        FROM routing_logs
        WHERE session_id = #{sessionId}
        ORDER BY start_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据时间范围查询 -->
    <select id="selectByTimeRange" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE start_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY start_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 根据目标服务器查询 -->
    <select id="selectByTargetServer" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE server_key = #{targetServer}
        <if test="startTime != null">
            AND start_time BETWEEN #{startTime} AND #{endTime}
        </if>
        ORDER BY start_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询失败的路由日志 -->
    <select id="selectFailures" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE is_success = FALSE
        <if test="startTime != null">
            AND start_time BETWEEN #{startTime} AND #{endTime}
        </if>
        ORDER BY start_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ============================================================================ -->
    <!-- 统计查询 -->
    <!-- ============================================================================ -->

    <!-- 统计成功率 -->
    <select id="calculateSuccessRate" resultType="java.lang.Double">
        SELECT 
            CASE 
                WHEN COUNT(*) = 0 THEN 0
                ELSE (SUM(CASE WHEN is_success = TRUE THEN 1 ELSE 0 END) * 100.0 / COUNT(*))
            END AS success_rate
        FROM routing_logs
        WHERE start_time BETWEEN #{startTime} AND #{endTime}
    </select>

    <!-- 统计数量 -->
    <select id="countByTimeRange" resultType="java.lang.Long">
        SELECT COUNT(*) 
        FROM routing_logs
        WHERE start_time BETWEEN #{startTime} AND #{endTime}
    </select>
    
    <!-- 统计平均响应时间 -->
    <select id="calculateAvgDuration" resultType="java.lang.Double">
        SELECT AVG(duration)
        FROM routing_logs
        WHERE start_time BETWEEN #{startTime} AND #{endTime}
          AND is_success = TRUE
    </select>
    
    <!-- 统计各工具调用次数 -->
    <select id="countByToolName" resultType="java.util.Map">
        SELECT 
            tool_name,
            COUNT(*) as call_count,
            AVG(duration) as avg_duration,
            SUM(CASE WHEN is_success = TRUE THEN 1 ELSE 0 END) as success_count
        FROM routing_logs
        WHERE start_time BETWEEN #{startTime} AND #{endTime}
          AND tool_name IS NOT NULL
        GROUP BY tool_name
        ORDER BY call_count DESC
    </select>
    
    <!-- ============================================================================ -->
    <!-- 删除和归档 -->
    <!-- ============================================================================ -->
    
    <!-- 删除指定时间之前的记录 -->
    <delete id="deleteByTimeBefore">
        DELETE FROM routing_logs
        WHERE start_time &lt; #{cutoffTime}
    </delete>
    
    <!-- 归档到历史表（插入到 routing_logs_archive） -->
    <insert id="archiveToHistory">
        INSERT INTO routing_logs_archive
        SELECT * FROM routing_logs
        WHERE start_time &lt; #{cutoffTime}
    </insert>
    
    <!-- 查询 RESTful 接口请求（旧版本，保留兼容性） -->
    <select id="selectRestfulRequests" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE path LIKE '/mcp/router%'
        <if test="serviceName != null and serviceName != ''">
            AND (server_name = #{serviceName} OR server_key = #{serviceName})
        </if>
        <if test="mcpMethod != null and mcpMethod != ''">
            AND mcp_method = #{mcpMethod}
        </if>
        <if test="hasSessionId != null">
            <choose>
                <when test="hasSessionId == true">
                    AND session_id IS NOT NULL AND session_id != ''
                </when>
                <otherwise>
                    AND (session_id IS NULL OR session_id = '')
                </otherwise>
            </choose>
        </if>
        <if test="startTime != null and endTime != null">
            AND start_time &lt;= #{endTime} AND start_time &gt;= #{startTime}
        </if>
        ORDER BY start_time DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- 查询 RESTful 接口请求（带分页：使用 pageNo 和 pageSize） -->
    <select id="selectRestfulRequestsWithPagination" resultMap="RoutingLogResultMap">
        SELECT 
            id, request_id, trace_id, parent_id,
            server_key, server_name, load_balance_strategy,
            method, path, mcp_method, tool_name, query_params,
            request_headers, request_body, request_size,
            response_status, response_headers, response_body, response_size,
            start_time, end_time, duration, queue_time, connect_time, process_time,
            client_id, client_ip, real_ip, forwarded_for, user_agent, referer, origin, host, session_id,
            is_success, is_cached, is_retry, retry_count,
            error_message, error_code, error_type,
            metadata, tags,
            created_at
        FROM routing_logs
        WHERE path LIKE '/mcp/router%'
        <if test="serviceName != null and serviceName != ''">
            AND (server_name = #{serviceName} OR server_key = #{serviceName})
        </if>
        <if test="mcpMethod != null and mcpMethod != ''">
            AND mcp_method = #{mcpMethod}
        </if>
        <if test="hasSessionId != null">
            <choose>
                <when test="hasSessionId == true">
                    AND session_id IS NOT NULL AND session_id != ''
                </when>
                <otherwise>
                    AND (session_id IS NULL OR session_id = '')
                </otherwise>
            </choose>
        </if>
        <if test="startTime != null and endTime != null">
            AND start_time &lt;= #{endTime} AND start_time &gt;= #{startTime}
        </if>
        ORDER BY start_time DESC
        <if test="offset != null and limit != null">
            LIMIT #{limit} OFFSET #{offset}
        </if>
    </select>

    <!-- 统计 RESTful 接口请求数量 -->
    <select id="countRestfulRequests" resultType="java.lang.Long">
        SELECT COUNT(0)
        FROM routing_logs
        WHERE path LIKE '/mcp/router%'
        <if test="serviceName != null and serviceName != ''">
            AND (server_name = #{serviceName} OR server_key = #{serviceName})
        </if>
        <if test="mcpMethod != null and mcpMethod != ''">
            AND mcp_method = #{mcpMethod}
        </if>
        <if test="hasSessionId != null">
            <choose>
                <when test="hasSessionId == true">
                    AND session_id IS NOT NULL AND session_id != ''
                </when>
                <otherwise>
                    AND (session_id IS NULL OR session_id = '')
                </otherwise>
            </choose>
        </if>
        <if test="startTime != null">
            AND start_time BETWEEN #{startTime} AND #{endTime}
        </if>
    </select>

</mapper>



