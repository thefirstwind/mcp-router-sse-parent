<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MCP Bridge - æ§åˆ¶é¢æ¿</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            box-sizing: border-box;
        }
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --border: #e5e7eb;
            --text: #0f172a;
            --text-muted: #6b7280;
            --shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.6;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }
        .header {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            color: var(--text);
        }
        .header .subtitle {
            color: var(--text-muted);
            font-size: 13px;
            margin-top: 4px;
        }
        .health-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg);
            font-size: 13px;
        }
        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .health-dot.up {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        .health-dot.down {
            background: var(--error);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.error { border-left-color: var(--error); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text);
            margin: 0;
        }
        .stat-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: var(--card-bg);
            padding: 4px;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        .tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            position: relative;
        }
        .tab:hover {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }
        .tab.active {
            color: var(--primary);
            background: rgba(37, 99, 235, 0.1);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .protocol-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .protocol-card {
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }
        .protocol-card.restful {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.12) 100%);
        }
        .protocol-card.sse {
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.15) 0%, rgba(245, 87, 108, 0.12) 100%);
        }
        .protocol-card.streamable {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.15) 0%, rgba(0, 242, 254, 0.12) 100%);
        }
        .protocol-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .protocol-card-content {
            background: rgba(255, 255, 255, 0.5);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        .protocol-features {
            font-size: 13px;
            color: var(--text);
            line-height: 1.8;
            margin: 0;
        }
        .protocol-features li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }
        .protocol-features li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: var(--success);
            font-weight: 600;
        }
        .protocol-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .protocol-header-left {
            flex: 1;
        }
        .protocol-header-right {
            text-align: right;
        }
        .protocol-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        .protocol-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin: 8px 0 0 0;
        }
        .protocol-stat-inline {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .protocol-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
            line-height: 1;
        }
        .protocol-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 16px;
            min-width: 0;
            overflow: hidden;
        }
        .card h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        @media(max-width: 1200px) {
            .two-column { grid-template-columns: 1fr; }
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        th {
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            background: var(--bg);
        }
        tr:hover {
            background: var(--bg);
        }
        tr.selected {
            background: rgba(37, 99, 235, 0.1);
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        .badge.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        .badge.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        .badge.info {
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            animation: pulse 2s infinite;
        }
        .status-dot.active {
            background: var(--success);
        }
        .status-dot.closed {
            background: var(--error);
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filter-bar input,
        .filter-bar select {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 13px;
            background: var(--card-bg);
            color: var(--text);
        }
        .filter-bar input:focus,
        .filter-bar select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--primary);
            color: white;
        }
        .btn:hover {
            background: var(--primary-hover);
        }
        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover {
            background: var(--border);
        }
        .json-viewer {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            line-height: 1.6;
            overflow-x: auto;
            overflow-y: auto;
            position: relative;
            max-height: 500px;
            min-height: 100px;
            word-break: break-word;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-sizing: border-box;
            width: 100%;
        }
        .json-viewer pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        .json-key { color: #7dd3fc; }
        .json-string { color: #86efac; }
        .json-number { color: #fbbf24; }
        .json-boolean { color: #a78bfa; }
        .json-null { color: #94a3b8; }
        .json-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .json-viewer-title {
            font-weight: 600;
            font-size: 13px;
            color: var(--text);
        }
        .copy-btn {
            padding: 4px 12px;
            font-size: 11px;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        .copy-btn:hover {
            background: rgba(37, 99, 235, 0.2);
        }
        .copy-btn.copied {
            background: var(--success);
            color: white;
            border-color: var(--success);
        }
        .mcp-method-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
        }
        .mcp-method-badge.tools { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .mcp-method-badge.resources { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .mcp-method-badge.prompts { background: rgba(139, 92, 246, 0.1); color: #8b5cf6; }
        .timeline {
            position: relative;
            padding-left: 24px;
        }
        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }
        .timeline-item {
            position: relative;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .timeline-item:hover {
            transform: translateX(4px);
        }
        .timeline-item:hover .timeline-content {
            background: rgba(37, 99, 235, 0.05);
            border: 1px solid rgba(37, 99, 235, 0.2);
        }
        .timeline-item.selected .timeline-content {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
        }
        .timeline-item.selected .timeline-dot {
            background: var(--primary);
            transform: scale(1.2);
        }
        .timeline-dot {
            position: absolute;
            left: -20px;
            top: 4px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            transition: all 0.2s;
        }
        .timeline-item:hover .timeline-dot {
            background: var(--primary);
            transform: scale(1.2);
        }
        .timeline-content {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .timeline-time {
            color: var(--text-muted);
            font-size: 11px;
            margin-bottom: 4px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: var(--error);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        .muted {
            color: var(--text-muted);
            font-size: 12px;
        }
        .scrollable {
            max-height: 600px;
            overflow-y: auto;
        }
        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }
        .method-item {
            padding: 16px;
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
            border-radius: 10px;
            border: 1px solid rgba(37, 99, 235, 0.1);
            transition: all 0.2s;
        }
        .method-item:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.08) 0%, rgba(37, 99, 235, 0.04) 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        .method-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .method-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.5;
        }
        .method-item.tools {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
            border-color: rgba(16, 185, 129, 0.1);
        }
        .method-item.tools:hover {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.04) 100%);
        }
        .method-item.resources {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(245, 158, 11, 0.02) 100%);
            border-color: rgba(245, 158, 11, 0.1);
        }
        .method-item.resources:hover {
            border-color: var(--warning);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.04) 100%);
        }
        .method-item.prompts {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(139, 92, 246, 0.02) 100%);
            border-color: rgba(139, 92, 246, 0.1);
        }
        .method-item.prompts:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(139, 92, 246, 0.04) 100%);
        }
        /* æœåŠ¡æ³¨å†Œä¸­å¿ƒæ ·å¼ - ç®€æ´ç°ä»£è®¾è®¡ */
        .service-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .service-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        .service-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .service-card-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            line-height: 1.4;
        }
        .service-card-badges {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }
        .service-card-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            line-height: 1;
        }
        .service-card-badge:first-of-type {
            background: #f0f9ff;
            color: #0369a1;
        }
        .service-card-badge:last-of-type {
            background: #f5f5f5;
            color: #525252;
        }
        .service-card-body {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .service-card-health {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text);
        }
        .service-card-footer {
            display: flex;
            gap: 16px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .service-card-stat {
            flex: 1;
        }
        .service-card-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            line-height: 1.2;
            margin-bottom: 2px;
        }
        .service-card-stat-value.healthy {
            color: var(--success);
        }
        .service-card-stat-value.unhealthy {
            color: var(--error);
        }
        .service-card-stat-label {
            font-size: 11px;
            color: var(--text-muted);
        }
        .health-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .health-indicator.healthy {
            background: var(--success);
            animation: pulse 2s infinite;
        }
        .health-indicator.unhealthy {
            background: var(--error);
        }
        .service-detail-section {
            margin-bottom: 20px;
        }
        .service-detail-section h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--text);
        }
        .service-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .service-detail-item:last-child {
            border-bottom: none;
        }
        .service-detail-label {
            color: var(--text-muted);
        }
        .service-detail-value {
            font-weight: 500;
            color: var(--text);
        }
        .instance-list {
            margin-top: 12px;
        }
        .instance-item {
            background: var(--bg);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }
        .instance-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .instance-item:last-child {
            margin-bottom: 0;
        }
        .instance-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .instance-address {
            font-family: monospace;
            font-size: 15px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }
        .instance-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 12px;
            color: var(--text-muted);
        }
        .instance-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .instance-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 500;
        }
        .instance-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .instance-detail-item {
            font-size: 12px;
        }
        .instance-detail-label {
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .instance-detail-value {
            color: var(--text);
            font-weight: 500;
            font-family: monospace;
        }
        .metadata-badge {
            display: inline-block;
            padding: 2px 8px;
            background: rgba(37, 99, 235, 0.1);
            color: var(--primary);
            border-radius: 4px;
            font-size: 11px;
            margin: 2px;
        }
        /* å¥åº·ç›‘æ§æ ·å¼ */
        .circuit-breaker-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .circuit-breaker-badge.closed {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        .circuit-breaker-badge.open {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        .circuit-breaker-badge.half-open {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        .health-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: var(--bg);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .health-history-item:last-child {
            margin-bottom: 0;
        }
        .health-history-time {
            color: var(--text-muted);
            font-size: 12px;
        }
        .health-history-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .close-btn:hover {
            background: var(--bg);
            color: var(--text);
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 13px;
            background: var(--card-bg);
            color: var(--text);
            box-sizing: border-box;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        .form-group textarea {
            min-height: 80px;
            font-family: monospace;
            font-size: 12px;
        }
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-danger {
            background: var(--error);
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        .version-selector {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 16px;
        }
        .version-selector select {
            flex: 1;
        }
        .tools-list {
            margin-top: 16px;
        }
        .tool-item {
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }
        .tool-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .tool-item-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .tool-item-params {
            font-size: 11px;
            color: var(--text-muted);
            font-family: monospace;
        }
        .config-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            border-bottom: 2px solid var(--border);
        }
        .config-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .config-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .config-tab-content {
            display: none;
        }
        .config-tab-content.active {
            display: block;
        }
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            color: var(--success);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-top">
            <div>
                <h1>MCP Bridge æ§åˆ¶é¢æ¿</h1>
                <div class="subtitle">Model Context Protocol æ ‡å‡†åè®®è·¯ç”±ä¸ç›‘æ§</div>
            </div>
            <div class="health-status" id="healthStatus">
                <span class="health-dot" id="healthDot"></span>
                <span id="healthText">æ£€æŸ¥ä¸­...</span>
            </div>
        </div>
    </div>

    <div id="errorBox" class="error-box" style="display:none;"></div>

    <div class="tabs">
        <button class="tab active" data-tab="overview">DEFAULT</button>
        <button class="tab" data-tab="registry">æœåŠ¡æ³¨å†Œä¸­å¿ƒ</button>
        <button class="tab" data-tab="redis">ä¼šè¯&Redis</button>
        <button class="tab" data-tab="sse">SSE è¿æ¥</button>
        <button class="tab" data-tab="streamable">Streamable è¿æ¥</button>
        <button class="tab" data-tab="restful">RESTful è¯·æ±‚</button>
    </div>

    <!-- DEFAULT -->
    <div class="tab-content active" id="overview-tab">
        <div class="protocol-cards">
            <div class="protocol-card restful">
                <div class="protocol-header">
                    <div class="protocol-header-left">
                        <div class="protocol-title">RESTful API</div>
                        <div class="protocol-desc">HTTP POST è¯·æ±‚ï¼Œæ ‡å‡† JSON-RPC 2.0 æ ¼å¼</div>
                    </div>
                    <div class="protocol-header-right">
                        <div class="protocol-stat-inline">
                            <div class="protocol-stat-value" id="restfulCount">-</div>
                            <div class="protocol-stat-label">24å°æ—¶è¯·æ±‚æ•°</div>
                        </div>
                    </div>
                </div>
                <div class="protocol-card-content">
                    <ul class="protocol-features">
                        <li>åŸºäº HTTP POST è¯·æ±‚ï¼Œç®€å•ç›´æ¥</li>
                        <li>æ”¯æŒæ ‡å‡† JSON-RPC 2.0 åè®®æ ¼å¼</li>
                        <li>é€‚ç”¨äºä¸€æ¬¡æ€§è¯·æ±‚-å“åº”åœºæ™¯</li>
                        <li>æ— éœ€å»ºç«‹é•¿è¿æ¥ï¼Œèµ„æºå ç”¨å°‘</li>
                    </ul>
                </div>
            </div>
            <div class="protocol-card sse">
                <div class="protocol-header">
                    <div class="protocol-header-left">
                        <div class="protocol-title">SSE è¿æ¥</div>
                        <div class="protocol-desc">Server-Sent Eventsï¼Œå®æ—¶åŒå‘é€šä¿¡</div>
                    </div>
                    <div class="protocol-header-right">
                        <div class="protocol-stat-inline">
                            <div class="protocol-stat-value" id="sseCount">-</div>
                            <div class="protocol-stat-label">æ´»è·ƒè¿æ¥</div>
                        </div>
                    </div>
                </div>
                <div class="protocol-card-content">
                    <ul class="protocol-features">
                        <li><strong>åè®®ç‰¹ç‚¹ï¼š</strong>åŸºäº Server-Sent Events (SSE) æ ‡å‡†åè®®ï¼ŒContent-Type: text/event-stream</li>
                        <li><strong>è¿æ¥æ–¹å¼ï¼š</strong>é€šè¿‡ GET /sse/{serviceName} å»ºç«‹é•¿è¿æ¥ï¼Œæ”¯æŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€</li>
                        <li><strong>å¿ƒè·³æœºåˆ¶ï¼š</strong>æ¯ 30 ç§’è‡ªåŠ¨å‘é€å¿ƒè·³äº‹ä»¶ï¼Œä¿æŒè¿æ¥æ´»è·ƒï¼Œè¶…æ—¶æ—¶é—´ 10 åˆ†é’Ÿ</li>
                        <li><strong>ä¼šè¯ç®¡ç†ï¼š</strong>è‡ªåŠ¨ç”Ÿæˆ sessionIdï¼Œå…³è” serviceNameï¼Œæ”¯æŒä¼šè¯çŠ¶æ€è¿½è¸ª</li>
                        <li><strong>æ¶ˆæ¯æ ¼å¼ï¼š</strong>æ ‡å‡† SSE æ ¼å¼ï¼Œevent: äº‹ä»¶ç±»å‹ï¼Œdata: JSON æ•°æ®</li>
                        <li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong>éœ€è¦å®æ—¶åŒå‘é€šä¿¡çš„åœºæ™¯ï¼Œå¦‚å·¥å…·è°ƒç”¨ã€èµ„æºç›‘å¬ç­‰</li>
                        <li><strong>å…¼å®¹æ€§ï¼š</strong>å®Œå…¨å…¼å®¹ Spring AI å’Œ MCP æ ‡å‡†æ ¼å¼</li>
                    </ul>
                </div>
            </div>
            <div class="protocol-card streamable">
                <div class="protocol-header">
                    <div class="protocol-header-left">
                        <div class="protocol-title">Streamable</div>
                        <div class="protocol-desc">NDJSON æµå¼ä¼ è¾“ï¼ŒMCP æ ‡å‡†åè®®</div>
                    </div>
                    <div class="protocol-header-right">
                        <div class="protocol-stat-inline">
                            <div class="protocol-stat-value" id="streamableCount">-</div>
                            <div class="protocol-stat-label">æ´»è·ƒè¿æ¥</div>
                        </div>
                    </div>
                </div>
                <div class="protocol-card-content">
                    <ul class="protocol-features">
                        <li><strong>åè®®ç‰¹ç‚¹ï¼š</strong>åŸºäº NDJSON (Newline Delimited JSON) æ ¼å¼ï¼ŒMCP å®˜æ–¹æ ‡å‡†åè®®</li>
                        <li><strong>è¿æ¥æ–¹å¼ï¼š</strong>é€šè¿‡ GET /mcp/{serviceName} å»ºç«‹æµå¼è¿æ¥ï¼ŒContent-Type: application/x-ndjson</li>
                        <li><strong>æ•°æ®æ ¼å¼ï¼š</strong>æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼Œæ”¯æŒæµå¼ä¼ è¾“ï¼Œé€‚åˆå¤§æ–‡ä»¶å¤„ç†</li>
                        <li><strong>ä¼šè¯ç®¡ç†ï¼š</strong>è‡ªåŠ¨ç”Ÿæˆ sessionIdï¼Œæ”¯æŒé€šè¿‡ Mcp-Session-Id è¯·æ±‚å¤´ä¼ é€’</li>
                        <li><strong>æ¶ˆæ¯ç«¯ç‚¹ï¼š</strong>è¿æ¥å»ºç«‹åè¿”å›æ¶ˆæ¯ç«¯ç‚¹ URLï¼Œé€šè¿‡ POST å‘é€æ¶ˆæ¯</li>
                        <li><strong>å…¼å®¹æ€§ï¼š</strong>å®Œå…¨å…¼å®¹ MCP Inspector ç­‰å®˜æ–¹å·¥å…·ï¼Œæ”¯æŒæ ‡å‡† MCP åè®®</li>
                        <li><strong>é€‚ç”¨åœºæ™¯ï¼š</strong>éœ€è¦æµå¼æ•°æ®ä¼ è¾“çš„åœºæ™¯ï¼Œå¦‚å¤§æ–‡ä»¶è¯»å–ã€æ‰¹é‡èµ„æºå¤„ç†ç­‰</li>
                        <li><strong>è¶…æ—¶è®¾ç½®ï¼š</strong>Redis TTL 30 åˆ†é’Ÿï¼Œæ”¯æŒä¼šè¯æŒä¹…åŒ–</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 24px;">
            <h3>æœåŠ¡æ³¨å†Œä¸­å¿ƒç‰¹ç‚¹</h3>
            <div style="padding: 16px;">
                <ul class="protocol-features" style="margin: 0;">
                    <li><strong>åŸºäº Nacosï¼š</strong>ä½¿ç”¨ Nacos ä½œä¸ºæœåŠ¡æ³¨å†Œä¸å‘ç°ä¸­å¿ƒï¼Œæ”¯æŒåŠ¨æ€æœåŠ¡æ³¨å†Œå’Œå‘ç°</li>
                    <li><strong>å¤šæœåŠ¡ç»„æ”¯æŒï¼š</strong>æ”¯æŒ mcp-serverã€mcp-endpointsã€DEFAULT_GROUP ç­‰å¤šä¸ªæœåŠ¡ç»„</li>
                    <li><strong>æœåŠ¡é…ç½®ç®¡ç†ï¼š</strong>é€šè¿‡ UUID æœºåˆ¶å…³è”æœåŠ¡åç§°å’Œé…ç½®ï¼Œæ”¯æŒç‰ˆæœ¬åŒ–é…ç½®ç®¡ç†</li>
                    <li><strong>é…ç½®ç±»å‹ï¼š</strong>æ”¯æŒ mcp-toolsã€mcp-versionsã€mcp-server ä¸‰ç§é…ç½®ç±»å‹</li>
                    <li><strong>åŠ¨æ€æ›´æ–°ï¼š</strong>æ”¯æŒé…ç½®çƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡å³å¯ç”Ÿæ•ˆ</li>
                    <li><strong>æœåŠ¡å‘ç°ï¼š</strong>è‡ªåŠ¨å‘ç°æ³¨å†Œçš„æœåŠ¡å®ä¾‹ï¼Œæ”¯æŒè´Ÿè½½å‡è¡¡å’Œå¥åº·æ£€æŸ¥</li>
                    <li><strong>å…ƒæ•°æ®ç®¡ç†ï¼š</strong>æ”¯æŒæœåŠ¡å…ƒæ•°æ®ç®¡ç†ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ã€ç«¯ç‚¹ç­‰ä¿¡æ¯</li>
                </ul>
            </div>
        </div>

        <div class="card" style="margin-top: 24px;">
            <h3>ä¼šè¯ç®¡ç†è®¾è®¡</h3>
            <div class="two-column" style="margin-top: 16px;">
                <div class="card" style="margin: 0;">
                    <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--primary);">å®¢æˆ·ç«¯åˆ° mcp-bridge çš„ä¼šè¯ç®¡ç†</h4>
                    <ul class="protocol-features" style="margin: 0;">
                        <li><strong>ä¼šè¯åˆ›å»ºï¼š</strong>å®¢æˆ·ç«¯é€šè¿‡ SSE æˆ– Streamable è¿æ¥æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„ sessionId</li>
                        <li><strong>ä¼šè¯å­˜å‚¨ï¼š</strong>ä¼šè¯ä¿¡æ¯å­˜å‚¨åœ¨ Redis ä¸­ï¼Œæ”¯æŒå¤šå®ä¾‹å…±äº«ï¼ŒTTL 30 åˆ†é’Ÿ</li>
                        <li><strong>ä¼šè¯å…³è”ï¼š</strong>sessionId ä¸ serviceName è‡ªåŠ¨å…³è”ï¼Œæ”¯æŒé€šè¿‡ sessionId æŸ¥æ‰¾å¯¹åº”çš„æœåŠ¡</li>
                        <li><strong>çŠ¶æ€ç®¡ç†ï¼š</strong>æ”¯æŒ CONNECTINGã€CONNECTEDã€DISCONNECTEDã€ERRORã€TIMEOUT ç­‰çŠ¶æ€</li>
                        <li><strong>å¿ƒè·³æœºåˆ¶ï¼š</strong>SSE è¿æ¥æ¯ 30 ç§’å‘é€å¿ƒè·³ï¼ŒStreamable è¿æ¥é€šè¿‡æ¶ˆæ¯ä¿æŒæ´»è·ƒ</li>
                        <li><strong>è¶…æ—¶å¤„ç†ï¼š</strong>SSE ä¼šè¯ 10 åˆ†é’Ÿæ— æ´»åŠ¨è‡ªåŠ¨è¶…æ—¶ï¼ŒStreamable ä¼šè¯ 30 åˆ†é’Ÿè¶…æ—¶</li>
                        <li><strong>å®¢æˆ·ç«¯ä¿¡æ¯ï¼š</strong>è®°å½•å®¢æˆ·ç«¯ IPã€User-Agentã€å®¢æˆ·ç«¯ ID ç­‰ä¿¡æ¯ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•</li>
                        <li><strong>ä¼šè¯æ¸…ç†ï¼š</strong>å®šæœŸæ¸…ç†è¶…æ—¶ä¼šè¯ï¼Œé‡Šæ”¾èµ„æºï¼Œæ”¯æŒæ‰‹åŠ¨æ¸…ç†</li>
                    </ul>
                </div>

                <div class="card" style="margin: 0;">
                    <h4 style="margin-top: 0; margin-bottom: 12px; color: var(--primary);">mcp-bridge åˆ°å„ä¸ª MCP Server çš„ä¼šè¯ç®¡ç†</h4>
                    <ul class="protocol-features" style="margin: 0;">
                        <li><strong>æ¡¥æ¥ä¼šè¯ï¼š</strong>mcp-bridge ä½œä¸ºå®¢æˆ·ç«¯è¿æ¥åˆ°åç«¯ MCP Serverï¼Œå»ºç«‹æ¡¥æ¥ä¼šè¯</li>
                        <li><strong>ä¼šè¯æ˜ å°„ï¼š</strong>ç»´æŠ¤å®¢æˆ·ç«¯ä¼šè¯ä¸æœåŠ¡å™¨ä¼šè¯çš„æ˜ å°„å…³ç³»ï¼Œæ”¯æŒä¸€å¯¹å¤šæ˜ å°„</li>
                        <li><strong>ä¼šè¯å¤ç”¨ï¼š</strong>åŒä¸€æœåŠ¡çš„å¤šä¸ªå®¢æˆ·ç«¯ä¼šè¯å¯ä»¥å…±äº«åŒä¸€ä¸ªæœåŠ¡å™¨ä¼šè¯ï¼Œæé«˜æ•ˆç‡</li>
                        <li><strong>ä¼šè¯è¶…æ—¶ï¼š</strong>æœåŠ¡å™¨ä¼šè¯è¶…æ—¶æ—¶é—´ 10 åˆ†é’Ÿï¼Œæ— æ´»åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†</li>
                        <li><strong>æ¶ˆæ¯è·¯ç”±ï¼š</strong>æ ¹æ®å®¢æˆ·ç«¯ sessionId æŸ¥æ‰¾å¯¹åº”çš„æœåŠ¡å™¨ä¼šè¯ï¼Œè·¯ç”±æ¶ˆæ¯åˆ°æ­£ç¡®çš„åç«¯æœåŠ¡</li>
                        <li><strong>äº‹ä»¶è½¬å‘ï¼š</strong>å°†åç«¯æœåŠ¡å™¨çš„ SSE äº‹ä»¶æµè½¬å‘åˆ°å®¢æˆ·ç«¯ï¼Œä¿æŒå®æ—¶é€šä¿¡</li>
                        <li><strong>é”™è¯¯å¤„ç†ï¼š</strong>æœåŠ¡å™¨ä¼šè¯å¼‚å¸¸æ—¶è‡ªåŠ¨é‡è¿ï¼Œæ”¯æŒæ•…éšœè½¬ç§»å’Œè´Ÿè½½å‡è¡¡</li>
                        <li><strong>èµ„æºç®¡ç†ï¼š</strong>å®šæœŸæ¸…ç†è¿‡æœŸçš„æœåŠ¡å™¨ä¼šè¯ï¼Œé˜²æ­¢èµ„æºæ³„æ¼</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="card" style="margin-top: 24px;">
            <h3>MCP æ ‡å‡†åè®®æ–¹æ³•</h3>
            <div class="method-grid">
                <div class="method-item tools">
                    <div class="method-item-name">
                        <span class="mcp-method-badge tools">tools/list</span>
                    </div>
                    <div class="method-item-desc">åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·ï¼Œè¿”å›å·¥å…·åˆ—è¡¨åŠå…¶æè¿°ä¿¡æ¯</div>
                </div>
                <div class="method-item tools">
                    <div class="method-item-name">
                        <span class="mcp-method-badge tools">tools/call</span>
                    </div>
                    <div class="method-item-desc">è°ƒç”¨æŒ‡å®šå·¥å…·ï¼Œæ‰§è¡Œå·¥å…·åŠŸèƒ½å¹¶è¿”å›ç»“æœ</div>
                </div>
                <div class="method-item resources">
                    <div class="method-item-name">
                        <span class="mcp-method-badge resources">resources/list</span>
                    </div>
                    <div class="method-item-desc">åˆ—å‡ºæ‰€æœ‰å¯ç”¨èµ„æºï¼Œè¿”å›èµ„æº URI å’Œå…ƒæ•°æ®</div>
                </div>
                <div class="method-item resources">
                    <div class="method-item-name">
                        <span class="mcp-method-badge resources">resources/read</span>
                    </div>
                    <div class="method-item-desc">è¯»å–æŒ‡å®šèµ„æºå†…å®¹ï¼Œæ”¯æŒæ–‡æœ¬ã€äºŒè¿›åˆ¶ç­‰å¤šç§æ ¼å¼</div>
                </div>
                <div class="method-item prompts">
                    <div class="method-item-name">
                        <span class="mcp-method-badge prompts">prompts/list</span>
                    </div>
                    <div class="method-item-desc">åˆ—å‡ºæ‰€æœ‰å¯ç”¨æç¤ºæ¨¡æ¿ï¼Œè¿”å›æç¤ºåˆ—è¡¨</div>
                </div>
                <div class="method-item prompts">
                    <div class="method-item-name">
                        <span class="mcp-method-badge prompts">prompts/get</span>
                    </div>
                    <div class="method-item-desc">è·å–æŒ‡å®šæç¤ºæ¨¡æ¿ï¼Œæ”¯æŒå‚æ•°åŒ–æç¤º</div>
                </div>
                <div class="method-item">
                    <div class="method-item-name">
                        <span class="mcp-method-badge">initialize</span>
                    </div>
                    <div class="method-item-desc">åˆå§‹åŒ– MCP ä¼šè¯ï¼Œäº¤æ¢å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„èƒ½åŠ›ä¿¡æ¯</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SSE è¿æ¥ -->
    <div class="tab-content" id="sse-tab">
        <div class="card">
            <h3>SSE ä¼šè¯åˆ—è¡¨</h3>
            <div class="filter-bar">
                <input id="sseServiceFilter" placeholder="æœåŠ¡åç§°" type="text">
                <input id="sseSessionSearch" placeholder="Session ID" type="text">
                <button class="btn" onclick="loadSseDashboard()">åˆ·æ–°</button>
            </div>
            <div class="scrollable">
                <table id="sseSessionsTable">
                    <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>æœåŠ¡åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>ä¼ è¾“åè®®</th>
                        <th>æœ€åæ´»è·ƒ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="5" class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>ä¼šè¯è¯¦æƒ…</h3>
            <div id="sseSessionDetail" class="muted">é€‰æ‹©å·¦ä¾§ä¼šè¯æŸ¥çœ‹è¯¦æƒ…</div>
        </div>

        <div class="two-column">
            <div class="card">
                <h3>è¯·æ±‚æ—¶é—´çº¿</h3>
                <div id="sseTimeline" class="timeline">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>é€‰æ‹©ä¼šè¯æŸ¥çœ‹è¯·æ±‚æ—¶é—´çº¿</div>
                    </div>
                </div>
            </div>

            <div class="card" id="sseRequestDetailCard">
                <h3>è¯·æ±‚è¯¦æƒ…</h3>
                <div id="sseRequestDetailInfo" class="muted">ç‚¹å‡»æ—¶é—´çº¿ä¸­çš„è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…</div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Request</div>
                        <button class="copy-btn" onclick="copyJson('sseRequestPayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="sseRequestPayload"></div>
                </div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Response</div>
                        <button class="copy-btn" onclick="copyJson('sseResponsePayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="sseResponsePayload"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Streamable è¿æ¥ -->
    <div class="tab-content" id="streamable-tab">
        <div class="card">
            <h3>Streamable ä¼šè¯åˆ—è¡¨</h3>
            <div class="filter-bar">
                <input id="streamableServiceFilter" placeholder="æœåŠ¡åç§°" type="text">
                <input id="streamableSessionSearch" placeholder="Session ID" type="text">
                <button class="btn" onclick="loadStreamableDashboard()">åˆ·æ–°</button>
            </div>
            <div class="scrollable">
                <table id="streamableTable">
                    <thead>
                    <tr>
                        <th>Session ID</th>
                        <th>æœåŠ¡åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>ä¼ è¾“åè®®</th>
                        <th>æœ€åæ´»è·ƒ</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="5" class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3>ä¼šè¯è¯¦æƒ…</h3>
            <div id="streamableSessionDetail" class="muted">é€‰æ‹©å·¦ä¾§ä¼šè¯æŸ¥çœ‹è¯¦æƒ…</div>
        </div>

        <div class="two-column">
            <div class="card">
                <h3>è¯·æ±‚æ—¶é—´çº¿</h3>
                <div id="streamableTimeline" class="timeline">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>é€‰æ‹©ä¼šè¯æŸ¥çœ‹è¯·æ±‚æ—¶é—´çº¿</div>
                    </div>
                </div>
            </div>

            <div class="card" id="streamableRequestDetailCard">
                <h3>è¯·æ±‚è¯¦æƒ…</h3>
                <div id="streamableRequestDetailInfo" class="muted">ç‚¹å‡»æ—¶é—´çº¿ä¸­çš„è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…</div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Request</div>
                        <button class="copy-btn" onclick="copyJson('streamableRequestPayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="streamableRequestPayload"></div>
                </div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Response</div>
                        <button class="copy-btn" onclick="copyJson('streamableResponsePayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="streamableResponsePayload"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESTful è¯·æ±‚ -->
    <div class="tab-content" id="restful-tab">
        <div class="two-column">
            <div class="card">
                <h3>RESTful è¯·æ±‚åˆ—è¡¨</h3>
                <div class="filter-bar">
                    <input id="restfulServiceFilter" placeholder="æœåŠ¡åç§°" type="text">
                    <select id="restfulMethodFilter">
                        <option value="">æ‰€æœ‰æ–¹æ³•</option>
                        <option value="tools/call">tools/call</option>
                        <option value="tools/list">tools/list</option>
                        <option value="resources/list">resources/list</option>
                        <option value="resources/read">resources/read</option>
                        <option value="prompts/list">prompts/list</option>
                        <option value="prompts/get">prompts/get</option>
                        <option value="initialize">initialize</option>
                    </select>
                    <select id="restfulHoursFilter">
                        <option value="1">æœ€è¿‘ 1 å°æ—¶</option>
                        <option value="6" selected>æœ€è¿‘ 6 å°æ—¶</option>
                        <option value="12">æœ€è¿‘ 12 å°æ—¶</option>
                        <option value="24">æœ€è¿‘ 24 å°æ—¶</option>
                        <option value="48">æœ€è¿‘ 48 å°æ—¶</option>
                        <option value="72">æœ€è¿‘ 72 å°æ—¶</option>
                        <option value="168">æœ€è¿‘ 7 å¤©</option>
                        <option value="336">æœ€è¿‘ 14 å¤©</option>
                        <option value="720">æœ€è¿‘ 30 å¤©</option>
                    </select>
                    <button class="btn" onclick="loadRestfulRequests(true)">åˆ·æ–°</button>
                    <button class="btn" onclick="testRestfulScrollLoad()" style="margin-left: 8px; font-size: 12px; padding: 6px 12px;" title="æµ‹è¯•æ»šåŠ¨åŠ è½½">æµ‹è¯•æ»šåŠ¨</button>
                </div>
                <div class="scrollable" id="restfulRequestsScrollContainer" style="max-height: 600px; overflow-y: auto;">
                    <table id="restfulRequestsTable">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>æœåŠ¡åç§°</th>
                            <th>æ–¹æ³•</th>
                            <th>å·¥å…·åç§°</th>
                            <th>å“åº”çŠ¶æ€</th>
                            <th>å¼€å§‹æ—¶é—´</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr><td colspan="6" class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h3>è¯·æ±‚è¯¦æƒ…</h3>
                <div id="restfulRequestInfo" class="muted">é€‰æ‹©å·¦ä¾§è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…</div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Request</div>
                        <button class="copy-btn" onclick="copyJson('restfulRequestPayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="restfulRequestPayload"></div>
                </div>
                <div style="margin-top: 16px;">
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">Response</div>
                        <button class="copy-btn" onclick="copyJson('restfulResponsePayload')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="restfulResponsePayload"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redis ç®¡ç† -->
    <div class="tab-content" id="redis-tab">
        <div class="card">
            <h3>ä¼šè¯ç®¡ç†ï¼ˆä¸‰çº§è”åŠ¨ï¼‰</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1.5fr; gap: 16px;">
                <!-- ç¬¬ä¸€çº§ï¼šInstance åˆ—è¡¨ -->
                <div>
                    <h4>Instance åˆ—è¡¨</h4>
                    <div class="filter-bar" style="margin-bottom: 8px;">
                        <button class="btn" onclick="loadRedisInstances()" style="width: 100%;">åˆ·æ–°</button>
                    </div>
                    <div class="scrollable" style="height: 500px; overflow-y: auto;">
                        <table id="redisInstancesTable">
                            <thead>
                            <tr>
                                <th>Instance ID</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç¬¬äºŒçº§ï¼šSessionId åˆ—è¡¨ -->
                <div>
                    <h4>SessionId åˆ—è¡¨</h4>
                    <div class="filter-bar" style="margin-bottom: 8px;">
                        <span id="selectedInstanceInfo" class="muted" style="font-size: 11px;">è¯·å…ˆé€‰æ‹© Instance</span>
                    </div>
                    <div class="scrollable" style="height: 500px; overflow-y: auto;">
                        <table id="redisSessionIdsTable">
                            <thead>
                            <tr>
                                <th>Session ID</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td class="muted">è¯·å…ˆé€‰æ‹© Instance</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ç¬¬ä¸‰çº§ï¼šSession è¯¦æƒ… -->
                <div>
                    <h4>Session è¯¦æƒ…</h4>
                    <div id="redisSessionDetail" class="muted" style="height: 500px; overflow-y: auto;">è¯·å…ˆé€‰æ‹© SessionId</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>ä¼šè¯æ•°æ®ï¼ˆåˆ—è¡¨è§†å›¾ï¼‰</h3>
            <div class="two-column" style="grid-template-columns: 1.5fr 1fr;">
                <div>
                    <div class="filter-bar">
                        <input id="redisServiceFilter" placeholder="æœåŠ¡åç§°" type="text">
                        <select id="redisTransportFilter">
                            <option value="">æ‰€æœ‰åè®®</option>
                            <option value="SSE">SSE</option>
                            <option value="STREAMABLE">Streamable</option>
                        </select>
                        <select id="redisActiveFilter">
                            <option value="">æ‰€æœ‰çŠ¶æ€</option>
                            <option value="true">æ´»è·ƒ</option>
                            <option value="false">éæ´»è·ƒ</option>
                        </select>
                        <select id="redisInstanceFilter">
                            <option value="">æ‰€æœ‰ Instance</option>
                        </select>
                        <button class="btn" onclick="loadRedisSessions()">åˆ·æ–°</button>
                    </div>
                    <div class="scrollable" style="height: 500px; overflow-y: auto;">
                        <table id="redisSessionsTable">
                            <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Instance ID</th>
                                <th>æœåŠ¡åç§°</th>
                                <th>åè®®</th>
                                <th>çŠ¶æ€</th>
                                <th>æœ€åæ´»è·ƒ</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td colspan="6" class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4>ä¼šè¯è¯¦æƒ…</h4>
                    <div id="redisSessionDetailList" class="muted" style="height: 500px; overflow-y: auto;">é€‰æ‹©å·¦ä¾§ä¼šè¯æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h3>Redis é”®æœç´¢</h3>
            <div class="two-column" style="grid-template-columns: 1.5fr 1fr;">
                <div>
                    <div class="filter-bar">
                        <input id="redisKeyName" placeholder="Redis é”®å (å¿…å¡«ï¼Œä¾‹å¦‚: mcp:sessions:xxx)" type="text" style="flex: 1;">
                        <input id="redisValuePattern" placeholder="å€¼æ¨¡å¼ (å¯é€‰ï¼Œä¾‹å¦‚: *session*)" type="text" style="flex: 1;">
                        <button class="btn" onclick="searchRedisKeys()">æœç´¢</button>
                    </div>
                    <div class="scrollable" style="height: 500px; overflow-y: auto;">
                        <table id="redisKeysTable">
                            <thead>
                            <tr>
                                <th>å€¼</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td class="muted">è¯·è¾“å…¥ Redis é”®åå¹¶ç‚¹å‡»æœç´¢</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div>
                    <h4>é”®è¯¦æƒ…</h4>
                    <div id="redisKeyDetail" class="muted" style="height: 500px; overflow-y: auto;">é€‰æ‹©å·¦ä¾§å€¼æŸ¥çœ‹è¯¦æƒ…</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡æ³¨å†Œä¸­å¿ƒ -->
    <div class="tab-content" id="registry-tab">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h3 style="margin: 0;">æœåŠ¡åˆ—è¡¨</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="loadNacosServices()">åˆ·æ–° Nacos æœåŠ¡</button>
                    <button class="btn" style="font-size: 12px; padding: 6px 12px;" onclick="loadNacosConfigs()">åˆ·æ–° Nacos é…ç½®</button>
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <h4 style="font-size: 14px; margin: 0 0 8px 0; color: var(--text-muted);">æœåŠ¡åˆ—è¡¨@Nacos</h4>
                <div id="nacosServicesList" class="service-cards-grid">
                    <div class="muted" style="padding: 20px; text-align: center;">ç‚¹å‡»"åˆ·æ–° Nacos æœåŠ¡"åŠ è½½</div>
                </div>
            </div>
            <div>
                <h4 style="font-size: 14px; margin: 0 0 8px 0; color: var(--text-muted);">Nacos MCP é…ç½®åˆ—è¡¨</h4>
                <div id="nacosConfigsList" style="background: var(--bg); border-radius: 8px; padding: 16px; max-height: 400px; overflow-y: auto;">
                    <div class="muted" style="text-align: center; padding: 20px;">ç‚¹å‡»ä¸Šæ–¹æœåŠ¡æŸ¥çœ‹é…ç½®</div>
                </div>
            </div>
        </div>

        <div class="two-column">
            <div class="card">
                <h3>æœåŠ¡è¯¦æƒ…</h3>
                <div id="serviceDetail" class="muted">é€‰æ‹©å·¦ä¾§æœåŠ¡æŸ¥çœ‹è¯¦æƒ…</div>
            </div>
            <div class="card">
                <h3>é…ç½®ä¿¡æ¯</h3>
                <div id="serviceConfig" class="muted">é€‰æ‹©æœåŠ¡æŸ¥çœ‹é…ç½®</div>
            </div>
        </div>
    </div>

    <!-- æœåŠ¡æ³¨å†Œæ¨¡æ€æ¡† -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>æ³¨å†Œ MCP æœåŠ¡</h3>
                <button class="close-btn" onclick="closeRegisterModal()">&times;</button>
            </div>
            <form id="registerForm" onsubmit="handleRegisterServer(event)">
                <div class="form-group">
                    <label>æœåŠ¡åç§° *</label>
                    <input type="text" id="registerName" required placeholder="ä¾‹å¦‚: mcp-server-v2">
                </div>
                <div class="form-group">
                    <label>ç‰ˆæœ¬ *</label>
                    <input type="text" id="registerVersion" required placeholder="ä¾‹å¦‚: 1.0.0">
                </div>
                <div class="form-group">
                    <label>IP åœ°å€ *</label>
                    <input type="text" id="registerIp" required placeholder="ä¾‹å¦‚: 127.0.0.1">
                </div>
                <div class="form-group">
                    <label>ç«¯å£ *</label>
                    <input type="number" id="registerPort" required placeholder="ä¾‹å¦‚: 8062">
                </div>
                <div class="form-group">
                    <label>æœåŠ¡ç»„</label>
                    <input type="text" id="registerServiceGroup" placeholder="ä¾‹å¦‚: mcp-server" value="mcp-server">
                </div>
                <div class="form-group">
                    <label>SSE ç«¯ç‚¹</label>
                    <input type="text" id="registerSseEndpoint" placeholder="ä¾‹å¦‚: /sse" value="/sse">
                </div>
                <div class="form-group">
                    <label>æƒé‡</label>
                    <input type="number" id="registerWeight" step="0.1" value="1.0" min="0" max="10">
                </div>
                <div class="form-group">
                    <label>æ˜¯å¦ä¸´æ—¶å®ä¾‹</label>
                    <select id="registerEphemeral">
                        <option value="true">æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å…ƒæ•°æ® (JSONï¼Œå¯é€‰)</label>
                    <textarea id="registerMetadata" placeholder='{"key": "value"}'></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRegisterModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn">æ³¨å†Œ</button>
                </div>
            </form>
        </div>
    </div>


</div>

<script>
    const adminBasePath = (() => {
        const match = window.location.pathname.match(/^(.*)\/admin/);
        return match ? match[1] : '';
    })();
    const apiBase = `${adminBasePath}/admin`;  // Admin dashboard API
    const baseApiPath = adminBasePath || '';  // Base API path for non-admin endpoints

    let sessionCache = [];
    let restfulRequestsCache = [];

    // ============================================================================
    // ç”¨æˆ·è¡Œä¸ºè®°å½•ç³»ç»Ÿ (localStorage)
    // ============================================================================
    const UserBehaviorStorage = {
        STORAGE_KEY: 'mcp-bridge-user-behavior',

        // è·å–æ‰€æœ‰ç”¨æˆ·è¡Œä¸ºè®°å½•
        getAll() {
            try {
                const data = localStorage.getItem(this.STORAGE_KEY);
                return data ? JSON.parse(data) : {};
            } catch (e) {
                console.warn('Failed to read user behavior from localStorage:', e);
                return {};
            }
        },

        // ä¿å­˜ç”¨æˆ·è¡Œä¸ºè®°å½•
        save(key, value) {
            try {
                const data = this.getAll();
                data[key] = {
                    value: value,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(this.STORAGE_KEY, JSON.stringify(data));
            } catch (e) {
                console.warn('Failed to save user behavior to localStorage:', e);
            }
        },

        // è·å–ç‰¹å®šè¡Œä¸ºè®°å½•
        get(key, defaultValue = null) {
            const data = this.getAll();
            return data[key]?.value ?? defaultValue;
        },

        // æ¸…é™¤æ‰€æœ‰è®°å½•
        clear() {
            try {
                localStorage.removeItem(this.STORAGE_KEY);
            } catch (e) {
                console.warn('Failed to clear user behavior from localStorage:', e);
            }
        },

        // è®°å½•æ ‡ç­¾é¡µé€‰æ‹©
        saveActiveTab(tab) {
            this.save('activeTab', tab);
        },

        // è®°å½•ç­›é€‰æ¡ä»¶
        saveFilter(filterName, value) {
            this.save(`filter_${filterName}`, value);
        },

        // è·å–ç­›é€‰æ¡ä»¶
        getFilter(filterName, defaultValue = '') {
            return this.get(`filter_${filterName}`, defaultValue);
        },

        // è®°å½•æ—¶é—´èŒƒå›´é€‰æ‹©
        saveTimeRange(range) {
            this.save('timeRange', range);
        },

        // è®°å½•æŸ¥çœ‹çš„ä¼šè¯ID
        saveViewedSession(sessionId) {
            this.save('viewedSession', sessionId);
        },

        // è®°å½•ç”¨æˆ·æ“ä½œå†å²
        logAction(action, details = {}) {
            try {
                const history = this.get('actionHistory', []);
                history.push({
                    action: action,
                    details: details,
                    timestamp: new Date().toISOString()
                });
                // åªä¿ç•™æœ€è¿‘100æ¡è®°å½•
                if (history.length > 100) {
                    history.shift();
                }
                this.save('actionHistory', history);
            } catch (e) {
                console.warn('Failed to log action:', e);
            }
        }
    };

    // åŠ è½½ç³»ç»Ÿå¥åº·çŠ¶æ€ï¼ˆä»…ç”¨äºheaderæ˜¾ç¤ºï¼‰
    async function loadHealthStatus() {
        try {
            const adminBasePath = (() => {
                const match = window.location.pathname.match(/^(.*)\/admin/);
                return match ? match[1] : '';
            })();
            const healthUrl = `${adminBasePath || ''}/actuator/health`;
            const resp = await fetch(healthUrl);
            const health = await resp.json();
            const status = health.status || 'UNKNOWN';
            const dot = document.getElementById('healthDot');
            const text = document.getElementById('healthText');

            if (status === 'UP') {
                dot.classList.add('up');
                dot.classList.remove('down');
                text.textContent = 'ç³»ç»Ÿæ­£å¸¸';
            } else {
                dot.classList.add('down');
                dot.classList.remove('up');
                text.textContent = 'ç³»ç»Ÿå¼‚å¸¸';
            }
        } catch (err) {
            const dot = document.getElementById('healthDot');
            const text = document.getElementById('healthText');
            dot.classList.add('down');
            dot.classList.remove('up');
            text.textContent = 'æ£€æŸ¥å¤±è´¥';
        }
    }

    // æ ¼å¼åŒ– JSON
    // æœ€å¤§å¤„ç†å¤§å°ï¼š500KBï¼ˆé˜²æ­¢å¡æ­»ï¼‰
    const MAX_JSON_SIZE = 500 * 1024; // 500KB

    function formatJson(json) {
        if (!json) return '';
        const jsonStr = typeof json === 'string' ? json : JSON.stringify(json);
        
        // æ£€æŸ¥å¤§å°ï¼Œè¶…è¿‡é™åˆ¶åˆ™æˆªæ–­
        if (jsonStr.length > MAX_JSON_SIZE) {
            return jsonStr.substring(0, MAX_JSON_SIZE) + '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]';
        }
        
        try {
            const obj = typeof json === 'string' ? JSON.parse(json) : json;
            const formatted = JSON.stringify(obj, null, 2);
            // å†æ¬¡æ£€æŸ¥æ ¼å¼åŒ–åçš„å¤§å°
            if (formatted.length > MAX_JSON_SIZE) {
                return formatted.substring(0, MAX_JSON_SIZE) + '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]';
            }
            return formatted;
        } catch (e) {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œç›´æ¥è¿”å›åŸæ–‡æœ¬ï¼ˆå·²æˆªæ–­ï¼‰
            return jsonStr.length > MAX_JSON_SIZE 
                ? jsonStr.substring(0, MAX_JSON_SIZE) + '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]'
                : jsonStr;
        }
    }

    // è¯­æ³•é«˜äº® JSONï¼ˆæ·»åŠ å¤§å°é™åˆ¶é˜²æ­¢å¡æ­»ï¼‰
    function highlightJson(json) {
        if (!json) return '<span class="json-null">(empty)</span>';
        
        const jsonStr = typeof json === 'string' ? json : JSON.stringify(json);
        
        // æ£€æŸ¥å¤§å°ï¼Œè¶…è¿‡é™åˆ¶åˆ™åªæ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¸è¿›è¡Œé«˜äº®å¤„ç†ï¼‰
        if (jsonStr.length > MAX_JSON_SIZE) {
            const truncated = jsonStr.substring(0, MAX_JSON_SIZE);
            const warning = '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]';
            return '<pre style="color: var(--error);">' + escapeHtml(truncated + warning) + '</pre>';
        }
        
        try {
            const obj = typeof json === 'string' ? JSON.parse(json) : json;
            const str = JSON.stringify(obj, null, 2);
            
            // å†æ¬¡æ£€æŸ¥æ ¼å¼åŒ–åçš„å¤§å°
            if (str.length > MAX_JSON_SIZE) {
                const truncated = str.substring(0, MAX_JSON_SIZE);
                const warning = '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]';
                return '<pre style="color: var(--error);">' + escapeHtml(truncated + warning) + '</pre>';
            }
            
            // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼å¤„ç†é«˜äº®ï¼ˆåˆ†æ‰¹å¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§å¤„ç†è¶…å¤§å­—ç¬¦ä¸²ï¼‰
            const escaped = escapeHtml(str);
            if (escaped.length > 100000) {
                // å¦‚æœè½¬ä¹‰åçš„å†…å®¹ä»ç„¶å¾ˆå¤§ï¼Œåªè¿›è¡Œç®€å•çš„è½¬ä¹‰ï¼Œä¸è¿›è¡Œå¤æ‚çš„é«˜äº®
                return '<pre>' + escaped + '</pre>';
            }
            
            return escaped
                .replace(/("(?:[^"\\]|\\.)*")\s*:/g, '<span class="json-key">$1</span>:')
                .replace(/:\s*("(?:[^"\\]|\\.)*")/g, ': <span class="json-string">$1</span>')
                .replace(/:\s*(-?\d+\.?\d*)/g, ': <span class="json-number">$1</span>')
                .replace(/:\s*(true|false)/g, ': <span class="json-boolean">$1</span>')
                .replace(/:\s*(null)/g, ': <span class="json-null">$1</span>');
        } catch (e) {
            // å¦‚æœä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œç›´æ¥è½¬ä¹‰æ˜¾ç¤ºï¼ˆå·²æˆªæ–­ï¼‰
            const displayStr = jsonStr.length > MAX_JSON_SIZE 
                ? jsonStr.substring(0, MAX_JSON_SIZE) + '\n\n...[å†…å®¹è¿‡å¤§ï¼Œå·²æˆªæ–­ï¼Œä»…æ˜¾ç¤ºå‰ ' + Math.floor(MAX_JSON_SIZE / 1024) + 'KB]'
                : jsonStr;
            return '<pre>' + escapeHtml(displayStr) + '</pre>';
        }
    }

    // HTML è½¬ä¹‰
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // å¤åˆ¶ JSON
    function copyJson(elementId) {
        const element = document.getElementById(elementId);
        if (element && navigator.clipboard) {
            navigator.clipboard.writeText(element.textContent || '').then(() => {
                const btn = event.target;
                btn.textContent = 'å·²å¤åˆ¶';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'å¤åˆ¶';
                    btn.classList.remove('copied');
                }, 1500);
            });
        }
    }

    // æ ¼å¼åŒ–æ—¶é—´
    function formatTime(value) {
        if (!value) return 'N/A';
        let date;
        if (Array.isArray(value)) {
            const [year, month = 1, day = 1, hour = 0, minute = 0, second = 0, nano = 0] = value;
            date = new Date(year, month - 1, day, hour, minute, second, Math.floor(nano / 1_000_000));
        } else {
            date = new Date(value);
        }
        if (Number.isNaN(date.getTime())) return value;
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // è®¡ç®—å‰©ä½™æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    function calculateRemainingTime(expireTime) {
        if (!expireTime) return null;
        let expireDate;
        if (Array.isArray(expireTime)) {
            const [year, month = 1, day = 1, hour = 0, minute = 0, second = 0, nano = 0] = expireTime;
            expireDate = new Date(year, month - 1, day, hour, minute, second, Math.floor(nano / 1_000_000));
        } else if (typeof expireTime === 'string') {
            expireDate = new Date(expireTime);
        } else {
            expireDate = expireTime;
        }
        if (Number.isNaN(expireDate.getTime())) return null;
        const now = new Date();
        const remaining = expireDate.getTime() - now.getTime();
        return remaining;
    }

    // æ ¼å¼åŒ–å‰©ä½™æ—¶é—´
    function formatRemainingTime(remainingMs) {
        if (remainingMs === null || remainingMs === undefined) return 'N/A';
        if (remainingMs < 0) return 'å·²è¿‡æœŸ';
        const seconds = Math.floor(remainingMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        if (hours > 0) {
            return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
        } else if (minutes > 0) {
            return `${minutes}åˆ†é’Ÿ${seconds % 60}ç§’`;
        } else {
            return `${seconds}ç§’`;
        }
    }

    // è·å– MCP æ–¹æ³•ç±»å‹
    function getMcpMethodType(method) {
        if (!method) return '';
        if (method.startsWith('tools/')) return 'tools';
        if (method.startsWith('resources/')) return 'resources';
        if (method.startsWith('prompts/')) return 'prompts';
        return '';
    }

    // API è°ƒç”¨
    async function fetchJson(url) {
        try {
            const resp = await fetch(url);
            const contentType = resp.headers.get('content-type') || '';

            // å…ˆè¯»å–å“åº”æ–‡æœ¬
            const text = await resp.text();

            // å¦‚æœå“åº”ä¸ºç©º
            if (!text || text.trim() === '') {
                if (!resp.ok) {
                    throw new Error(`è¯·æ±‚å¤±è´¥: ${resp.status} - å“åº”ä¸ºç©º`);
                }
                console.warn('Empty response from:', url);
                return null;
            }

            // æ£€æŸ¥çŠ¶æ€ç 
            if (!resp.ok) {
                // å°è¯•è§£æé”™è¯¯å“åº”ä¸º JSON
                try {
                    const errorJson = JSON.parse(text);
                    if (errorJson.error) {
                        throw new Error(errorJson.error.message || errorJson.error.code || `è¯·æ±‚å¤±è´¥: ${resp.status}`);
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯ JSONï¼Œç›´æ¥ä½¿ç”¨æ–‡æœ¬
                }
                throw new Error(`è¯·æ±‚å¤±è´¥: ${resp.status} - ${text.substring(0, 200)}`);
            }

            // å°è¯•è§£æ JSON
            try {
                return JSON.parse(text);
            } catch (parseError) {
                // å¦‚æœä¸æ˜¯ JSON æ ¼å¼
                console.warn('Response is not JSON from:', url, 'Content-Type:', contentType, 'Response:', text.substring(0, 200));

                // å¦‚æœæ˜¯ HTML é”™è¯¯é¡µé¢
                if (contentType.includes('text/html')) {
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº† HTML é¡µé¢è€Œä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯è·¯å¾„é”™è¯¯æˆ–æœåŠ¡å™¨é”™è¯¯`);
                }

                // å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼Œå°è¯•è¿”å›ä¸€ä¸ªå¯¹è±¡
                if (text.trim()) {
                    return { message: text, raw: true };
                }

                return null;
            }
        } catch (err) {
            console.error('APIè°ƒç”¨å¤±è´¥:', url, err);
            // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
            if (err.name === 'TypeError' && err.message.includes('fetch')) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
            }
            throw err;
        }
    }

    // é”™è¯¯å¤„ç†
    function showInfo(html) {
        const box = document.getElementById('infoBox');
        if (!box) {
            // å¦‚æœä¸å­˜åœ¨ infoBoxï¼Œåˆ›å»ºä¸€ä¸ªæ¨¡æ€æ¡†æ˜¾ç¤º
            // å…ˆç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ¨¡æ€æ¡†
            const oldModal = document.getElementById('infoModal');
            if (oldModal) {
                oldModal.remove();
            }

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'infoModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>è¯¦ç»†ä¿¡æ¯</h3>
                        <button class="close-btn" onclick="document.getElementById('infoModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">${html}</div>
                </div>
            `;
            document.body.appendChild(modal);
            // ç‚¹å‡»å¤–éƒ¨å…³é—­
            modal.onclick = function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            };
            return;
        }
        box.innerHTML = html;
        box.style.display = 'block';
        setTimeout(() => {
            box.style.display = 'none';
        }, 10000);
    }

    function showError(message) {
        const box = document.getElementById('errorBox');
        box.textContent = message;
        box.style.display = 'block';
        setTimeout(() => {
            box.style.display = 'none';
        }, 5000);
    }

    // åŠ è½½æ¦‚è§ˆæ•°æ®
    async function loadOverview() {
        try {
            const [summary, sseResponse, streamableResponse, restfulCount] = await Promise.all([
                fetchJson(`${apiBase}/api/summary`),
                // ä½¿ç”¨ Redis æ¥å£è·å– SSE æ´»è·ƒè¿æ¥ï¼ˆä¸ SSE ä¼šè¯åˆ—è¡¨é€»è¾‘ä¸€è‡´ï¼‰
                fetchJson(`${apiBase}/api/redis/sessions?transportType=SSE&active=true`),
                // ä½¿ç”¨ Redis æ¥å£è·å– Streamable æ´»è·ƒè¿æ¥ï¼ˆä¸ Streamable ä¼šè¯åˆ—è¡¨é€»è¾‘ä¸€è‡´ï¼‰
                fetchJson(`${apiBase}/api/redis/sessions?transportType=STREAMABLE&active=true`),
                // ä½¿ç”¨ COUNT æ¥å£è·å– RESTful è¯·æ±‚æ•°ï¼ˆä¸ RESTful è¯·æ±‚åˆ—è¡¨é€»è¾‘ä¸€è‡´ï¼Œæœ€è¿‘6å°æ—¶ï¼‰
                fetchJson(`${apiBase}/api/restful-requests/count?hours=6`)
            ]);

            // SSE æ´»è·ƒè¿æ¥æ•°ï¼šä½¿ç”¨ Redis æ¥å£ï¼Œåç«¯å·²è¿‡æ»¤ active=trueï¼Œå‰ç«¯åªéœ€è¿‡æ»¤æœ‰æ•ˆçš„ sessionId
            const sseActiveCount = (sseResponse?.sessions || []).filter(s => 
                s.sessionId != null && s.sessionId.trim() !== ''
            ).length;
            
            // Streamable æ´»è·ƒè¿æ¥æ•°ï¼šä½¿ç”¨ Redis æ¥å£ï¼Œåç«¯å·²è¿‡æ»¤ active=trueï¼Œå‰ç«¯åªéœ€è¿‡æ»¤æœ‰æ•ˆçš„ sessionId
            const streamableActiveCount = (streamableResponse?.sessions || []).filter(s => 
                s.sessionId != null && s.sessionId.trim() !== ''
            ).length;
            
            // RESTful è¯·æ±‚æ•°ï¼šä½¿ç”¨ COUNT(0) æ¥å£ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
            const restfulRequestCount = restfulCount || 0;

            document.getElementById('sseCount').textContent = sseActiveCount;
            document.getElementById('streamableCount').textContent = streamableActiveCount;
            // RESTful è¯·æ±‚æ•°ä½¿ç”¨ COUNT æ¥å£ç»Ÿè®¡ï¼ˆæœ€è¿‘6å°æ—¶ï¼Œä¸åˆ—è¡¨é¡µé¢ä¸€è‡´ï¼‰
            document.getElementById('restfulCount').textContent = restfulRequestCount;
        } catch (err) {
            console.error(err);
            showError('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥: ' + err.message);
        }
    }

    // åŠ è½½ SSE ä¼šè¯
    async function loadSseDashboard() {
        try {
            const serviceName = document.getElementById('sseServiceFilter')?.value.trim() || null;
            const sessionId = document.getElementById('sseSessionSearch')?.value.trim() || null;

            const params = new URLSearchParams();
            if (serviceName) params.append('serviceName', serviceName);
            if (sessionId) params.append('sessionId', sessionId);
            params.append('transportType', 'SSE');

            // ä½¿ç”¨ Redis æ¥å£è·å–æ•°æ®ï¼ˆä¸ä¸‰çº§è”åŠ¨ä¸€è‡´ï¼‰
            const response = await fetchJson(`${apiBase}/api/redis/sessions?${params}`);
            // è¿‡æ»¤æ‰ sessionId ä¸º null æˆ–ç©ºå­—ç¬¦ä¸²çš„è®°å½•
            sessionCache = (response?.sessions || []).filter(s => s.sessionId != null && s.sessionId.trim() !== '');

            const tbody = document.querySelector('#sseSessionsTable tbody');
            if (sessionCache.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— ä¼šè¯</td></tr>';
                return;
            }

            tbody.innerHTML = sessionCache.map(s => `
                <tr data-session-id="${s.sessionId}" style="cursor: pointer;">
                    <td><code style="font-size: 11px;">${s.sessionId}</code></td>
                    <td>${s.serviceName ?? 'æœªç»‘å®š'}</td>
                    <td>
                        <div class="connection-status">
                            <span class="status-dot ${s.active ? 'active' : 'closed'}"></span>
                            <span class="badge ${s.active ? 'success' : 'error'}">${s.active ? 'Active' : 'Closed'}</span>
                        </div>
                    </td>
                    <td><span class="badge info">${s.transportType || 'SSE'}</span></td>
                    <td>${formatTime(s.lastActive)}</td>
                </tr>
            `).join('');

            tbody.querySelectorAll('tr[data-session-id]').forEach(row => {
                row.addEventListener('click', () => {
                    const sessionId = row.dataset.sessionId;
                    document.querySelectorAll('#sseSessionsTable tbody tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    loadSseSessionDetail(sessionId);
                });
            });
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ SSE ä¼šè¯å¤±è´¥: ' + err.message);
        }
    }

    // åŠ è½½ SSE ä¼šè¯è¯¦æƒ…
    async function loadSseSessionDetail(sessionId) {
        // è®°å½•ç”¨æˆ·æŸ¥çœ‹çš„ä¼šè¯
        UserBehaviorStorage.saveViewedSession(sessionId);
        UserBehaviorStorage.logAction('view_session_detail', {
            sessionId: sessionId,
            type: 'SSE'
        });
        try {
            const session = sessionCache.find(s => s.sessionId === sessionId);
            if (!session) return;

            // æ˜¾ç¤ºä¼šè¯è¯¦æƒ…ï¼Œè§£é‡Š"æœªç»‘å®š"çš„å«ä¹‰
            const serviceNameDisplay = session.serviceName ?? 'æœªç»‘å®š';
            const serviceNameNote = session.serviceName
                ? ''
                : '<div class="muted" style="margin-top: 4px; font-size: 11px;">è¯´æ˜ï¼šSSEè¿æ¥å·²å»ºç«‹ï¼Œä½†å°šæœªç»‘å®šåˆ°å…·ä½“çš„åç«¯æœåŠ¡ã€‚é€šå¸¸åœ¨è¿æ¥å»ºç«‹æ—¶æœªæŒ‡å®šserviceNameï¼Œæˆ–ä½¿ç”¨æ™ºèƒ½è·¯ç”±æ—¶ä¼šæ˜¾ç¤ºæ­¤çŠ¶æ€ã€‚</div>';

            const remainingTime = calculateRemainingTime(session.expireTime);
            const remainingTimeStr = formatRemainingTime(remainingTime);
            const timeoutMinutes = session.timeoutMs ? Math.floor(session.timeoutMs / 60000) : null;

            document.getElementById('sseSessionDetail').innerHTML = `
                <div><strong>Session ID:</strong> <code>${session.sessionId}</code></div>
                <div><strong>æœåŠ¡åç§°:</strong> ${serviceNameDisplay}${serviceNameNote}</div>
                <div><strong>ä¼ è¾“åè®®:</strong> ${session.transportType || 'SSE'}</div>
                <div><strong>çŠ¶æ€:</strong> <span class="badge ${session.active ? 'success' : 'error'}">${session.active ? 'Active' : 'Closed'}</span></div>
                ${session.clientId ? `<div><strong>å®¢æˆ·ç«¯ID:</strong> ${session.clientId}</div>` : ''}
                ${session.clientIp ? `<div><strong>å®¢æˆ·ç«¯IP:</strong> ${session.clientIp}</div>` : ''}
                ${session.userAgent ? `<div><strong>User-Agent:</strong> <span style="font-size: 11px; word-break: break-all;">${session.userAgent}</span></div>` : ''}
                <div><strong>æœ€åæ´»è·ƒ:</strong> ${formatTime(session.lastActive)}</div>
                ${session.expireTime ? `<div><strong>è¿‡æœŸæ—¶é—´:</strong> ${formatTime(session.expireTime)}</div>` : ''}
                ${remainingTime !== null ? `<div><strong>å‰©ä½™æ—¶é—´:</strong> <span class="badge ${remainingTime > 60000 ? 'success' : remainingTime > 0 ? 'warning' : 'error'}">${remainingTimeStr}</span></div>` : ''}
                ${timeoutMinutes ? `<div><strong>è¶…æ—¶è®¾ç½®:</strong> ${timeoutMinutes}åˆ†é’Ÿ</div>` : ''}
            `;

            const logs = await fetchJson(`${apiBase}/api/sessions/${sessionId}/logs`);
            renderTimeline(logs, 'sseTimeline');
            // é‡ç½®è¯·æ±‚è¯¦æƒ…
            showTimelineRequestDetail(null);
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥: ' + err.message);
        }
    }

    // æ¸²æŸ“æ—¶é—´çº¿
    function renderTimeline(logs, containerId) {
        const container = document.getElementById(containerId);
        if (!logs || logs.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div>æš‚æ— è¯·æ±‚è®°å½•</div></div>';
            return;
        }

        container.innerHTML = logs.map((log, index) => `
            <div class="timeline-item" data-request-index="${index}" style="cursor: pointer;">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-time">${formatTime(log.startTime)}</div>
                    <div><span class="mcp-method-badge ${getMcpMethodType(log.mcpMethod)}">${log.mcpMethod || '-'}</span></div>
                    <div style="margin-top: 4px;">
                        <span class="badge ${log.responseStatus >= 200 && log.responseStatus < 300 ? 'success' : 'error'}">${log.responseStatus || '-'}</span>
                        ${log.duration ? `<span class="muted">${log.duration}ms</span>` : ''}
                    </div>
                </div>
            </div>
        `).join('');

        // ä¿å­˜ logs åˆ°å®¹å™¨ï¼Œä»¥ä¾¿ç‚¹å‡»æ—¶è®¿é—®
        container.dataset.logs = JSON.stringify(logs);

        // ä¸ºæ¯ä¸ªæ—¶é—´çº¿é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
        container.querySelectorAll('.timeline-item[data-request-index]').forEach(item => {
            item.addEventListener('click', () => {
                // ç§»é™¤å…¶ä»–é¡¹çš„é€‰ä¸­çŠ¶æ€
                container.querySelectorAll('.timeline-item').forEach(i => i.classList.remove('selected'));
                // æ·»åŠ å½“å‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                item.classList.add('selected');

                const index = parseInt(item.dataset.requestIndex);
                const logs = JSON.parse(container.dataset.logs);
                showTimelineRequestDetail(logs[index]);
            });
        });
    }

    // æ˜¾ç¤ºæ—¶é—´çº¿è¯·æ±‚è¯¦æƒ…
    function showTimelineRequestDetail(log) {
        if (!log) {
            document.getElementById('sseRequestDetailInfo').innerHTML = 'ç‚¹å‡»æ—¶é—´çº¿ä¸­çš„è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…';
            document.getElementById('sseRequestPayload').innerHTML = '';
            document.getElementById('sseResponsePayload').innerHTML = '';
            return;
        }

        document.getElementById('sseRequestDetailInfo').innerHTML = `
            <div><strong>Request ID:</strong> <code>${log.requestId || '-'}</code></div>
            <div><strong>æ–¹æ³•:</strong> <span class="mcp-method-badge ${getMcpMethodType(log.mcpMethod)}">${log.mcpMethod || '-'}</span></div>
            <div><strong>è·¯å¾„:</strong> ${log.path || '-'}</div>
            <div><strong>çŠ¶æ€:</strong> <span class="badge ${log.responseStatus >= 200 && log.responseStatus < 300 ? 'success' : 'error'}">${log.responseStatus || '-'}</span></div>
            <div><strong>æ—¶é—´:</strong> ${formatTime(log.startTime)}</div>
        `;

        const requestJson = formatJson(log.requestBody);
        const responseJson = formatJson(log.responseBody);
        document.getElementById('sseRequestPayload').innerHTML = highlightJson(requestJson) || '<span class="json-null">(empty)</span>';
        document.getElementById('sseResponsePayload').innerHTML = highlightJson(responseJson) || '<span class="json-null">(empty)</span>';
    }

    // RESTful è¯·æ±‚åŠ è½½çŠ¶æ€ï¼ˆä½¿ç”¨ pageNo å’Œ pageSizeï¼‰
    let restfulLoadingMore = false;
    let restfulCurrentPage = 1;
    let restfulPageSize = 10;
    let restfulTotalCount = 0;
    let restfulTotalPages = 0;

    // åŠ è½½ RESTful è¯·æ±‚ï¼ˆä½¿ç”¨æ ‡å‡†åˆ†é¡µï¼špageNo å’Œ pageSizeï¼‰
    async function loadRestfulRequests(reset = true) {
        try {
            if (reset) {
                restfulRequestsCache = [];
                restfulCurrentPage = 1;
                restfulTotalCount = 0;
                restfulTotalPages = 0;
            }

            if (restfulLoadingMore) {
                return;
            }

            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šé¡µ
            if (!reset && restfulCurrentPage >= restfulTotalPages) {
                console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] å·²åˆ°è¾¾æœ€åä¸€é¡µï¼Œä¸å†åŠ è½½`);
                return;
            }

            restfulLoadingMore = true;
            const serviceName = document.getElementById('restfulServiceFilter')?.value.trim() || null;
            const mcpMethod = document.getElementById('restfulMethodFilter')?.value || null;
            const hours = parseInt(document.getElementById('restfulHoursFilter')?.value || '24');

            // æ„å»ºè¯·æ±‚å‚æ•°ï¼ˆä½¿ç”¨ pageNo å’Œ pageSizeï¼‰
            const params = new URLSearchParams({ 
                hours: hours, 
                pageNo: reset ? 1 : restfulCurrentPage + 1, 
                pageSize: restfulPageSize 
            });
            if (serviceName) params.append('serviceName', serviceName);
            if (mcpMethod) params.append('mcpMethod', mcpMethod);

            const url = `${apiBase}/api/restful-requests?${params}`;
            console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] è¯·æ±‚URL:`, url);
            const response = await fetchJson(url);
            
            // æ–°çš„å“åº”æ ¼å¼ï¼š{ pageNo, pageSize, totalCount, totalPages, data: [...] }
            const pageNo = response.pageNo || 1;
            const pageSize = response.pageSize || 10;
            const totalCount = response.totalCount || 0;
            const totalPages = response.totalPages || 0;
            const newRequests = response.data || [];
            
            console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] æ”¶åˆ°å“åº”:`, {
                pageNo,
                pageSize,
                totalCount,
                totalPages,
                dataCount: newRequests.length,
                firstId: newRequests[0]?.id,
                lastId: newRequests[newRequests.length - 1]?.id
            });

            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            restfulCurrentPage = pageNo;
            restfulTotalCount = totalCount;
            restfulTotalPages = totalPages;

            if (newRequests.length === 0) {
                if (reset && restfulRequestsCache.length === 0) {
                    const tbody = document.querySelector('#restfulRequestsTable tbody');
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— è¯·æ±‚</td></tr>';
                }
                restfulLoadingMore = false;
                return;
            }

            // è¿½åŠ æ–°æ•°æ®
            if (reset) {
                restfulRequestsCache = newRequests;
            } else {
                // å»é‡ï¼šé¿å…é‡å¤æ•°æ®
                const existingRequestIds = new Set(restfulRequestsCache.map(r => r.requestId));
                const uniqueNewRequests = newRequests.filter(r => !existingRequestIds.has(r.requestId));
                restfulRequestsCache = [...restfulRequestsCache, ...uniqueNewRequests];
            }

            // è°ƒè¯•ä¿¡æ¯ï¼šéªŒè¯ç¿»é¡µåŠŸèƒ½
            console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] åŠ è½½${reset ? 'åˆå§‹' : 'æ›´å¤š'}æ•°æ®:`, {
                reset: reset,
                currentPage: restfulCurrentPage,
                totalPages: restfulTotalPages,
                totalCount: restfulTotalCount,
                newCount: newRequests.length,
                cacheCount: restfulRequestsCache.length,
                hasMore: restfulCurrentPage < restfulTotalPages
            });

            renderRestfulRequests();
            restfulLoadingMore = false;
            
            // æ•°æ®åŠ è½½å®Œæˆåï¼Œç¡®ä¿æ»šåŠ¨ç›‘å¬å™¨å·²ç»‘å®šï¼Œå¹¶æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨åŠ è½½
            setTimeout(() => {
                setupRestfulScrollListener();
                
                // å¦‚æœæ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ï¼Œä¸”è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œè‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µ
                const scrollContainer = document.getElementById('restfulRequestsScrollContainer');
                if (scrollContainer) {
                    const scrollHeight = scrollContainer.scrollHeight;
                    const clientHeight = scrollContainer.clientHeight;
                    const canScroll = scrollHeight > clientHeight;
                    const hasMore = restfulCurrentPage < restfulTotalPages;
                    
                    if (!canScroll && hasMore && !restfulLoadingMore && restfulRequestsCache.length > 0) {
                        console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] ğŸ”„ æ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ï¼Œè‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µ (å½“å‰: ${restfulCurrentPage}/${restfulTotalPages})`);
                        loadRestfulRequests(false);
                    }
                }
            }, 200);
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ RESTful è¯·æ±‚å¤±è´¥: ' + err.message);
            restfulLoadingMore = false;
        }
    }

    // æ¸²æŸ“ RESTful è¯·æ±‚åˆ—è¡¨
    function renderRestfulRequests() {
        const tbody = document.querySelector('#restfulRequestsTable tbody');
        
        if (restfulRequestsCache.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state">æš‚æ— è¯·æ±‚</td></tr>';
            return;
        }

        // ç§»é™¤åŠ è½½æç¤ºè¡Œï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const loadingRow = tbody.querySelector('tr.loading-more');
        if (loadingRow) {
            loadingRow.remove();
        }

        tbody.innerHTML = restfulRequestsCache.map(req => {
            return `
                <tr data-request-id="${req.requestId}" style="cursor: pointer;">
                    <td>${req.id ?? '-'}</td>
                    <td>${req.serverName ?? '-'}</td>
                    <td>
                        <span class="mcp-method-badge ${getMcpMethodType(req.mcpMethod)}">${req.mcpMethod ?? '-'}</span>
                    </td>
                    <td>${req.toolName ?? '-'}</td>
                    <td>
                        <span class="badge ${req.success ? 'success' : 'error'}">${req.responseStatus ?? '-'}</span>
                    </td>
                    <td>${formatTime(req.startTime)}</td>
                </tr>
            `;
        }).join('');

        // å¦‚æœè¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œæ·»åŠ åŠ è½½æç¤ºè¡Œ
        const hasMore = restfulCurrentPage < restfulTotalPages;
        if (hasMore) {
            tbody.insertAdjacentHTML('beforeend', 
                `<tr class="loading-more"><td colspan="6" class="loading-more-cell" style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 13px;">
                    æ»šåŠ¨åŠ è½½æ›´å¤š... (ç¬¬ ${restfulCurrentPage}/${restfulTotalPages} é¡µï¼Œå…± ${restfulTotalCount} æ¡)
                </td></tr>`
            );
        } else if (restfulRequestsCache.length > 0) {
            tbody.insertAdjacentHTML('beforeend', 
                `<tr><td colspan="6" class="empty-state" style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 13px;">
                    å·²åŠ è½½å…¨éƒ¨æ•°æ® (å…± ${restfulTotalCount} æ¡)
                </td></tr>`
            );
        }

        // ç»‘å®šç‚¹å‡»äº‹ä»¶
        tbody.querySelectorAll('tr[data-request-id]').forEach((row, index) => {
            row.addEventListener('click', () => {
                document.querySelectorAll('#restfulRequestsTable tbody tr').forEach(r => r.classList.remove('selected'));
                row.classList.add('selected');
                showRestfulRequestDetail(restfulRequestsCache[index]);
            });
        });
    }

    // æ˜¾ç¤º RESTful è¯·æ±‚è¯¦æƒ…
    async function showRestfulRequestDetail(request) {
        if (!request) return;
        // è®°å½•ç”¨æˆ·æŸ¥çœ‹çš„è¯·æ±‚
        UserBehaviorStorage.logAction('view_restful_request', {
            requestId: request.requestId,
            serviceName: request.serverName,
            mcpMethod: request.mcpMethod
        });

        document.getElementById('restfulRequestInfo').innerHTML = `
            <div><strong>Request ID:</strong> <code>${request.requestId}</code></div>
            <div><strong>æœåŠ¡:</strong> ${request.serverName ?? '-'}</div>
            <div><strong>æ–¹æ³•:</strong> <span class="mcp-method-badge ${getMcpMethodType(request.mcpMethod)}">${request.mcpMethod ?? '-'}</span></div>
            <div><strong>å·¥å…·:</strong> ${request.toolName ?? '-'}</div>
            <div><strong>çŠ¶æ€:</strong> <span class="badge ${request.success ? 'success' : 'error'}">${request.responseStatus ?? '-'}</span></div>
            ${request.clientId ? `<div><strong>å®¢æˆ·ç«¯ID:</strong> ${request.clientId}</div>` : ''}
            ${request.clientIp ? `<div><strong>å®¢æˆ·ç«¯IP:</strong> ${request.clientIp}</div>` : ''}
            ${request.userAgent ? `<div><strong>User-Agent:</strong> <span style="font-size: 11px; word-break: break-all;">${request.userAgent}</span></div>` : ''}
            <div><strong>å»¶è¿Ÿ:</strong> ${request.duration ?? '-'}ms</div>
            <div><strong>æ—¶é—´:</strong> ${formatTime(request.startTime)}</div>
        `;

        try {
            // è®¾ç½®åŠ è½½çŠ¶æ€
            document.getElementById('restfulRequestPayload').innerHTML = '<span class="muted">åŠ è½½ä¸­...</span>';
            document.getElementById('restfulResponsePayload').innerHTML = '<span class="muted">åŠ è½½ä¸­...</span>';
            
            // ä½¿ç”¨ Promise.race æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼ˆ10ç§’è¶…æ—¶ï¼‰
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('è¯·æ±‚è¶…æ—¶')), 10000)
            );
            
            const detail = await Promise.race([
                fetchJson(`${apiBase}/api/restful-requests/${request.requestId}`),
                timeoutPromise
            ]);
            
            if (detail) {
                // ä½¿ç”¨ setTimeout å°†å¤„ç†æ”¾åˆ°ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œé¿å…é˜»å¡ UI
                setTimeout(() => {
                    try {
                        const requestBody = detail.requestBody || '';
                        const responseBody = detail.responseBody || '';
                        
                        // æ£€æŸ¥åŸå§‹å¤§å°å¹¶æ˜¾ç¤ºè­¦å‘Š
                        const requestSize = requestBody.length;
                        const responseSize = responseBody.length;
                        
                        let requestJson = '';
                        let responseJson = '';
                        
                        if (requestBody) {
                            requestJson = formatJson(requestBody);
                            if (requestSize > MAX_JSON_SIZE) {
                                requestJson += '\n\nâš ï¸ åŸå§‹å¤§å°: ' + Math.floor(requestSize / 1024) + 'KBï¼Œå·²æˆªæ–­æ˜¾ç¤º';
                            }
                        }
                        
                        if (responseBody) {
                            responseJson = formatJson(responseBody);
                            if (responseSize > MAX_JSON_SIZE) {
                                responseJson += '\n\nâš ï¸ åŸå§‹å¤§å°: ' + Math.floor(responseSize / 1024) + 'KBï¼Œå·²æˆªæ–­æ˜¾ç¤º';
                            }
                        }
                        
                        document.getElementById('restfulRequestPayload').innerHTML = highlightJson(requestJson) || '<span class="json-null">(empty)</span>';
                        document.getElementById('restfulResponsePayload').innerHTML = highlightJson(responseJson) || '<span class="json-null">(empty)</span>';
                    } catch (processErr) {
                        console.error('å¤„ç†è¯·æ±‚è¯¦æƒ…æ—¶å‡ºé”™:', processErr);
                        document.getElementById('restfulRequestPayload').innerHTML = '<span class="error">å¤„ç†å¤±è´¥: å†…å®¹è¿‡å¤§æˆ–æ ¼å¼é”™è¯¯</span>';
                        document.getElementById('restfulResponsePayload').innerHTML = '<span class="error">å¤„ç†å¤±è´¥: å†…å®¹è¿‡å¤§æˆ–æ ¼å¼é”™è¯¯</span>';
                    }
                }, 0);
            } else {
                document.getElementById('restfulRequestPayload').innerHTML = '<span class="json-null">(empty)</span>';
                document.getElementById('restfulResponsePayload').innerHTML = '<span class="json-null">(empty)</span>';
            }
        } catch (err) {
            console.error(err);
            const errorMsg = err.message === 'è¯·æ±‚è¶…æ—¶' 
                ? 'åŠ è½½è¶…æ—¶ï¼ˆ10ç§’ï¼‰ï¼Œå†…å®¹å¯èƒ½è¿‡å¤§'
                : 'åŠ è½½å¤±è´¥: ' + err.message;
            document.getElementById('restfulRequestPayload').innerHTML = '<span class="error">' + errorMsg + '</span>';
            document.getElementById('restfulResponsePayload').innerHTML = '<span class="error">' + errorMsg + '</span>';
        }
    }

    let streamableSessionCache = [];

    // åŠ è½½ Streamable è¿æ¥
    async function loadStreamableDashboard() {
        try {
            const serviceName = document.getElementById('streamableServiceFilter')?.value.trim() || null;
            const sessionId = document.getElementById('streamableSessionSearch')?.value.trim() || null;

            const params = new URLSearchParams();
            if (serviceName) params.append('serviceName', serviceName);
            if (sessionId) params.append('sessionId', sessionId);
            params.append('transportType', 'STREAMABLE');

            // ä½¿ç”¨ Redis æ¥å£è·å–æ•°æ®ï¼ˆä¸ä¸‰çº§è”åŠ¨ä¸€è‡´ï¼‰
            const response = await fetchJson(`${apiBase}/api/redis/sessions?${params}`);
            // è¿‡æ»¤æ‰ sessionId ä¸º null æˆ–ç©ºå­—ç¬¦ä¸²çš„è®°å½•
            streamableSessionCache = (response?.sessions || []).filter(s => s.sessionId != null && s.sessionId.trim() !== '');

            const tbody = document.querySelector('#streamableTable tbody');
            if (streamableSessionCache.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— è¿æ¥</td></tr>';
                return;
            }

            tbody.innerHTML = streamableSessionCache.map(s => `
                <tr data-session-id="${s.sessionId}" style="cursor: pointer;">
                    <td><code style="font-size: 11px;">${s.sessionId}</code></td>
                    <td>${s.serviceName ?? 'æœªç»‘å®š'}</td>
                    <td>
                        <div class="connection-status">
                            <span class="status-dot ${s.active ? 'active' : 'closed'}"></span>
                            <span class="badge ${s.active ? 'success' : 'error'}">${s.active ? 'Active' : 'Closed'}</span>
                        </div>
                    </td>
                    <td><span class="badge info">${s.transportType || 'STREAMABLE'}</span></td>
                    <td>${formatTime(s.lastActive)}</td>
                </tr>
            `).join('');

            tbody.querySelectorAll('tr[data-session-id]').forEach(row => {
                row.addEventListener('click', () => {
                    const sessionId = row.dataset.sessionId;
                    document.querySelectorAll('#streamableTable tbody tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    loadStreamableSessionDetail(sessionId);
                });
            });
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ Streamable è¿æ¥å¤±è´¥: ' + err.message);
        }
    }

    // åŠ è½½ Streamable ä¼šè¯è¯¦æƒ…
    async function loadStreamableSessionDetail(sessionId) {
        // è®°å½•ç”¨æˆ·æŸ¥çœ‹çš„ä¼šè¯
        UserBehaviorStorage.saveViewedSession(sessionId);
        UserBehaviorStorage.logAction('view_session_detail', {
            sessionId: sessionId,
            type: 'Streamable'
        });
        try {
            const session = streamableSessionCache.find(s => s.sessionId === sessionId);
            if (!session) return;

            // æ˜¾ç¤ºä¼šè¯è¯¦æƒ…ï¼Œè§£é‡Š"æœªç»‘å®š"çš„å«ä¹‰
            const serviceNameDisplay = session.serviceName ?? 'æœªç»‘å®š';
            const serviceNameNote = session.serviceName
                ? ''
                : '<div class="muted" style="margin-top: 4px; font-size: 11px;">è¯´æ˜ï¼šStreamableè¿æ¥å·²å»ºç«‹ï¼Œä½†å°šæœªç»‘å®šåˆ°å…·ä½“çš„åç«¯æœåŠ¡ã€‚é€šå¸¸åœ¨è¿æ¥å»ºç«‹æ—¶æœªæŒ‡å®šserviceNameï¼Œæˆ–ä½¿ç”¨æ™ºèƒ½è·¯ç”±æ—¶ä¼šæ˜¾ç¤ºæ­¤çŠ¶æ€ã€‚</div>';

            const remainingTime = calculateRemainingTime(session.expireTime);
            const remainingTimeStr = formatRemainingTime(remainingTime);
            const timeoutMinutes = session.timeoutMs ? Math.floor(session.timeoutMs / 60000) : null;

            document.getElementById('streamableSessionDetail').innerHTML = `
                <div><strong>Session ID:</strong> <code>${session.sessionId}</code></div>
                <div><strong>æœåŠ¡åç§°:</strong> ${serviceNameDisplay}${serviceNameNote}</div>
                <div><strong>ä¼ è¾“åè®®:</strong> ${session.transportType || 'STREAMABLE'}</div>
                <div><strong>çŠ¶æ€:</strong> <span class="badge ${session.active ? 'success' : 'error'}">${session.active ? 'Active' : 'Closed'}</span></div>
                ${session.clientId ? `<div><strong>å®¢æˆ·ç«¯ID:</strong> ${session.clientId}</div>` : ''}
                ${session.clientIp ? `<div><strong>å®¢æˆ·ç«¯IP:</strong> ${session.clientIp}</div>` : ''}
                ${session.userAgent ? `<div><strong>User-Agent:</strong> <span style="font-size: 11px; word-break: break-all;">${session.userAgent}</span></div>` : ''}
                <div><strong>æœ€åæ´»è·ƒ:</strong> ${formatTime(session.lastActive)}</div>
                ${session.expireTime ? `<div><strong>è¿‡æœŸæ—¶é—´:</strong> ${formatTime(session.expireTime)}</div>` : ''}
                ${remainingTime !== null ? `<div><strong>å‰©ä½™æ—¶é—´:</strong> <span class="badge ${remainingTime > 60000 ? 'success' : remainingTime > 0 ? 'warning' : 'error'}">${remainingTimeStr}</span></div>` : ''}
                ${timeoutMinutes ? `<div><strong>è¶…æ—¶è®¾ç½®:</strong> ${timeoutMinutes}åˆ†é’Ÿ</div>` : ''}
            `;

            const logs = await fetchJson(`${apiBase}/api/sessions/${sessionId}/logs`);
            renderStreamableTimeline(logs, 'streamableTimeline');
            // é‡ç½®è¯·æ±‚è¯¦æƒ…
            showStreamableRequestDetail(null);
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥: ' + err.message);
        }
    }

    // æ¸²æŸ“ Streamable æ—¶é—´çº¿
    function renderStreamableTimeline(logs, containerId) {
        const container = document.getElementById(containerId);
        if (!logs || logs.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“‹</div><div>æš‚æ— è¯·æ±‚è®°å½•</div></div>';
            return;
        }

        container.innerHTML = logs.map((log, index) => `
            <div class="timeline-item" data-request-index="${index}" style="cursor: pointer;">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="timeline-time">${formatTime(log.startTime)}</div>
                    <div><span class="mcp-method-badge ${getMcpMethodType(log.mcpMethod)}">${log.mcpMethod || '-'}</span></div>
                    <div style="margin-top: 4px;">
                        <span class="badge ${log.responseStatus >= 200 && log.responseStatus < 300 ? 'success' : 'error'}">${log.responseStatus || '-'}</span>
                        ${log.duration ? `<span class="muted">${log.duration}ms</span>` : ''}
                    </div>
                </div>
            </div>
        `).join('');

        // ä¿å­˜ logs åˆ°å®¹å™¨ï¼Œä»¥ä¾¿ç‚¹å‡»æ—¶è®¿é—®
        container.dataset.logs = JSON.stringify(logs);

        // ä¸ºæ¯ä¸ªæ—¶é—´çº¿é¡¹æ·»åŠ ç‚¹å‡»äº‹ä»¶
        container.querySelectorAll('.timeline-item[data-request-index]').forEach(item => {
            item.addEventListener('click', () => {
                // ç§»é™¤å…¶ä»–é¡¹çš„é€‰ä¸­çŠ¶æ€
                container.querySelectorAll('.timeline-item').forEach(i => i.classList.remove('selected'));
                // æ·»åŠ å½“å‰é¡¹çš„é€‰ä¸­çŠ¶æ€
                item.classList.add('selected');

                const index = parseInt(item.dataset.requestIndex);
                const logs = JSON.parse(container.dataset.logs);
                showStreamableRequestDetail(logs[index]);
            });
        });
    }

    // æ˜¾ç¤º Streamable æ—¶é—´çº¿è¯·æ±‚è¯¦æƒ…
    function showStreamableRequestDetail(log) {
        if (!log) {
            document.getElementById('streamableRequestDetailInfo').innerHTML = 'ç‚¹å‡»æ—¶é—´çº¿ä¸­çš„è¯·æ±‚æŸ¥çœ‹è¯¦æƒ…';
            document.getElementById('streamableRequestPayload').innerHTML = '';
            document.getElementById('streamableResponsePayload').innerHTML = '';
            return;
        }

        document.getElementById('streamableRequestDetailInfo').innerHTML = `
            <div><strong>Request ID:</strong> <code>${log.requestId || '-'}</code></div>
            <div><strong>æ–¹æ³•:</strong> <span class="mcp-method-badge ${getMcpMethodType(log.mcpMethod)}">${log.mcpMethod || '-'}</span></div>
            <div><strong>è·¯å¾„:</strong> ${log.path || '-'}</div>
            <div><strong>çŠ¶æ€:</strong> <span class="badge ${log.responseStatus >= 200 && log.responseStatus < 300 ? 'success' : 'error'}">${log.responseStatus || '-'}</span></div>
            <div><strong>æ—¶é—´:</strong> ${formatTime(log.startTime)}</div>
        `;

        const requestJson = formatJson(log.requestBody);
        const responseJson = formatJson(log.responseBody);
        document.getElementById('streamableRequestPayload').innerHTML = highlightJson(requestJson) || '<span class="json-null">(empty)</span>';
        document.getElementById('streamableResponsePayload').innerHTML = highlightJson(responseJson) || '<span class="json-null">(empty)</span>';
    }

    // åŠ è½½æ‰€æœ‰ä¼šè¯
    async function loadAllSessions() {
        try {
            const search = document.getElementById('sessionSearch')?.value.trim() || null;
            const transportType = document.getElementById('transportFilter')?.value || null;

            const params = new URLSearchParams();
            if (search) {
                if (search.includes('-')) {
                    params.append('sessionId', search);
                } else {
                    params.append('serviceName', search);
                }
            }
            if (transportType) params.append('transportType', transportType);

            const sessions = await fetchJson(`${apiBase}/api/sessions?${params}`);
            // è¿‡æ»¤æ‰ sessionId ä¸º null æˆ–ç©ºå­—ç¬¦ä¸²çš„è®°å½•
            const validSessions = (sessions || []).filter(s => s.sessionId != null && s.sessionId.trim() !== '');
            const tbody = document.querySelector('#allSessionsTable tbody');
            if (validSessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">æš‚æ— ä¼šè¯</td></tr>';
                return;
            }

            tbody.innerHTML = validSessions.map(s => `
                <tr data-session-id="${s.sessionId}" style="cursor: pointer;">
                    <td><code style="font-size: 11px;">${s.sessionId}</code></td>
                    <td>${s.serviceName ?? 'æœªç»‘å®š'}</td>
                    <td><span class="badge info">${s.transportType || 'SSE'}</span></td>
                    <td>
                        <div class="connection-status">
                            <span class="status-dot ${s.active ? 'active' : 'closed'}"></span>
                            <span class="badge ${s.active ? 'success' : 'error'}">${s.active ? 'Active' : 'Closed'}</span>
                        </div>
                    </td>
                    <td>${formatTime(s.lastActive)}</td>
                </tr>
            `).join('');

            tbody.querySelectorAll('tr[data-session-id]').forEach(row => {
                row.addEventListener('click', () => {
                    const sessionId = row.dataset.sessionId;
                    document.querySelectorAll('#allSessionsTable tbody tr').forEach(r => r.classList.remove('selected'));
                    row.classList.add('selected');
                    loadSessionDetail(sessionId);
                });
            });
        } catch (err) {
            console.error(err);
            showError('åŠ è½½ä¼šè¯å¤±è´¥: ' + err.message);
        }
    }

    // åŠ è½½ä¼šè¯è¯¦æƒ…
    async function loadSessionDetail(sessionId) {
        // è®°å½•ç”¨æˆ·æŸ¥çœ‹çš„ä¼šè¯
        UserBehaviorStorage.saveViewedSession(sessionId);
        UserBehaviorStorage.logAction('view_session_detail', {
            sessionId: sessionId,
            type: 'All'
        });
        try {
            const sessions = await fetchJson(`${apiBase}/api/sessions`);
            const session = sessions.find(s => s.sessionId === sessionId);
            if (!session) return;

            const remainingTime = calculateRemainingTime(session.expireTime);
            const remainingTimeStr = formatRemainingTime(remainingTime);
            const timeoutMinutes = session.timeoutMs ? Math.floor(session.timeoutMs / 60000) : null;

            document.getElementById('sessionDetail').innerHTML = `
                <div><strong>Session ID:</strong> <code>${session.sessionId}</code></div>
                <div><strong>æœåŠ¡åç§°:</strong> ${session.serviceName ?? 'æœªç»‘å®š'}</div>
                <div><strong>ä¼ è¾“åè®®:</strong> ${session.transportType || 'SSE'}</div>
                <div><strong>çŠ¶æ€:</strong> <span class="badge ${session.active ? 'success' : 'error'}">${session.active ? 'Active' : 'Closed'}</span></div>
                ${session.clientId ? `<div><strong>å®¢æˆ·ç«¯ID:</strong> ${session.clientId}</div>` : ''}
                ${session.clientIp ? `<div><strong>å®¢æˆ·ç«¯IP:</strong> ${session.clientIp}</div>` : ''}
                ${session.userAgent ? `<div><strong>User-Agent:</strong> <span style="font-size: 11px; word-break: break-all;">${session.userAgent}</span></div>` : ''}
                <div><strong>æœ€åæ´»è·ƒ:</strong> ${formatTime(session.lastActive)}</div>
                ${session.expireTime ? `<div><strong>è¿‡æœŸæ—¶é—´:</strong> ${formatTime(session.expireTime)}</div>` : ''}
                ${remainingTime !== null ? `<div><strong>å‰©ä½™æ—¶é—´:</strong> <span class="badge ${remainingTime > 60000 ? 'success' : remainingTime > 0 ? 'warning' : 'error'}">${remainingTimeStr}</span></div>` : ''}
                ${timeoutMinutes ? `<div><strong>è¶…æ—¶è®¾ç½®:</strong> ${timeoutMinutes}åˆ†é’Ÿ</div>` : ''}
            `;
        } catch (err) {
            console.error(err);
        }
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');

            // è®°å½•ç”¨æˆ·é€‰æ‹©çš„æ ‡ç­¾é¡µ
            UserBehaviorStorage.saveActiveTab(targetTab);
            UserBehaviorStorage.logAction('tab_switch', { tab: targetTab });

            if (targetTab === 'overview') {
                loadOverview();
            } else if (targetTab === 'sse') {
                loadSseDashboard();
            } else if (targetTab === 'restful') {
                loadRestfulRequests(true);
                setupRestfulScrollListener();
            } else if (targetTab === 'streamable') {
                loadStreamableDashboard();
            } else if (targetTab === 'registry') {
                // åŠ è½½ Nacos æœåŠ¡åˆ—è¡¨
                loadNacosServices();
            } else if (targetTab === 'redis') {
                // åŠ è½½ Redis ç®¡ç†æ•°æ®
                loadRedisSessions();
                searchRedisKeys();
            }
        });
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.onclick = function(event) {
        const modal = document.getElementById('registerModal');
        if (event.target === modal) {
            closeRegisterModal();
        }
    }

    // æœåŠ¡æ³¨å†Œä¸­å¿ƒç›¸å…³å‡½æ•°
    let serviceRegistryCache = [];

    // åŠ è½½ Nacos æœåŠ¡åˆ—è¡¨
    async function loadNacosServices() {
        try {
            const container = document.getElementById('nacosServicesList');
            if (!container) {
                console.error('nacosServicesList element not found');
                return;
            }
            container.innerHTML = '<div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>';

            let group = document.getElementById('registryServiceGroupFilter')?.value || 'mcp-server';
            // å¦‚æœé€‰æ‹©çš„æ˜¯ "*"ï¼ˆæ‰€æœ‰æœåŠ¡ç»„ï¼‰ï¼Œåˆ™ä½¿ç”¨ "all" æŸ¥è¯¢æ‰€æœ‰ç»„
            if (group === '*') {
                group = 'all';
            }
            const url = `${baseApiPath}/api/nacos/services?group=${group}&pageNo=1&pageSize=100`;
            console.log('Loading Nacos services from:', url);
            const response = await fetchJson(url);
            console.log('Nacos services response:', response);

            if (!response) {
                container.innerHTML = '<div class="empty-state">è·å–æœåŠ¡åˆ—è¡¨å¤±è´¥ï¼šå“åº”ä¸ºç©º</div>';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (response.error) {
                container.innerHTML = `<div class="empty-state">é”™è¯¯: ${response.error}</div>`;
                return;
            }

            // å¤„ç†å“åº”æ•°æ®
            const serviceInfos = response.serviceInfos || [];
            if (serviceInfos.length > 0) {
                const html = serviceInfos.map(service => {
                    const healthyRate = service.instanceCount > 0
                        ? (service.healthyInstanceCount / service.instanceCount * 100).toFixed(0)
                        : 0;
                    return `
                        <div class="service-card" onclick="showNacosServiceDetail('${service.serviceName}', '${service.group}')">
                            <div class="service-card-header">
                                <h4 class="service-card-name">${service.serviceName}</h4>
                                <div class="service-card-badges">
                                    <span class="service-card-badge">${service.group}</span>
                                </div>
                            </div>
                            <div class="service-card-info">
                                <div class="service-card-stat">
                                    <span class="service-card-stat-value">${service.instanceCount}</span>
                                    <span class="service-card-stat-label">å®ä¾‹æ•°</span>
                                </div>
                                <div class="service-card-stat">
                                    <span class="service-card-stat-value ${service.healthyInstanceCount > 0 ? 'healthy' : 'unhealthy'}">${service.healthyInstanceCount}</span>
                                    <span class="service-card-stat-label">å¥åº·å®ä¾‹</span>
                                </div>
                                <div class="service-card-stat">
                                    <span class="service-card-stat-value">${healthyRate}%</span>
                                    <span class="service-card-stat-label">å¥åº·ç‡</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                container.innerHTML = html;
            } else {
                container.innerHTML = `<div class="empty-state">æš‚æ—  Nacos æœåŠ¡ (ç»„: ${response.group || group})</div>`;
            }
        } catch (err) {
            console.error('åŠ è½½ Nacos æœåŠ¡åˆ—è¡¨å¤±è´¥:', err);
            showError('åŠ è½½ Nacos æœåŠ¡åˆ—è¡¨å¤±è´¥: ' + err.message);
            document.getElementById('nacosServicesList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
        }
    }

    // åŠ è½½ Nacos MCP é…ç½®åˆ—è¡¨ï¼ˆæ ¹æ®æœåŠ¡åï¼‰
    async function loadNacosConfigs(serviceName) {
        try {
            const container = document.getElementById('nacosConfigsList');
            if (!container) {
                console.error('nacosConfigsList element not found');
                return;
            }

            if (!serviceName) {
                container.innerHTML = '<div class="muted" style="text-align: center; padding: 20px;">ç‚¹å‡»ä¸Šæ–¹æœåŠ¡æŸ¥çœ‹é…ç½®</div>';
                return;
            }

            container.innerHTML = '<div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>';

            // å…ˆé€šè¿‡æœåŠ¡åæŸ¥è¯¢é…ç½®
            let url = `${baseApiPath}/api/nacos/configs?appName=${encodeURIComponent(serviceName)}`;
            console.log('Loading Nacos configs from:', url);
            let response = await fetchJson(url);
            console.log('Nacos configs response:', response);

            // å¦‚æœè¿”å› null æˆ–æ²¡æ•°æ®ï¼Œå›é€€åˆ°æŸ¥è¯¢æ‰€æœ‰é…ç½®
            if (!response || !response.configs || response.configs.length === 0) {
                console.log('No configs found for service, loading all configs...');
                url = `${baseApiPath}/api/nacos/configs`;
                response = await fetchJson(url);
                console.log('All configs response:', response);
            }

            if (!response) {
                container.innerHTML = '<div class="empty-state">è·å–é…ç½®åˆ—è¡¨å¤±è´¥ï¼šå“åº”ä¸ºç©º</div>';
                return;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            if (response.error) {
                container.innerHTML = `<div class="empty-state">é”™è¯¯: ${response.error}</div>`;
                return;
            }

            let configs = response.configs || [];

            // å¦‚æœé…ç½®ä¸­æœ‰ serviceName ä¸º null çš„ï¼Œå°è¯•é€šè¿‡æœåŠ¡åˆ—è¡¨åŒ¹é… UUID æ¥å¡«å……
            const configsWithNullServiceName = configs.filter(c => !c.serviceName && c.uuid);
            if (configsWithNullServiceName.length > 0) {
                try {
                    // è·å–æ‰€æœ‰æœåŠ¡åˆ—è¡¨
                    const servicesResponse = await fetchJson(`${baseApiPath}/api/nacos/services?group=*`);
                    if (servicesResponse && servicesResponse.serviceInfos) {
                        // åˆ›å»ºæœåŠ¡ååˆ° UUID çš„æ˜ å°„
                        const serviceUuidMap = {};
                        for (const serviceInfo of servicesResponse.serviceInfos) {
                            try {
                                const uuidResponse = await fetchJson(`${baseApiPath}/api/mcp/config/uuid?serverName=${encodeURIComponent(serviceInfo.serviceName)}`);
                                if (uuidResponse && uuidResponse.uuid) {
                                    serviceUuidMap[uuidResponse.uuid] = serviceInfo.serviceName;
                                }
                            } catch (e) {
                                console.debug('Failed to get UUID for service:', serviceInfo.serviceName, e);
                            }
                        }

                        // å¡«å…… serviceName
                        configs.forEach(config => {
                            if (!config.serviceName && config.uuid && serviceUuidMap[config.uuid]) {
                                config.serviceName = serviceUuidMap[config.uuid];
                            }
                        });
                    }
                } catch (e) {
                    console.warn('Failed to match service names with UUIDs:', e);
                }
            }

            if (configs.length > 0) {
                // ç›´æ¥å±•ç¤ºé…ç½®ï¼Œä¸åˆ†ç»„
                let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
                configs.forEach(config => {
                    const displayName = config.dataId;
                    html += `
                        <div style="background: var(--card-bg); border: 1px solid var(--border); border-radius: 6px; padding: 10px; cursor: pointer; transition: all 0.2s;"
                             onmouseover="this.style.borderColor='var(--primary)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'"
                             onmouseout="this.style.borderColor='var(--border)'; this.style.boxShadow='none'"
                             onclick="viewNacosConfigInPage('${config.dataId}', '${config.group}')">
                            <div style="font-size: 13px; color: var(--text); font-weight: 500;">${displayName}</div>
                            <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                                Group: ${config.group}${config.version ? ' | Version: ' + config.version : ''}${config.serviceName ? ' | Service: ' + config.serviceName : ''}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="empty-state">æš‚æ—  Nacos MCP é…ç½®</div>';
            }
        } catch (err) {
            console.error('åŠ è½½ Nacos é…ç½®åˆ—è¡¨å¤±è´¥:', err);
            showError('åŠ è½½ Nacos é…ç½®åˆ—è¡¨å¤±è´¥: ' + err.message);
            document.getElementById('nacosConfigsList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
        }
    }

    // æ˜¾ç¤º Nacos æœåŠ¡è¯¦æƒ…
    async function showNacosServiceDetail(serviceName, serviceGroup) {
        try {
            // åŠ è½½é…ç½®åˆ—è¡¨
            loadNacosConfigs(serviceName);

            // è·å–æœåŠ¡å®ä¾‹å¹¶æ˜¾ç¤ºè¯¦æƒ…
            const instances = await fetchJson(`${baseApiPath}/api/mcp/servers/instances?serviceName=${serviceName}&serviceGroup=${serviceGroup}`);
            const instancesList = Array.isArray(instances) ? instances : (instances ? [instances] : []);

            // æ˜¾ç¤ºè¯¦æƒ…ï¼ˆå¯ä»¥å¤ç”¨ç°æœ‰çš„ showServiceDetail é€»è¾‘ï¼‰
            showServiceDetail(serviceName, serviceGroup);
        } catch (err) {
            console.error('åŠ è½½ Nacos æœåŠ¡è¯¦æƒ…å¤±è´¥:', err);
            showError('åŠ è½½æœåŠ¡è¯¦æƒ…å¤±è´¥: ' + err.message);
        }
    }

    // åœ¨å½“å‰é¡µé¢æŸ¥çœ‹ Nacos é…ç½®è¯¦æƒ…
    async function viewNacosConfigInPage(dataId, group) {
        try {
            const container = document.getElementById('serviceConfig');
            container.innerHTML = '<div class="loading"><div class="spinner"></div> åŠ è½½é…ç½®ä¸­...</div>';

            // ä» dataId ä¸­æå– UUID å’Œç‰ˆæœ¬
            let uuid = null;
            let version = null;

            if (dataId.includes('-mcp-versions.json')) {
                uuid = dataId.replace('-mcp-versions.json', '');
            } else if (dataId.includes('-mcp-server.json')) {
                const withoutSuffix = dataId.replace('-mcp-server.json', '');
                const parts = withoutSuffix.split('-');
                if (parts.length >= 5) {
                    uuid = parts.slice(0, 5).join('-');
                    version = parts.length > 5 ? parts[5] : null;
                }
            } else if (dataId.includes('-mcp-tools.json')) {
                const withoutSuffix = dataId.replace('-mcp-tools.json', '');
                const parts = withoutSuffix.split('-');
                if (parts.length >= 5) {
                    uuid = parts.slice(0, 5).join('-');
                    version = parts.length > 5 ? parts[5] : null;
                }
            }

            if (!uuid) {
                container.innerHTML = '<div class="error-box">æ— æ³•ä» dataId ä¸­æå– UUID: ' + dataId + '</div>';
                return;
            }

            let config = null;
            let response = null;

            try {
                if (group === 'mcp-server' && version) {
                    response = await fetchJson(`${baseApiPath}/api/mcp/config/server?uuid=${uuid}&version=${version}`);
                } else if (group === 'mcp-tools' && version) {
                    response = await fetchJson(`${baseApiPath}/api/mcp/config/tools?uuid=${uuid}&version=${version}`);
                } else if (group === 'mcp-server-versions') {
                    response = await fetchJson(`${baseApiPath}/api/mcp/config/versions?uuid=${uuid}`);
                }

                // å¤„ç†å“åº”ï¼Œå¯èƒ½æ˜¯ ResponseEntity æ ¼å¼
                if (response) {
                    if (response.body !== undefined) {
                        config = response.body;
                    } else if (response.id || response.name || response.tools || response.versions) {
                        // ç›´æ¥æ˜¯é…ç½®å¯¹è±¡
                        config = response;
                    }
                }
            } catch (err) {
                console.error('è·å–é…ç½®å¤±è´¥:', err);
                container.innerHTML = '<div class="error-box">è·å–é…ç½®å¤±è´¥: ' + err.message + '</div>';
                return;
            }

            if (config) {
                const configJson = formatJson(config);
                let html = `
                    <div style="margin-bottom: 12px; padding: 8px; background: var(--card-bg); border-radius: 6px; border: 1px solid var(--border);">
                        <div style="font-size: 12px; color: var(--text-muted);">
                            <strong>DataId:</strong> ${dataId}<br>
                            <strong>Group:</strong> ${group}<br>
                            ${uuid ? `<strong>UUID:</strong> ${uuid}<br>` : ''}
                            ${version ? `<strong>Version:</strong> ${version}` : ''}
                        </div>
                    </div>
                    <div class="json-viewer-header">
                        <div class="json-viewer-title">é…ç½®å†…å®¹</div>
                        <button class="copy-btn" onclick="copyJson('nacosConfigContent')">å¤åˆ¶</button>
                    </div>
                    <div class="json-viewer" id="nacosConfigContent" style="max-height: 500px; overflow-y: auto;">${highlightJson(configJson)}</div>
                `;
                container.innerHTML = html;
            } else {
                container.innerHTML = '<div class="error-box">æœªæ‰¾åˆ°é…ç½®è¯¦æƒ…æˆ–é…ç½®ä¸ºç©º</div>';
            }
        } catch (err) {
            console.error('æŸ¥çœ‹ Nacos é…ç½®è¯¦æƒ…å¤±è´¥:', err);
            document.getElementById('serviceConfig').innerHTML = '<div class="error-box">æŸ¥çœ‹é…ç½®è¯¦æƒ…å¤±è´¥: ' + err.message + '</div>';
        }
    }

    // æŸ¥çœ‹ Nacos é…ç½®ï¼ˆä¿ç•™åŸå‡½æ•°ç”¨äºå…¼å®¹ï¼‰
    async function viewNacosConfig(dataId, group) {
        try {
            // ä» dataId ä¸­æå– UUID å’Œç‰ˆæœ¬
            let uuid = null;
            let version = null;

            if (dataId.includes('-mcp-versions.json')) {
                uuid = dataId.replace('-mcp-versions.json', '');
            } else if (dataId.includes('-mcp-server.json')) {
                const withoutSuffix = dataId.replace('-mcp-server.json', '');
                const parts = withoutSuffix.split('-');
                if (parts.length >= 5) {
                    uuid = parts.slice(0, 5).join('-');
                    version = parts.length > 5 ? parts[5] : null;
                }
            } else if (dataId.includes('-mcp-tools.json')) {
                const withoutSuffix = dataId.replace('-mcp-tools.json', '');
                const parts = withoutSuffix.split('-');
                if (parts.length >= 5) {
                    uuid = parts.slice(0, 5).join('-');
                    version = parts.length > 5 ? parts[5] : null;
                }
            }

            if (!uuid) {
                showError('æ— æ³•ä» dataId ä¸­æå– UUID: ' + dataId);
                return;
            }

            let config = null;
            let response = null;

            if (group === 'mcp-server' && version) {
                response = await fetchJson(`${baseApiPath}/api/mcp/config/server?uuid=${uuid}&version=${version}`);
            } else if (group === 'mcp-tools' && version) {
                response = await fetchJson(`${baseApiPath}/api/mcp/config/tools?uuid=${uuid}&version=${version}`);
            } else if (group === 'mcp-server-versions') {
                response = await fetchJson(`${baseApiPath}/api/mcp/config/versions?uuid=${uuid}`);
            }

            // å¤„ç†å“åº”ï¼Œå¯èƒ½æ˜¯ ResponseEntity æ ¼å¼
            if (response) {
                if (response.body !== undefined) {
                    config = response.body;
                } else if (response.id || response.name || response.tools || response.versions) {
                    // ç›´æ¥æ˜¯é…ç½®å¯¹è±¡
                    config = response;
                }
            }

            if (config) {
                const configJson = formatJson(config);
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'flex';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                        <div class="modal-header">
                            <h3>é…ç½®è¯¦æƒ…: ${dataId}</h3>
                            <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                        </div>
                        <div style="padding: 16px;">
                            <div class="json-viewer-header">
                                <div class="json-viewer-title">${group}</div>
                                <button class="copy-btn" onclick="copyJson('configViewer')">å¤åˆ¶</button>
                            </div>
                            <div class="json-viewer" id="configViewer">${highlightJson(configJson)}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.onclick = (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                };
            } else {
                showError('æ— æ³•è·å–é…ç½®å†…å®¹');
            }
        } catch (err) {
            console.error('æŸ¥çœ‹é…ç½®å¤±è´¥:', err);
            showError('æŸ¥çœ‹é…ç½®å¤±è´¥: ' + err.message);
        }
    }

    // åŠ è½½æœåŠ¡æ³¨å†Œä¸­å¿ƒ
    async function loadServiceRegistry() {
        try {
            const container = document.getElementById('serviceRegistryList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</div>';

            const serviceGroup = document.getElementById('registryServiceGroupFilter')?.value || '*';
            const serviceName = document.getElementById('registryServiceNameFilter')?.value.trim() || '*';

            const params = new URLSearchParams();
            params.append('serviceName', serviceName);
            params.append('serviceGroup', serviceGroup);

            const servers = await fetchJson(`${baseApiPath}/api/mcp/servers?${params}`);
            // å¤„ç†Fluxå“åº”ï¼ˆå¯èƒ½æ˜¯æ•°ç»„æˆ–å•ä¸ªå¯¹è±¡ï¼‰
            let serverArray = [];
            if (Array.isArray(servers)) {
                serverArray = servers;
            } else if (servers && typeof servers === 'object') {
                // å¦‚æœæ˜¯å•ä¸ªå¯¹è±¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
                serverArray = [servers];
            }
            serviceRegistryCache = serverArray;

            renderServiceRegistryList(serviceRegistryCache);
        } catch (err) {
            console.error('åŠ è½½æœåŠ¡æ³¨å†Œä¸­å¿ƒå¤±è´¥:', err);
            showError('åŠ è½½æœåŠ¡åˆ—è¡¨å¤±è´¥: ' + err.message);
            document.getElementById('serviceRegistryList').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥: ' + err.message + '</div>';
        }
    }

    // æ¸²æŸ“æœåŠ¡åˆ—è¡¨
    function renderServiceRegistryList(servers) {
        const container = document.getElementById('serviceRegistryList');
        if (!servers || servers.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— æœåŠ¡</div>';
            return;
        }

        // æŒ‰æœåŠ¡ååˆ†ç»„
        const grouped = {};
        servers.forEach(server => {
            const name = server.name || 'unknown';
            if (!grouped[name]) {
                grouped[name] = [];
            }
            grouped[name].push(server);
        });

        // è¿‡æ»¤æ‰å®ä¾‹æ•°ä¸º0çš„æœåŠ¡
        const filteredGroups = Object.entries(grouped).filter(([name, instances]) => {
            return instances.length > 0;
        });

        if (filteredGroups.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— æœ‰æ•ˆæœåŠ¡ï¼ˆæ‰€æœ‰æœåŠ¡å®ä¾‹æ•°ä¸º0ï¼‰</div>';
            return;
        }

        container.innerHTML = filteredGroups.map(([name, instances]) => {
            const healthyCount = instances.filter(i => i.healthy).length;
            const totalCount = instances.length;
            const isHealthy = healthyCount > 0;
            const version = instances[0]?.version || 'unknown';
            const serviceGroup = instances[0]?.serviceGroup || 'mcp-server';

            return `
                <div class="service-card" onclick="showServiceDetail('${name}', '${serviceGroup}')">
                    <div class="service-card-header">
                        <h4 class="service-card-name">${name}</h4>
                        <div class="service-card-badges">
                            <span class="service-card-badge">${serviceGroup}</span>
                            <span class="service-card-badge">${version}</span>
                        </div>
                    </div>
                    <div class="service-card-body">
                        <div class="service-card-health">
                            <span class="health-indicator ${isHealthy ? 'healthy' : 'unhealthy'}"></span>
                            <span>${isHealthy ? 'å¥åº·' : 'å¼‚å¸¸'}</span>
                        </div>
                    </div>
                    <div class="service-card-footer">
                        <div class="service-card-stat">
                            <div class="service-card-stat-value ${isHealthy ? 'healthy' : 'unhealthy'}">${healthyCount}</div>
                            <div class="service-card-stat-label">å¥åº·</div>
                        </div>
                        <div class="service-card-stat">
                            <div class="service-card-stat-value">${totalCount}</div>
                            <div class="service-card-stat-label">æ€»è®¡</div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // æ˜¾ç¤ºæœåŠ¡è¯¦æƒ…
    async function showServiceDetail(serviceName, serviceGroup) {
        try {
            // è·å–æ‰€æœ‰å®ä¾‹
            const params = new URLSearchParams();
            params.append('serviceName', serviceName);
            params.append('serviceGroup', serviceGroup);
            const instances = await fetchJson(`${baseApiPath}/api/mcp/servers/instances?${params}`);
            const instancesList = Array.isArray(instances) ? instances : [];

            // è·å–ç‰ˆæœ¬åˆ—è¡¨
            let versions = [];
            let versionsError = null;
            try {
                // åç«¯ç°åœ¨æ”¯æŒæœåŠ¡åç§°ï¼Œç›´æ¥ä½¿ç”¨æœåŠ¡åç§°è·å–ç‰ˆæœ¬åˆ—è¡¨
                const versionsUrl = `${baseApiPath}/api/mcp/servers/config/versions/${serviceName}`;
                console.log('Fetching versions from:', versionsUrl);
                const versionsResp = await fetchJson(versionsUrl);
                console.log('Versions response:', versionsResp);

                if (versionsResp) {
                    if (versionsResp.error) {
                        versionsError = versionsResp.error.message || 'è·å–ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥';
                        console.warn('Versions API returned error:', versionsResp.error);
                    } else if (Array.isArray(versionsResp)) {
                        versions = versionsResp;
                    } else if (versionsResp.versions && Array.isArray(versionsResp.versions)) {
                        versions = versionsResp.versions;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch versions:', e);
                versionsError = e.message || 'è·å–ç‰ˆæœ¬åˆ—è¡¨å¤±è´¥';
            }

            // è·å–å¥åº·çŠ¶æ€
            let healthStatus = null;
            try {
                const healthResp = await fetchJson(`${baseApiPath}/mcp/health/status/${serviceName}`);
                if (healthResp && healthResp.found) {
                    healthStatus = healthResp;
                }
            } catch (e) {
                console.debug('Health status not available:', e);
            }

            // è·å–é…ç½®ï¼ˆä½¿ç”¨ç¬¬ä¸€ä¸ªå®ä¾‹çš„ç‰ˆæœ¬ï¼Œæˆ–é»˜è®¤ç‰ˆæœ¬ï¼‰
            const currentVersion = instancesList[0]?.version || '1.0.0';
            let serverConfig = null;
            let toolsConfig = null;
            let toolsList = [];
            let configError = null;

            try {
                // åç«¯ç°åœ¨æ”¯æŒæœåŠ¡åç§°ï¼Œç›´æ¥ä½¿ç”¨æœåŠ¡åç§°è·å–é…ç½®
                const configUrl = `${baseApiPath}/api/mcp/servers/config/full/${serviceName}?version=${currentVersion}`;
                console.log('Fetching config from:', configUrl);
                const fullConfig = await fetchJson(configUrl);
                console.log('Full config response:', fullConfig);

                // å¤„ç† null æˆ– undefined å“åº”
                if (fullConfig === null || fullConfig === undefined) {
                    configError = 'é…ç½®å“åº”ä¸ºç©ºï¼Œå¯èƒ½æœåŠ¡æœªåœ¨ Nacos ä¸­æ³¨å†Œé…ç½®';
                    console.warn('Config response is null');
                } else if (fullConfig.error) {
                    // å¤„ç†é”™è¯¯å“åº”
                    configError = fullConfig.error.message || fullConfig.error.code || 'è·å–é…ç½®å¤±è´¥';
                    console.warn('Config API returned error:', fullConfig.error);
                } else if (fullConfig.raw === true) {
                    // å¤„ç†åŸå§‹æ–‡æœ¬å“åº”
                    configError = 'é…ç½® API è¿”å›äº†é JSON æ ¼å¼çš„å“åº”';
                    console.warn('Config API returned raw text:', fullConfig.message);
                } else {
                    // å¤„ç†æ­£å¸¸çš„é…ç½®å“åº”
                    // å¤„ç†ä¸åŒçš„å“åº”æ ¼å¼
                    if (fullConfig.serverConfig) {
                        serverConfig = fullConfig.serverConfig;
                    } else if (fullConfig.name || fullConfig.version) {
                        // å¦‚æœç›´æ¥è¿”å›æœåŠ¡å™¨é…ç½®å¯¹è±¡
                        serverConfig = fullConfig;
                    }

                    if (fullConfig.toolsConfig) {
                        toolsConfig = fullConfig.toolsConfig;
                    } else if (fullConfig.tools && Array.isArray(fullConfig.tools)) {
                        toolsConfig = { tools: fullConfig.tools };
                    }

                    if (toolsConfig && toolsConfig.tools && Array.isArray(toolsConfig.tools)) {
                        toolsList = toolsConfig.tools;
                    }
                }
            } catch (e) {
                console.error('Failed to fetch config:', e);
                // æ£€æŸ¥æ˜¯å¦æ˜¯ JSON è§£æé”™è¯¯
                if (e.message && e.message.includes('JSON')) {
                    configError = 'é…ç½® API è¿”å›äº†æ— æ•ˆçš„ JSON å“åº”ï¼Œå¯èƒ½æ˜¯æœåŠ¡å™¨é”™è¯¯';
                } else {
                    configError = e.message || 'è·å–é…ç½®å¤±è´¥';
                }
            }

            // æ¸²æŸ“æœåŠ¡è¯¦æƒ…
            const firstInstance = instancesList[0] || {};
            const protocol = firstInstance.metadata?.protocol || firstInstance.protocol || 'mcp-sse';
            const sseEndpoint = firstInstance.sseEndpoint || firstInstance.metadata?.sseEndpoint || '/sse';
            const sseMessageEndpoint = firstInstance.metadata?.sseMessageEndpoint || '/mcp/message';

            document.getElementById('serviceDetail').innerHTML = `
                <div class="service-detail-section">
                    <h4>åŸºæœ¬ä¿¡æ¯</h4>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœåŠ¡åç§°</span>
                        <span class="service-detail-value">${serviceName}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœåŠ¡ç»„</span>
                        <span class="service-detail-value">${serviceGroup}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">å®ä¾‹æ•°é‡</span>
                        <span class="service-detail-value">${instancesList.length} (å¥åº·: ${instancesList.filter(i => i.healthy).length})</span>
                    </div>
                    ${healthStatus ? `
                    <div class="service-detail-item">
                        <span class="service-detail-label">å¥åº·çŠ¶æ€</span>
                        <span class="service-detail-value">
                            <span class="health-indicator ${healthStatus.healthy ? 'healthy' : 'unhealthy'}"></span>
                            ${healthStatus.healthy ? 'å¥åº·' : 'ä¸å¥åº·'}
                        </span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœ€åæ£€æŸ¥</span>
                        <span class="service-detail-value">${formatTime(healthStatus.lastCheckTime)}</span>
                    </div>
                    ` : ''}
                    <div class="service-detail-item" style="margin-top: 12px;">
                        <button class="btn btn-danger btn-small" onclick="deregisterServer('${serviceName}', '${serviceGroup}')">æ³¨é”€æœåŠ¡</button>
                    </div>
                </div>
                <div class="service-detail-section">
                    <h4>å®ä¾‹åˆ—è¡¨ (${instancesList.length})</h4>
                    <div class="instance-list">
                        ${instancesList.length > 0 ? instancesList.map(inst => {
                            const instHost = inst.host || inst.ip;
                            return `
                            <div class="instance-item">
                                <div class="instance-header">
                                    <div>
                                        <div class="instance-address">${instHost}:${inst.port}</div>
                                        <div class="instance-meta">
                                            <span class="instance-meta-item">
                                                <span>æƒé‡:</span>
                                                <strong>${inst.weight || 1.0}</strong>
                                            </span>
                                            <span class="instance-meta-item">
                                                <span>ç±»å‹:</span>
                                                <strong>${inst.ephemeral ? 'ä¸´æ—¶' : 'æŒä¹…'}</strong>
                                            </span>
                                            ${inst.version ? `
                                            <span class="instance-meta-item">
                                                <span>ç‰ˆæœ¬:</span>
                                                <strong>${inst.version}</strong>
                                            </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div class="instance-status">
                                        <span class="health-indicator ${inst.healthy ? 'healthy' : 'unhealthy'}"></span>
                                        <span>${inst.healthy ? 'å¥åº·' : 'å¼‚å¸¸'}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        }).join('') : '<div class="muted">æš‚æ— å®ä¾‹</div>'}
                    </div>
                </div>
                ${toolsList.length > 0 ? `
                <div class="service-detail-section">
                    <h4>å·¥å…·åˆ—è¡¨ (${toolsList.length})</h4>
                    <div class="tools-list">
                        ${toolsList.map(tool => `
                            <div class="tool-item">
                                <div class="tool-item-name">${tool.name || '-'}</div>
                                <div class="tool-item-desc">${tool.description || 'æ— æè¿°'}</div>
                                ${tool.inputSchema ? `
                                    <div class="tool-item-params">å‚æ•°: ${JSON.stringify(tool.inputSchema, null, 2)}</div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            // æ¸²æŸ“é…ç½®ä¿¡æ¯ï¼ˆå¸¦ç‰ˆæœ¬é€‰æ‹©ï¼‰
            let configHtml = '';

            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            if (configError || versionsError) {
                configHtml += '<div class="error-box" style="margin-bottom: 16px;">';
                if (configError) {
                    configHtml += `<div>é…ç½®è·å–å¤±è´¥: ${configError}</div>`;
                }
                if (versionsError) {
                    configHtml += `<div>ç‰ˆæœ¬åˆ—è¡¨è·å–å¤±è´¥: ${versionsError}</div>`;
                }
                configHtml += '</div>';
            }

            if (versions.length > 0) {
                configHtml += `
                    <div class="version-selector">
                        <label style="white-space: nowrap;">ç‰ˆæœ¬:</label>
                        <select id="configVersionSelect" onchange="loadServiceConfig('${serviceName}', this.value)">
                            ${versions.map(v => `<option value="${v}" ${v === currentVersion ? 'selected' : ''}>${v}</option>`).join('')}
                        </select>
                    </div>
                `;
            } else if (!versionsError && instancesList.length > 0) {
                // å¦‚æœæ²¡æœ‰ç‰ˆæœ¬åˆ—è¡¨ä½†æœ‰å®ä¾‹ï¼Œä½¿ç”¨å®ä¾‹çš„ç‰ˆæœ¬
                configHtml += `
                    <div class="version-selector">
                        <label style="white-space: nowrap;">ç‰ˆæœ¬:</label>
                        <select id="configVersionSelect" onchange="loadServiceConfig('${serviceName}', this.value)">
                            <option value="${currentVersion}" selected>${currentVersion}</option>
                        </select>
                    </div>
                `;
            }

            if (serverConfig || toolsConfig) {
                if (serverConfig) {
                    const serverConfigJson = formatJson(serverConfig);
                    configHtml += `
                        <div class="config-tabs">
                            <button class="config-tab active" onclick="switchConfigTab('server')">æœåŠ¡å™¨é…ç½®</button>
                            ${toolsConfig ? `<button class="config-tab" onclick="switchConfigTab('tools')">å·¥å…·é…ç½®</button>` : ''}
                        </div>
                        <div class="config-tab-content active" id="serverConfigTab">
                            <div class="json-viewer-header">
                                <div class="json-viewer-title">Server Config</div>
                                <button class="copy-btn" onclick="copyJson('serviceServerConfig')">å¤åˆ¶</button>
                            </div>
                            <div class="json-viewer" id="serviceServerConfig">${highlightJson(serverConfigJson)}</div>
                        </div>
                    `;
                }
                if (toolsConfig) {
                    const toolsConfigJson = formatJson(toolsConfig);
                    configHtml += `
                        <div class="config-tab-content" id="toolsConfigTab">
                            <div class="json-viewer-header">
                                <div class="json-viewer-title">Tools Config</div>
                                <button class="copy-btn" onclick="copyJson('serviceToolsConfig')">å¤åˆ¶</button>
                            </div>
                            <div class="json-viewer" id="serviceToolsConfig">${highlightJson(toolsConfigJson)}</div>
                        </div>
                    `;
                }
            } else {
                let noConfigMsg = '<div class="muted">é…ç½®ä¿¡æ¯ä¸å¯ç”¨';
                if (configError) {
                    noConfigMsg += `<br><small style="color: var(--error);">é”™è¯¯: ${configError}</small>`;
                } else if (instancesList.length === 0) {
                    noConfigMsg += '<br><small>è¯·å…ˆç¡®ä¿æœåŠ¡å·²æ³¨å†Œå¹¶è¿è¡Œ</small>';
                }
                noConfigMsg += '</div>';
                configHtml = noConfigMsg;
            }
            document.getElementById('serviceConfig').innerHTML = configHtml;
        } catch (err) {
            console.error(err);
            showError('åŠ è½½æœåŠ¡è¯¦æƒ…å¤±è´¥: ' + err.message);
        }
    }

    // åˆ‡æ¢é…ç½®æ ‡ç­¾
    function switchConfigTab(tab) {
        document.querySelectorAll('.config-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.config-tab-content').forEach(c => c.classList.remove('active'));

        if (tab === 'server') {
            document.querySelector('.config-tab').classList.add('active');
            document.getElementById('serverConfigTab').classList.add('active');
        } else if (tab === 'tools') {
            document.querySelectorAll('.config-tab')[1].classList.add('active');
            document.getElementById('toolsConfigTab').classList.add('active');
        }
    }

    // åŠ è½½æœåŠ¡é…ç½®ï¼ˆåˆ‡æ¢ç‰ˆæœ¬æ—¶ï¼‰
    async function loadServiceConfig(serviceName, version) {
        try {
            // åç«¯ç°åœ¨æ”¯æŒæœåŠ¡åç§°ï¼Œç›´æ¥ä½¿ç”¨æœåŠ¡åç§°è·å–é…ç½®
            const configUrl = `${baseApiPath}/api/mcp/servers/config/full/${serviceName}?version=${version}`;
            console.log('Loading config from:', configUrl);
            const fullConfig = await fetchJson(configUrl);
            console.log('Config response:', fullConfig);

            if (fullConfig) {
                if (fullConfig.error) {
                    showError('åŠ è½½é…ç½®å¤±è´¥: ' + (fullConfig.error.message || fullConfig.error.code || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }

                const serverConfig = fullConfig.serverConfig || (fullConfig.name ? fullConfig : null);
                const toolsConfig = fullConfig.toolsConfig || (fullConfig.tools ? { tools: fullConfig.tools } : null);

                if (serverConfig) {
                    const serverConfigJson = formatJson(serverConfig);
                    document.getElementById('serviceServerConfig').innerHTML = highlightJson(serverConfigJson);
                } else {
                    document.getElementById('serviceServerConfig').innerHTML = '<span class="json-null">æœåŠ¡å™¨é…ç½®ä¸å¯ç”¨</span>';
                }

                if (toolsConfig) {
                    const toolsConfigJson = formatJson(toolsConfig);
                    document.getElementById('serviceToolsConfig').innerHTML = highlightJson(toolsConfigJson);
                } else {
                    document.getElementById('serviceToolsConfig').innerHTML = '<span class="json-null">å·¥å…·é…ç½®ä¸å¯ç”¨</span>';
                }
            } else {
                showError('é…ç½®å“åº”ä¸ºç©º');
            }
        } catch (err) {
            console.error('Failed to load config:', err);
            showError('åŠ è½½é…ç½®å¤±è´¥: ' + err.message);
        }
    }

    // æ˜¾ç¤ºæ³¨å†ŒæœåŠ¡è¡¨å•
    function showRegisterServerForm() {
        document.getElementById('registerModal').classList.add('active');
    }

    // å…³é—­æ³¨å†Œæ¨¡æ€æ¡†
    function closeRegisterModal() {
        document.getElementById('registerModal').classList.remove('active');
        document.getElementById('registerForm').reset();
    }

    // å¤„ç†æœåŠ¡æ³¨å†Œ
    async function handleRegisterServer(event) {
        event.preventDefault();

        try {
            const serverInfo = {
                name: document.getElementById('registerName').value.trim(),
                version: document.getElementById('registerVersion').value.trim(),
                ip: document.getElementById('registerIp').value.trim(),
                port: parseInt(document.getElementById('registerPort').value),
                serviceGroup: document.getElementById('registerServiceGroup').value.trim() || 'mcp-server',
                sseEndpoint: document.getElementById('registerSseEndpoint').value.trim() || '/sse',
                weight: parseFloat(document.getElementById('registerWeight').value) || 1.0,
                ephemeral: document.getElementById('registerEphemeral').value === 'true',
                healthy: true
            };

            const metadataStr = document.getElementById('registerMetadata').value.trim();
            if (metadataStr) {
                try {
                    serverInfo.metadata = JSON.parse(metadataStr);
                } catch (e) {
                    showError('å…ƒæ•°æ® JSON æ ¼å¼é”™è¯¯: ' + e.message);
                    return;
                }
            }

            const response = await fetch(`${baseApiPath}/api/mcp/servers/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(serverInfo)
            });

            const result = await response.text();
            if (response.ok) {
                showSuccess('æœåŠ¡æ³¨å†ŒæˆåŠŸ');
                closeRegisterModal();
                setTimeout(() => {
                    loadNacosServices();
                }, 1000);
            } else {
                showError('æœåŠ¡æ³¨å†Œå¤±è´¥: ' + result);
            }
        } catch (err) {
            console.error(err);
            showError('æœåŠ¡æ³¨å†Œå¤±è´¥: ' + err.message);
        }
    }

    // æ³¨é”€æœåŠ¡
    async function deregisterServer(serviceName, serviceGroup) {
        if (!confirm(`ç¡®å®šè¦æ³¨é”€æœåŠ¡ "${serviceName}" å—ï¼Ÿ`)) {
            return;
        }

        try {
            const params = new URLSearchParams({ serviceName, serviceGroup: serviceGroup || 'mcp-server' });
            const response = await fetch(`${baseApiPath}/api/mcp/servers/deregister?${params}`, {
                method: 'POST'
            });

            const result = await response.text();
            if (response.ok) {
                showSuccess('æœåŠ¡æ³¨é”€æˆåŠŸ');
                setTimeout(() => {
                    loadNacosServices();
                }, 1000);
            } else {
                showError('æœåŠ¡æ³¨é”€å¤±è´¥: ' + result);
            }
        } catch (err) {
            console.error(err);
            showError('æœåŠ¡æ³¨é”€å¤±è´¥: ' + err.message);
        }
    }

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showSuccess(message) {
        const box = document.getElementById('errorBox');
        box.textContent = message;
        box.style.background = 'rgba(16, 185, 129, 0.1)';
        box.style.borderColor = 'rgba(16, 185, 129, 0.2)';
        box.style.color = 'var(--success)';
        box.style.display = 'block';
        setTimeout(() => {
            box.style.display = 'none';
        }, 3000);
    }

    // å¥åº·ç›‘æ§ç›¸å…³å‡½æ•°
    let healthMonitorCache = [];

    // åŠ è½½å¥åº·ç›‘æ§
    async function loadHealthMonitor() {
        try {
            const tbody = document.querySelector('#healthStatusTable tbody');
            tbody.innerHTML = '<tr><td colspan="8" class="loading"><div class="spinner"></div> åŠ è½½ä¸­...</td></tr>';

            // åŠ è½½å¥åº·çŠ¶æ€
            const healthStatuses = await fetchJson(`${baseApiPath}/mcp/health/status`);
            const statuses = healthStatuses?.healthStatuses || {};

            // åŠ è½½æœåŠ¡åˆ—è¡¨
            const servers = await fetchJson(`${baseApiPath}/api/mcp/servers?serviceName=*&serviceGroup=mcp-server`);
            // å¤„ç†Fluxå“åº”
            let serverList = [];
            if (Array.isArray(servers)) {
                serverList = servers;
            } else if (servers && typeof servers === 'object') {
                serverList = [servers];
            }

            // åŠ è½½ç†”æ–­å™¨çŠ¶æ€
            const circuitBreakers = await fetchJson(`${baseApiPath}/mcp/health/circuit-breakers`);
            const breakers = circuitBreakers?.circuitBreakers || {};

            // åˆå¹¶æ•°æ®
            const serviceNames = new Set();
            serverList.forEach(s => serviceNames.add(s.name));
            Object.keys(statuses).forEach(s => serviceNames.add(s));

            const healthData = Array.from(serviceNames).map(name => {
                const status = statuses[name];
                const breaker = breakers[name];
                const serverInstances = serverList.filter(s => s.name === name);

                return {
                    serviceName: name,
                    healthy: status?.healthy ?? (serverInstances.some(s => s.healthy)),
                    lastCheckTime: status?.lastCheckTime,
                    successCount: status?.successCount ?? 0,
                    failureCount: status?.failureCount ?? 0,
                    circuitBreakerState: breaker?.state || 'CLOSED',
                    serverId: status?.serverId,
                    instances: serverInstances
                };
            });

            healthMonitorCache = healthData;
            renderHealthMonitor(healthData);

            // æ›´æ–°ç»Ÿè®¡
            updateHealthStats(healthData);
        } catch (err) {
            console.error(err);
            showError('åŠ è½½å¥åº·ç›‘æ§å¤±è´¥: ' + err.message);
        }
    }

    // æ¸²æŸ“å¥åº·ç›‘æ§è¡¨æ ¼
    function renderHealthMonitor(data) {
        const filter = document.getElementById('healthServiceFilter')?.value.trim().toLowerCase() || '';
        const filtered = filter ? data.filter(d => d.serviceName.toLowerCase().includes(filter)) : data;

        const tbody = document.querySelector('#healthStatusTable tbody');
        if (!filtered || filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = filtered.map(item => {
            const successRate = item.successCount + item.failureCount > 0
                ? ((item.successCount / (item.successCount + item.failureCount)) * 100).toFixed(1)
                : '-';
            const circuitBreakerClass = item.circuitBreakerState?.toLowerCase() || 'closed';

            return `
                <tr data-service-name="${item.serviceName}" style="cursor: pointer;">
                    <td>${item.serviceName}</td>
                    <td>
                        <span class="health-indicator ${item.healthy ? 'healthy' : 'unhealthy'}"></span>
                        ${item.healthy ? 'å¥åº·' : 'ä¸å¥åº·'}
                    </td>
                    <td>${item.lastCheckTime ? formatTime(item.lastCheckTime) : '-'}</td>
                    <td>${item.successCount}</td>
                    <td>${item.failureCount}</td>
                    <td>${successRate}%</td>
                    <td>
                        <span class="circuit-breaker-badge ${circuitBreakerClass}">${item.circuitBreakerState || 'CLOSED'}</span>
                    </td>
                    <td>
                        <button class="btn btn-small" onclick="event.stopPropagation(); showHealthDetail('${item.serviceName}')">è¯¦æƒ…</button>
                        <button class="btn btn-small" onclick="event.stopPropagation(); triggerHealthCheck('${item.serviceName}')">æ£€æŸ¥</button>
                        ${item.circuitBreakerState === 'OPEN' ? `
                            <button class="btn btn-small" onclick="event.stopPropagation(); resetCircuitBreaker('${item.serviceName}')">é‡ç½®ç†”æ–­</button>
                        ` : ''}
                    </td>
                </tr>
            `;
        }).join('');

        // æ·»åŠ ç‚¹å‡»äº‹ä»¶
        tbody.querySelectorAll('tr[data-service-name]').forEach(row => {
            row.addEventListener('click', () => {
                const serviceName = row.dataset.serviceName;
                showHealthDetail(serviceName);
            });
        });
    }

    // æ›´æ–°å¥åº·ç»Ÿè®¡
    function updateHealthStats(data) {
        const total = data.length;
        const healthy = data.filter(d => d.healthy).length;
        const unhealthy = total - healthy;
        const circuitBreaker = data.filter(d => d.circuitBreakerState === 'OPEN').length;

        document.getElementById('totalServicesCount').textContent = total;
        document.getElementById('healthyServicesCount').textContent = healthy;
        document.getElementById('unhealthyServicesCount').textContent = unhealthy;
        document.getElementById('circuitBreakerServicesCount').textContent = circuitBreaker;
    }

    // æ˜¾ç¤ºå¥åº·è¯¦æƒ…
    async function showHealthDetail(serviceName) {
        try {
            // è·å–å¥åº·çŠ¶æ€
            const healthStatus = await fetchJson(`${baseApiPath}/mcp/health/status/${serviceName}`);

            // è·å–ç†”æ–­å™¨çŠ¶æ€
            let circuitBreaker = null;
            try {
                const breakerResp = await fetchJson(`${baseApiPath}/mcp/health/circuit-breakers/${serviceName}`);
                if (breakerResp && breakerResp.found) {
                    circuitBreaker = breakerResp;
                }
            } catch (e) {
                console.debug('Circuit breaker status not available:', e);
            }

            if (!healthStatus || !healthStatus.found) {
                document.getElementById('healthDetail').innerHTML = '<div class="muted">å¥åº·çŠ¶æ€ä¸å¯ç”¨</div>';
                document.getElementById('healthHistory').innerHTML = '<div class="muted">æ£€æŸ¥å†å²ä¸å¯ç”¨</div>';
                return;
            }

            // æ¸²æŸ“å¥åº·è¯¦æƒ…
            document.getElementById('healthDetail').innerHTML = `
                <div class="service-detail-section">
                    <h4>å¥åº·çŠ¶æ€</h4>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœåŠ¡åç§°</span>
                        <span class="service-detail-value">${serviceName}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">å¥åº·çŠ¶æ€</span>
                        <span class="service-detail-value">
                            <span class="health-indicator ${healthStatus.healthy ? 'healthy' : 'unhealthy'}"></span>
                            ${healthStatus.healthy ? 'å¥åº·' : 'ä¸å¥åº·'}
                        </span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœåŠ¡å™¨ ID</span>
                        <span class="service-detail-value">${healthStatus.serverId || '-'}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æœ€åæ£€æŸ¥æ—¶é—´</span>
                        <span class="service-detail-value">${formatTime(healthStatus.lastCheckTime)}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æˆåŠŸæ¬¡æ•°</span>
                        <span class="service-detail-value">${healthStatus.successCount || 0}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">å¤±è´¥æ¬¡æ•°</span>
                        <span class="service-detail-value">${healthStatus.failureCount || 0}</span>
                    </div>
                    ${circuitBreaker ? `
                    <div class="service-detail-section" style="margin-top: 20px;">
                        <h4>ç†”æ–­å™¨çŠ¶æ€</h4>
                        <div class="service-detail-item">
                            <span class="service-detail-label">çŠ¶æ€</span>
                            <span class="service-detail-value">
                                <span class="circuit-breaker-badge ${circuitBreaker.state?.toLowerCase() || 'closed'}">${circuitBreaker.state || 'CLOSED'}</span>
                            </span>
                        </div>
                        ${circuitBreaker.failureThreshold ? `
                        <div class="service-detail-item">
                            <span class="service-detail-label">å¤±è´¥é˜ˆå€¼</span>
                            <span class="service-detail-value">${circuitBreaker.failureThreshold}</span>
                        </div>
                        ` : ''}
                        ${circuitBreaker.halfOpenAttempts !== undefined ? `
                        <div class="service-detail-item">
                            <span class="service-detail-label">åŠå¼€å°è¯•æ¬¡æ•°</span>
                            <span class="service-detail-value">${circuitBreaker.halfOpenAttempts}</span>
                        </div>
                        ` : ''}
                        <div class="service-detail-item" style="margin-top: 12px;">
                            <button class="btn btn-small" onclick="resetCircuitBreaker('${serviceName}')">é‡ç½®ç†”æ–­å™¨</button>
                            ${circuitBreaker.state === 'OPEN' ? `
                                <button class="btn btn-small" onclick="closeCircuitBreaker('${serviceName}')">å…³é—­ç†”æ–­å™¨</button>
                            ` : `
                                <button class="btn btn-small btn-danger" onclick="openCircuitBreaker('${serviceName}')">æ‰“å¼€ç†”æ–­å™¨</button>
                            `}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            // æ¸²æŸ“æ£€æŸ¥å†å²ï¼ˆç®€åŒ–ç‰ˆï¼Œæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯ï¼‰
            const totalChecks = (healthStatus.successCount || 0) + (healthStatus.failureCount || 0);
            document.getElementById('healthHistory').innerHTML = `
                <div class="service-detail-section">
                    <h4>æ£€æŸ¥ç»Ÿè®¡</h4>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æ€»æ£€æŸ¥æ¬¡æ•°</span>
                        <span class="service-detail-value">${totalChecks}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æˆåŠŸæ¬¡æ•°</span>
                        <span class="service-detail-value" style="color: var(--success);">${healthStatus.successCount || 0}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">å¤±è´¥æ¬¡æ•°</span>
                        <span class="service-detail-value" style="color: var(--error);">${healthStatus.failureCount || 0}</span>
                    </div>
                    <div class="service-detail-item">
                        <span class="service-detail-label">æˆåŠŸç‡</span>
                        <span class="service-detail-value">
                            ${totalChecks > 0 ? ((healthStatus.successCount || 0) / totalChecks * 100).toFixed(1) : 0}%
                        </span>
                    </div>
                </div>
            `;
        } catch (err) {
            console.error(err);
            showError('åŠ è½½å¥åº·è¯¦æƒ…å¤±è´¥: ' + err.message);
        }
    }

    // è§¦å‘å¥åº·æ£€æŸ¥
    async function triggerHealthCheck(serviceName) {
        try {
            const params = new URLSearchParams({ serviceName, serviceGroup: 'mcp-server' });
            const response = await fetch(`${baseApiPath}/mcp/monitor/check?${params}`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess(`å¥åº·æ£€æŸ¥å·²è§¦å‘: ${serviceName}`);
                setTimeout(() => loadHealthMonitor(), 2000); // 2ç§’ååˆ·æ–°
            } else {
                showError('è§¦å‘å¥åº·æ£€æŸ¥å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('è§¦å‘å¥åº·æ£€æŸ¥å¤±è´¥: ' + err.message);
        }
    }

    // è§¦å‘å…¨é‡å¥åº·æ£€æŸ¥
    async function triggerAllHealthCheck() {
        try {
            const response = await fetch(`${baseApiPath}/mcp/monitor/check-all`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess('å…¨é‡å¥åº·æ£€æŸ¥å·²è§¦å‘');
                setTimeout(() => loadHealthMonitor(), 3000); // 3ç§’ååˆ·æ–°
            } else {
                showError('è§¦å‘å…¨é‡å¥åº·æ£€æŸ¥å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('è§¦å‘å…¨é‡å¥åº·æ£€æŸ¥å¤±è´¥: ' + err.message);
        }
    }

    // é‡ç½®ç†”æ–­å™¨
    async function resetCircuitBreaker(serviceName) {
        try {
            const response = await fetch(`${baseApiPath}/mcp/health/circuit-breakers/${serviceName}/reset`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess(`ç†”æ–­å™¨å·²é‡ç½®: ${serviceName}`);
                setTimeout(() => {
                    loadHealthMonitor();
                    showHealthDetail(serviceName);
                }, 1000);
            } else {
                showError('é‡ç½®ç†”æ–­å™¨å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('é‡ç½®ç†”æ–­å™¨å¤±è´¥: ' + err.message);
        }
    }

    // æ‰“å¼€ç†”æ–­å™¨
    async function openCircuitBreaker(serviceName) {
        if (!confirm(`ç¡®å®šè¦æ‰“å¼€ ${serviceName} çš„ç†”æ–­å™¨å—ï¼Ÿè¿™å°†é˜»æ­¢å¯¹è¯¥æœåŠ¡çš„è¯·æ±‚ã€‚`)) {
            return;
        }
        try {
            const response = await fetch(`${baseApiPath}/mcp/health/circuit-breakers/${serviceName}/open`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess(`ç†”æ–­å™¨å·²æ‰“å¼€: ${serviceName}`);
                setTimeout(() => {
                    loadHealthMonitor();
                    showHealthDetail(serviceName);
                }, 1000);
            } else {
                showError('æ‰“å¼€ç†”æ–­å™¨å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('æ‰“å¼€ç†”æ–­å™¨å¤±è´¥: ' + err.message);
        }
    }

    // å…³é—­ç†”æ–­å™¨
    async function closeCircuitBreaker(serviceName) {
        try {
            const response = await fetch(`${baseApiPath}/mcp/health/circuit-breakers/${serviceName}/close`, {
                method: 'POST'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess(`ç†”æ–­å™¨å·²å…³é—­: ${serviceName}`);
                setTimeout(() => {
                    loadHealthMonitor();
                    showHealthDetail(serviceName);
                }, 1000);
            } else {
                showError('å…³é—­ç†”æ–­å™¨å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('å…³é—­ç†”æ–­å™¨å¤±è´¥: ' + err.message);
        }
    }

    // æ¢å¤ç”¨æˆ·è¡Œä¸ºè®°å½•
    function restoreUserBehavior() {
        // æ¢å¤æ ‡ç­¾é¡µé€‰æ‹©
        const savedTab = UserBehaviorStorage.get('activeTab', 'overview');
        const tabButton = document.querySelector(`.tab[data-tab="${savedTab}"]`);
        if (tabButton) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tabButton.classList.add('active');
            const tabContent = document.getElementById(`${savedTab}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
        }

        // æ¢å¤ç­›é€‰æ¡ä»¶
        const sessionSearch = document.getElementById('sessionSearch');
        if (sessionSearch) {
            sessionSearch.value = UserBehaviorStorage.getFilter('sessionSearch', '');
        }
        const transportFilter = document.getElementById('transportFilter');
        if (transportFilter) {
            transportFilter.value = UserBehaviorStorage.getFilter('transportFilter', '');
        }
        const sseServiceFilter = document.getElementById('sseServiceFilter');
        if (sseServiceFilter) {
            sseServiceFilter.value = UserBehaviorStorage.getFilter('sseServiceFilter', '');
        }
        const sseSessionSearch = document.getElementById('sseSessionSearch');
        if (sseSessionSearch) {
            sseSessionSearch.value = UserBehaviorStorage.getFilter('sseSessionSearch', '');
        }
        const restfulServiceFilter = document.getElementById('restfulServiceFilter');
        if (restfulServiceFilter) {
            restfulServiceFilter.value = UserBehaviorStorage.getFilter('restfulServiceFilter', '');
        }
        const restfulMethodFilter = document.getElementById('restfulMethodFilter');
        if (restfulMethodFilter) {
            restfulMethodFilter.value = UserBehaviorStorage.getFilter('restfulMethodFilter', '');
        }
        const restfulHoursFilter = document.getElementById('restfulHoursFilter');
        if (restfulHoursFilter) {
            restfulHoursFilter.value = UserBehaviorStorage.getFilter('restfulHoursFilter', '6');
        }
    }

    // ä¸ºç­›é€‰æ¡ä»¶æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œè®°å½•ç”¨æˆ·è¡Œä¸º
    function setupFilterListeners() {
        // ä¼šè¯ç®¡ç†ç­›é€‰
        const sessionSearch = document.getElementById('sessionSearch');
        if (sessionSearch) {
            sessionSearch.addEventListener('input', (e) => {
                UserBehaviorStorage.saveFilter('sessionSearch', e.target.value);
                UserBehaviorStorage.logAction('filter_change', {
                    filter: 'sessionSearch',
                    value: e.target.value
                });
            });
        }
        const transportFilter = document.getElementById('transportFilter');
        if (transportFilter) {
            transportFilter.addEventListener('change', (e) => {
                UserBehaviorStorage.saveFilter('transportFilter', e.target.value);
                UserBehaviorStorage.logAction('filter_change', {
                    filter: 'transportFilter',
                    value: e.target.value
                });
            });
        }

        // SSE ç­›é€‰
        const sseServiceFilter = document.getElementById('sseServiceFilter');
        if (sseServiceFilter) {
            sseServiceFilter.addEventListener('input', (e) => {
                UserBehaviorStorage.saveFilter('sseServiceFilter', e.target.value);
            });
        }
        const sseSessionSearch = document.getElementById('sseSessionSearch');
        if (sseSessionSearch) {
            sseSessionSearch.addEventListener('input', (e) => {
                UserBehaviorStorage.saveFilter('sseSessionSearch', e.target.value);
            });
        }

        // RESTful ç­›é€‰
        const restfulServiceFilter = document.getElementById('restfulServiceFilter');
        if (restfulServiceFilter) {
            restfulServiceFilter.addEventListener('input', (e) => {
                UserBehaviorStorage.saveFilter('restfulServiceFilter', e.target.value);
                // ç­›é€‰æ¡ä»¶æ”¹å˜æ—¶é‡æ–°åŠ è½½
                loadRestfulRequests(true);
            });
        }
        const restfulMethodFilter = document.getElementById('restfulMethodFilter');
        if (restfulMethodFilter) {
            restfulMethodFilter.addEventListener('change', (e) => {
                UserBehaviorStorage.saveFilter('restfulMethodFilter', e.target.value);
                // ç­›é€‰æ¡ä»¶æ”¹å˜æ—¶é‡æ–°åŠ è½½
                loadRestfulRequests(true);
            });
        }
        const restfulHoursFilter = document.getElementById('restfulHoursFilter');
        if (restfulHoursFilter) {
            restfulHoursFilter.addEventListener('change', (e) => {
                UserBehaviorStorage.saveFilter('restfulHoursFilter', e.target.value);
                UserBehaviorStorage.logAction('time_range_change', {
                    hours: e.target.value
                });
                // ç­›é€‰æ¡ä»¶æ”¹å˜æ—¶é‡æ–°åŠ è½½
                loadRestfulRequests(true);
            });
        }

        // è®¾ç½® RESTful è¯·æ±‚åˆ—è¡¨çš„æ»šåŠ¨ç›‘å¬
        setupRestfulScrollListener();
    }

    // RESTful æ»šåŠ¨ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
    let restfulScrollHandler = null;

    // è®¾ç½® RESTful è¯·æ±‚åˆ—è¡¨çš„æ»šåŠ¨ç›‘å¬ï¼ˆä¸‹æ»‘åŠ è½½æ›´å¤šï¼‰
    function setupRestfulScrollListener() {
        const scrollContainer = document.getElementById('restfulRequestsScrollContainer');
        if (!scrollContainer) {
            console.warn('[RESTfulè¯·æ±‚åˆ—è¡¨] æ»šåŠ¨å®¹å™¨ä¸å­˜åœ¨ï¼Œå»¶è¿Ÿé‡è¯•...');
            // å»¶è¿Ÿé‡è¯•ï¼Œç­‰å¾…DOMæ¸²æŸ“å®Œæˆ
            setTimeout(() => setupRestfulScrollListener(), 100);
            return;
        }

        // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (restfulScrollHandler) {
            scrollContainer.removeEventListener('scroll', restfulScrollHandler);
        }

        // åˆ›å»ºæ–°çš„æ»šåŠ¨ç›‘å¬å™¨ï¼ˆå¸¦é˜²æŠ–ï¼‰
        let scrollTimeout = null;
        restfulScrollHandler = () => {
            // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹è§¦å‘
            if (scrollTimeout) {
                clearTimeout(scrollTimeout);
            }
            scrollTimeout = setTimeout(() => {
                // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨
                const scrollTop = scrollContainer.scrollTop;
                const scrollHeight = scrollContainer.scrollHeight;
                const clientHeight = scrollContainer.clientHeight;
                const distanceToBottom = scrollHeight - scrollTop - clientHeight;
                const hasMore = restfulCurrentPage < restfulTotalPages;
                
                // åªåœ¨æ¥è¿‘åº•éƒ¨æ—¶è¾“å‡ºæ—¥å¿—ï¼ˆå‡å°‘æ—¥å¿—é‡ï¼‰
                if (distanceToBottom < 150) {
                    console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] æ»šåŠ¨äº‹ä»¶:`, {
                        distanceToBottom: Math.round(distanceToBottom),
                        scrollTop: Math.round(scrollTop),
                        scrollHeight,
                        clientHeight,
                        canScroll: scrollHeight > clientHeight,
                        hasMore: hasMore,
                        loadingMore: restfulLoadingMore,
                        currentPage: restfulCurrentPage,
                        totalPages: restfulTotalPages,
                        dataCount: restfulRequestsCache.length
                    });
                }
                
                // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆè·ç¦»åº•éƒ¨100pxæ—¶è§¦å‘ï¼‰
                if (distanceToBottom < 100) {
                    // æ»šåŠ¨åˆ°åº•éƒ¨ï¼ŒåŠ è½½æ›´å¤šæ•°æ®
                    if (!restfulLoadingMore && hasMore) {
                        console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] âœ… è§¦å‘åŠ è½½æ›´å¤šæ•°æ® (å½“å‰é¡µ: ${restfulCurrentPage}/${restfulTotalPages}, è·ç¦»åº•éƒ¨: ${Math.round(distanceToBottom)}px)`);
                        loadRestfulRequests(false);
                    } else if (distanceToBottom < 10) {
                        // åªåœ¨çœŸæ­£åˆ°åº•éƒ¨æ—¶è¾“å‡ºè¯¦ç»†ä¿¡æ¯
                        console.log(`[RESTfulè¯·æ±‚åˆ—è¡¨] âš ï¸ å·²åˆ°åº•éƒ¨ä½†æœªè§¦å‘åŠ è½½:`, {
                            loadingMore: restfulLoadingMore,
                            hasMore: hasMore,
                            currentPage: restfulCurrentPage,
                            totalPages: restfulTotalPages,
                            currentCount: restfulRequestsCache.length,
                            totalCount: restfulTotalCount
                        });
                    }
                }
            }, 100); // å‡å°‘é˜²æŠ–æ—¶é—´ï¼Œæé«˜å“åº”é€Ÿåº¦
        };

        // ç»‘å®šæ»šåŠ¨ç›‘å¬å™¨ï¼ˆå…ˆç§»é™¤æ—§çš„ï¼Œé¿å…é‡å¤ç»‘å®šï¼‰
        if (restfulScrollHandler) {
            scrollContainer.removeEventListener('scroll', restfulScrollHandler);
            console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] ğŸ”„ ç§»é™¤æ—§çš„æ»šåŠ¨ç›‘å¬å™¨');
        }
        scrollContainer.addEventListener('scroll', restfulScrollHandler, { passive: true });
        console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] âœ… æ»šåŠ¨ç›‘å¬å™¨å·²ç»‘å®š');
        
        // æ·»åŠ ä¸€ä¸ªæµ‹è¯•ï¼šæ‰‹åŠ¨è§¦å‘ä¸€æ¬¡æ»šåŠ¨äº‹ä»¶ï¼ŒéªŒè¯ç›‘å¬å™¨æ˜¯å¦å·¥ä½œ
        setTimeout(() => {
            const testEvent = new Event('scroll');
            scrollContainer.dispatchEvent(testEvent);
            console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] ğŸ§ª æµ‹è¯•ï¼šæ‰‹åŠ¨è§¦å‘æ»šåŠ¨äº‹ä»¶');
        }, 500);
        
        // éªŒè¯æ»šåŠ¨å®¹å™¨çŠ¶æ€
        const canScroll = scrollContainer.scrollHeight > scrollContainer.clientHeight;
        console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] æ»šåŠ¨å®¹å™¨çŠ¶æ€:', {
            exists: !!scrollContainer,
            scrollHeight: scrollContainer.scrollHeight,
            clientHeight: scrollContainer.clientHeight,
            canScroll: canScroll,
            maxHeight: window.getComputedStyle(scrollContainer).maxHeight,
            dataCount: restfulRequestsCache.length,
            currentPage: restfulCurrentPage,
            totalPages: restfulTotalPages,
            totalCount: restfulTotalCount
        });

        // å¦‚æœæ•°æ®ä¸è¶³ä»¥æ»šåŠ¨ï¼Œä¸”è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œè‡ªåŠ¨åŠ è½½
        const hasMore = restfulCurrentPage < restfulTotalPages;
        if (!canScroll && restfulRequestsCache.length > 0 && hasMore && !restfulLoadingMore) {
            console.warn('[RESTfulè¯·æ±‚åˆ—è¡¨] âš ï¸ æ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ï¼Œä½†è¿˜æœ‰æ›´å¤šæ•°æ®ï¼Œå°†è‡ªåŠ¨åŠ è½½');
            // å»¶è¿Ÿä¸€ä¸‹ï¼Œé¿å…ç«‹å³è§¦å‘
            setTimeout(() => {
                if (!restfulLoadingMore && restfulCurrentPage < restfulTotalPages) {
                    loadRestfulRequests(false);
                }
            }, 300);
        } else if (!canScroll && restfulRequestsCache.length > 0 && !hasMore) {
            console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] â„¹ï¸ æ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ï¼Œä¸”å·²åŠ è½½å…¨éƒ¨æ•°æ®');
        }
    }

    // æ‰‹åŠ¨æµ‹è¯•æ»šåŠ¨åŠ è½½åŠŸèƒ½ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    window.testRestfulScrollLoad = function() {
        console.log('[RESTfulè¯·æ±‚åˆ—è¡¨] ğŸ”§ æ‰‹åŠ¨æµ‹è¯•æ»šåŠ¨åŠ è½½åŠŸèƒ½');
        const scrollContainer = document.getElementById('restfulRequestsScrollContainer');
        if (!scrollContainer) {
            console.error('âŒ æ»šåŠ¨å®¹å™¨ä¸å­˜åœ¨');
            alert('æ»šåŠ¨å®¹å™¨ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£ç¡®åŠ è½½');
            return;
        }
        
        const scrollTop = scrollContainer.scrollTop;
        const scrollHeight = scrollContainer.scrollHeight;
        const clientHeight = scrollContainer.clientHeight;
        const canScroll = scrollHeight > clientHeight;
        const hasMore = restfulCurrentPage < restfulTotalPages;
        
        console.log('å½“å‰æ»šåŠ¨çŠ¶æ€:', {
            scrollTop,
            scrollHeight,
            clientHeight,
            canScroll,
            distanceToBottom: scrollHeight - scrollTop - clientHeight,
            dataCount: restfulRequestsCache.length,
            currentPage: restfulCurrentPage,
            totalPages: restfulTotalPages,
            totalCount: restfulTotalCount,
            hasMore: hasMore,
            loadingMore: restfulLoadingMore,
            scrollHandlerExists: !!restfulScrollHandler
        });
        
        if (canScroll) {
            // æ»šåŠ¨åˆ°åº•éƒ¨
            scrollContainer.scrollTop = scrollHeight;
            console.log('âœ… å·²æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œåº”è¯¥è§¦å‘åŠ è½½æ›´å¤š');
            setTimeout(() => {
                if (restfulLoadingMore) {
                    console.log('âœ… æ»šåŠ¨åŠ è½½å·²è§¦å‘');
                } else if (!hasMore) {
                    console.log('â„¹ï¸ æ²¡æœ‰æ›´å¤šæ•°æ®å¯åŠ è½½');
                } else {
                    console.warn('âš ï¸ æ»šåŠ¨åŠ è½½æœªè§¦å‘ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—');
                    // æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡
                    console.log('ğŸ”„ æ‰‹åŠ¨è§¦å‘åŠ è½½...');
                    loadRestfulRequests(false);
                }
            }, 500);
        } else {
            console.warn('âš ï¸ æ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ï¼Œæ— æ³•æµ‹è¯•');
            if (hasMore) {
                console.log('ğŸ”„ è‡ªåŠ¨åŠ è½½ä¸‹ä¸€é¡µä»¥äº§ç”Ÿæ»šåŠ¨...');
                loadRestfulRequests(false);
            } else {
                alert(`å½“å‰æ•°æ®ä¸è¶³ä»¥äº§ç”Ÿæ»šåŠ¨ã€‚\n\nè¯·ç¡®ä¿ï¼š\n1. æœ‰è¶…è¿‡${restfulPageSize}æ¡æ•°æ®\n2. æ•°æ®é«˜åº¦è¶…è¿‡å®¹å™¨é«˜åº¦ï¼ˆ600pxï¼‰\n\nå½“å‰æ•°æ®é‡: ${restfulRequestsCache.length}\næ€»è®°å½•æ•°: ${restfulTotalCount}\nå½“å‰é¡µ: ${restfulCurrentPage}/${restfulTotalPages}`);
            }
        }
    }

    // ============================================================================
    // Redis ç®¡ç†åŠŸèƒ½ - ä¸‰çº§è”åŠ¨
    // ============================================================================
    // å£°æ˜å˜é‡ï¼ˆå¿…é¡»åœ¨æ‰€æœ‰ä½¿ç”¨å®ƒçš„ä»£ç ä¹‹å‰ï¼‰
    let selectedInstanceId = null;

    // åˆå§‹åŒ–
    restoreUserBehavior();
    setupFilterListeners();
    loadHealthStatus();

    // æ ¹æ®æ¢å¤çš„æ ‡ç­¾é¡µåŠ è½½å¯¹åº”å†…å®¹
    const activeTab = document.querySelector('.tab.active')?.dataset.tab || 'overview';
    if (activeTab === 'overview') {
        loadOverview();
    } else if (activeTab === 'sse') {
        loadSseDashboard();
    } else if (activeTab === 'restful') {
        loadRestfulRequests(true);
        setupRestfulScrollListener();
    } else if (activeTab === 'streamable') {
        loadStreamableDashboard();
    } else if (activeTab === 'registry') {
        loadNacosServices();
    } else if (activeTab === 'redis') {
        loadRedisInstances();
        loadInstanceFilter();
        loadRedisSessions();
        searchRedisKeys();
    }

    // è‡ªåŠ¨åˆ·æ–°
    setInterval(() => {
        loadHealthStatus();
        const activeTab = document.querySelector('.tab.active')?.dataset.tab;
        if (activeTab === 'overview') {
            loadOverview();
        } else if (activeTab === 'sse') {
            loadSseDashboard();
        } else if (activeTab === 'restful') {
            loadRestfulRequests(true);
            setupRestfulScrollListener();
        } else if (activeTab === 'streamable') {
            loadStreamableDashboard();
        } else if (activeTab === 'redis') {
            loadRedisInstances();
            loadRedisSessions();
            searchRedisKeys();
        }
    }, 30000); // æ¯30ç§’åˆ·æ–°å½“å‰æ ‡ç­¾é¡µ

    // ç¬¬ä¸€çº§ï¼šåŠ è½½æ‰€æœ‰ Instances
    async function loadRedisInstances() {
        try {
            const response = await fetchJson(`${apiBase}/api/redis/instances`);
            const table = document.getElementById('redisInstancesTable');
            const tbody = table.querySelector('tbody');

            if (!response.instances || response.instances.length === 0) {
                tbody.innerHTML = '<tr><td class="muted">æš‚æ—  Instance</td></tr>';
                return;
            }

            const currentSelectedId = selectedInstanceId; // ä¿å­˜å½“å‰é€‰ä¸­çš„ ID
            tbody.innerHTML = response.instances.map(instanceId => {
                const escapedInstanceId = (instanceId || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const escapedSelectedId = (currentSelectedId || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const isSelected = currentSelectedId === instanceId ? 'background: var(--primary); color: white;' : '';
                return `
                <tr style="cursor: pointer; ${isSelected}" onclick="selectInstance('${escapedInstanceId}')" onmouseover="if('${escapedSelectedId}' !== '${escapedInstanceId}') this.style.background='var(--bg)'" onmouseout="if('${escapedSelectedId}' !== '${escapedInstanceId}') this.style.background=''">
                    <td><code style="font-size: 11px;">${escapeHtml(instanceId)}</code></td>
                </tr>
            `;
            }).join('');
        } catch (err) {
            console.error(err);
            const tbody = document.getElementById('redisInstancesTable').querySelector('tbody');
            tbody.innerHTML = `<tr><td class="error">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
    }

    // é€‰æ‹© Instanceï¼ŒåŠ è½½è¯¥ Instance ä¸‹çš„ SessionIds
    async function selectInstance(instanceId) {
        selectedInstanceId = instanceId;
        document.getElementById('selectedInstanceInfo').textContent = `Instance: ${escapeHtml(instanceId)}`;
        document.getElementById('redisSessionDetail').innerHTML = '<span class="muted">è¯·å…ˆé€‰æ‹© SessionId</span>';

        // é‡æ–°æ¸²æŸ“ Instance åˆ—è¡¨ï¼Œé«˜äº®é€‰ä¸­çš„
        loadRedisInstances();

        // åŠ è½½è¯¥ Instance ä¸‹çš„ SessionIds
        try {
            const response = await fetchJson(`${apiBase}/api/redis/instances/${encodeURIComponent(instanceId)}/sessions`);
            const table = document.getElementById('redisSessionIdsTable');
            const tbody = table.querySelector('tbody');

            if (!response.sessionIds || response.sessionIds.length === 0) {
                tbody.innerHTML = '<tr><td class="muted">è¯¥ Instance ä¸‹æš‚æ—  Session</td></tr>';
                return;
            }

            tbody.innerHTML = response.sessionIds.map(sessionId => {
                const escapedSessionId = (sessionId || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <tr style="cursor: pointer;" onclick="selectSessionId('${escapedSessionId}')" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
                    <td><code style="font-size: 11px;">${escapeHtml(sessionId)}</code></td>
                </tr>
            `;
            }).join('');
        } catch (err) {
            console.error('selectInstance error:', err);
            const tbody = document.getElementById('redisSessionIdsTable').querySelector('tbody');
            tbody.innerHTML = `<tr><td class="error">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
    }

    // é€‰æ‹© SessionIdï¼ŒåŠ è½½ Session è¯¦æƒ…
    async function selectSessionId(sessionId) {
        await viewRedisSessionDetail(sessionId, 'redisSessionDetail');
    }

    // åˆ—è¡¨è§†å›¾ï¼šåŠ è½½æ‰€æœ‰ Sessions
    async function loadRedisSessions() {
        // æ¸…ç©ºå³ä¾§è¯¦æƒ…
        const detailElement = document.getElementById('redisSessionDetailList');
        if (detailElement) {
            detailElement.innerHTML = '<span class="muted">é€‰æ‹©å·¦ä¾§ä¼šè¯æŸ¥çœ‹è¯¦æƒ…</span>';
        }
        try {
            const serviceName = document.getElementById('redisServiceFilter')?.value.trim() || null;
            const transportType = document.getElementById('redisTransportFilter')?.value || null;
            const active = document.getElementById('redisActiveFilter')?.value || null;
            const instanceId = document.getElementById('redisInstanceFilter')?.value || null;

            const params = new URLSearchParams();
            if (serviceName) params.append('serviceName', serviceName);
            if (transportType) params.append('transportType', transportType);
            if (active) params.append('active', active);
            if (instanceId) params.append('instanceId', instanceId);

            const response = await fetchJson(`${apiBase}/api/redis/sessions?${params}`);
            const table = document.getElementById('redisSessionsTable');
            const tbody = table.querySelector('tbody');

            if (!response.sessions || response.sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="muted">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = response.sessions.map(session => {
                const sessionId = session.sessionId || '';
                const escapedSessionId = sessionId.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <tr style="cursor: pointer;" onclick="viewRedisSessionDetail('${escapedSessionId}', 'redisSessionDetailList')" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
                    <td><code style="font-size: 11px;">${escapeHtml(sessionId)}</code></td>
                    <td><code style="font-size: 11px;">${escapeHtml(session.instanceId || '')}</code></td>
                    <td>${escapeHtml(session.serviceName || 'æœªç»‘å®š')}</td>
                    <td>${escapeHtml(session.transportType || 'SSE')}</td>
                    <td><span class="badge ${session.active ? 'success' : 'error'}">${session.active ? 'Active' : 'Closed'}</span></td>
                    <td>${formatTime(session.lastActive)}</td>
                </tr>
            `;
            }).join('');
        } catch (err) {
            console.error(err);
            const tbody = document.getElementById('redisSessionsTable').querySelector('tbody');
            tbody.innerHTML = `<tr><td colspan="6" class="error">åŠ è½½å¤±è´¥: ${err.message}</td></tr>`;
        }
    }

    async function viewRedisSessionDetail(sessionId, detailElementId = 'redisSessionDetail') {
        try {
            const encodedSessionId = encodeURIComponent(sessionId);
            const response = await fetchJson(`${apiBase}/api/redis/sessions/${encodedSessionId}/detail`);
            if (!response || !response.session) {
                const detailElement = document.getElementById(detailElementId);
                if (detailElement) {
                    detailElement.innerHTML = '<span class="error">ä¼šè¯ä¸å­˜åœ¨</span>';
                }
                return;
            }
            const session = response.session;
            const rawData = response.rawData;

            const detailHtml = `
                <div style="background: var(--card-bg); padding: 20px; border-radius: 8px; margin-top: 0;">
                    <h4 style="margin-top: 0;">ä¼šè¯è¯¦æƒ…</h4>
                    <div style="margin-bottom: 16px;">
                        <div><strong>Session ID:</strong> <code>${escapeHtml(session.sessionId || '')}</code></div>
                        <div><strong>Instance ID:</strong> <code>${escapeHtml(session.instanceId || '')}</code></div>
                        <div><strong>æœåŠ¡åç§°:</strong> ${escapeHtml(session.serviceName || 'æœªç»‘å®š')}</div>
                        <div><strong>åç«¯ Session ID:</strong> ${escapeHtml(session.backendSessionId || '')}</div>
                        <div><strong>ä¼ è¾“åè®®:</strong> ${escapeHtml(session.transportType || 'SSE')}</div>
                        <div><strong>çŠ¶æ€:</strong> <span class="badge ${session.active ? 'success' : 'error'}">${session.active ? 'Active' : 'Closed'}</span></div>
                        <div><strong>æœ€åæ´»è·ƒ:</strong> ${formatTime(session.lastActive)}</div>
                    </div>
                    <div style="margin-top: 16px;">
                        <button class="btn" style="font-size: 11px; padding: 4px 8px; background: var(--error);" onclick="deleteRedisSession('${escapeHtml(session.sessionId)}')">åˆ é™¤ä¼šè¯</button>
                    </div>
                    ${rawData ? `
                        <h5 style="margin-top: 24px; margin-bottom: 8px;">åŸå§‹æ•°æ®</h5>
                        <pre style="background: var(--bg); padding: 12px; border-radius: 4px; font-size: 11px; overflow-x: auto; max-height: 200px; overflow-y: auto;">${escapeHtml(JSON.stringify(rawData, null, 2))}</pre>
                    ` : ''}
                </div>
            `;
            const detailElement = document.getElementById(detailElementId);
            if (detailElement) {
                detailElement.innerHTML = detailHtml;
            }
        } catch (err) {
            console.error('viewRedisSessionDetail error:', err);
            const detailElement = document.getElementById(detailElementId);
            if (detailElement) {
                detailElement.innerHTML = `<span class="error">åŠ è½½ä¼šè¯è¯¦æƒ…å¤±è´¥: ${escapeHtml(err.message || 'æœªçŸ¥é”™è¯¯')}</span>`;
            }
        }
    }

    async function deleteRedisSession(sessionId) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ä¼šè¯ ${sessionId} å—ï¼Ÿ`)) {
            return;
        }
        try {
            const response = await fetch(`${apiBase}/api/redis/sessions/${sessionId}/delete`, {
                method: 'DELETE'
            });
            const result = await response.json();
            if (result.success) {
                showSuccess('ä¼šè¯åˆ é™¤æˆåŠŸ');
                // åˆ·æ–°æ‰€æœ‰ç›¸å…³åˆ—è¡¨
                if (selectedInstanceId) {
                    selectInstance(selectedInstanceId);
                }
                loadRedisInstances();
                loadRedisSessions();
            } else {
                showError('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error(err);
            showError('åˆ é™¤å¤±è´¥: ' + err.message);
        }
    }

    async function searchRedisKeys() {
        // æ¸…ç©ºå³ä¾§è¯¦æƒ…
        document.getElementById('redisKeyDetail').innerHTML = '<span class="muted">é€‰æ‹©å·¦ä¾§å€¼æŸ¥çœ‹è¯¦æƒ…</span>';
        try {
            const keyName = document.getElementById('redisKeyName')?.value.trim();
            const valuePattern = document.getElementById('redisValuePattern')?.value.trim() || '';

            if (!keyName) {
                const tbody = document.getElementById('redisKeysTable').querySelector('tbody');
                tbody.innerHTML = '<tr><td class="muted">è¯·è¾“å…¥ Redis é”®å</td></tr>';
                return;
            }

            const params = new URLSearchParams();
            params.append('key', keyName);
            if (valuePattern) {
                params.append('valuePattern', valuePattern);
            }
            params.append('limit', '100');

            const response = await fetchJson(`${apiBase}/api/redis/keys?${params}`);
            const table = document.getElementById('redisKeysTable');
            const tbody = table.querySelector('tbody');

            if (!response.keys || response.keys.length === 0) {
                if (response.keyType === 'none') {
                    tbody.innerHTML = '<tr><td class="muted">é”®ä¸å­˜åœ¨</td></tr>';
                } else {
                    tbody.innerHTML = '<tr><td class="muted">æœªæ‰¾åˆ°åŒ¹é…çš„å€¼</td></tr>';
                }
                return;
            }

            // æ˜¾ç¤ºé”®çš„ç±»å‹å’Œç»Ÿè®¡ä¿¡æ¯
            const typeInfo = response.keyType ? `<tr><td colspan="1" style="padding: 8px; background: var(--bg); font-size: 11px; color: var(--text-muted); border-bottom: 1px solid var(--border);">
                é”®å: <code>${escapeHtml(response.key || keyName)}</code> | ç±»å‹: ${escapeHtml(response.keyType)} | æ€»æ•°: ${response.total} | æ˜¾ç¤º: ${response.returned}
            </td></tr>` : '';

            tbody.innerHTML = typeInfo + response.keys.map(value => {
                const escapedKeyName = (keyName || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                // å¯¹äº hash ç±»å‹ï¼Œvalue æ ¼å¼ä¸º field:valueï¼Œç‚¹å‡»æ—¶æ˜¾ç¤ºå®Œæ•´çš„ key è¯¦æƒ…
                return `
                <tr style="cursor: pointer;" onclick="viewRedisKeyDetail('${escapedKeyName}')" onmouseover="this.style.background='var(--bg)'" onmouseout="this.style.background=''">
                    <td><code style="font-size: 11px;">${escapeHtml(value)}</code></td>
                </tr>
            `;
            }).join('');
        } catch (err) {
            console.error(err);
            const tbody = document.getElementById('redisKeysTable').querySelector('tbody');
            tbody.innerHTML = `<tr><td class="error">æœç´¢å¤±è´¥: ${err.message}</td></tr>`;
        }
    }

    async function viewRedisKeyDetail(key) {
        try {
            const encodedKey = encodeURIComponent(key);
            const response = await fetchJson(`${apiBase}/api/redis/keys/${encodedKey}`);
            if (!response) {
                document.getElementById('redisKeyDetail').innerHTML = '<div class="error">åŠ è½½é”®è¯¦æƒ…å¤±è´¥: å“åº”ä¸ºç©º</div>';
                return;
            }
            const detailHtml = `
                <div style="margin-bottom: 16px;">
                    <div style="margin-bottom: 8px;"><strong>é”®å:</strong> <code style="font-size: 11px;">${escapeHtml(response.key || key || '')}</code></div>
                    <div style="margin-bottom: 8px;"><strong>ç±»å‹:</strong> ${escapeHtml(response.type || 'unknown')}</div>
                </div>
                ${response.type === 'set' ? `
                    <div style="margin-top: 16px;">
                        <h5 style="margin-bottom: 8px;">Set æˆå‘˜</h5>
                        ${response.hashData && response.hashData._count ? `
                            <div style="margin-bottom: 8px; color: var(--text-muted); font-size: 12px;">
                                æˆå‘˜æ•°é‡: ${escapeHtml(response.hashData._count)}
                            </div>
                        ` : ''}
                        <ul style="list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto;">
                            ${response.hashData ? Object.entries(response.hashData)
                                .filter(([k]) => !k.startsWith('_'))
                                .map(([k, v]) => `<li style="padding: 4px 0;"><code>${escapeHtml(v)}</code></li>`)
                                .join('') : ''}
                        </ul>
                    </div>
                ` : ''}
                ${response.type === 'string' ? `
                    <div style="margin-top: 16px;">
                        <h5 style="margin-bottom: 8px;">String å€¼</h5>
                        <pre style="background: var(--bg); padding: 12px; border-radius: 4px; font-size: 11px; overflow-x: auto; max-height: 400px; overflow-y: auto;">${escapeHtml(response.hashData?.value || '')}</pre>
                    </div>
                ` : ''}
                ${response.type === 'hash' && response.hashData && Object.keys(response.hashData).length > 0 ? `
                    <div style="margin-top: 16px;">
                        <h5 style="margin-bottom: 8px;">Hash æ•°æ®</h5>
                        <pre style="background: var(--bg); padding: 12px; border-radius: 4px; font-size: 11px; overflow-x: auto; max-height: 400px; overflow-y: auto;">${escapeHtml(JSON.stringify(response.hashData, null, 2))}</pre>
                    </div>
                ` : ''}
                ${response.type === 'none' ? '<div class="muted">é”®ä¸å­˜åœ¨</div>' : ''}
                ${response.type === 'unknown' && (!response.hashData || Object.keys(response.hashData).length === 0) ? '<div class="muted">æ— æ³•è¯»å–æ•°æ®</div>' : ''}
                ${response.type === 'error' ? `
                    <div class="error" style="margin-top: 12px; padding: 12px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 4px;">
                        <strong>é”™è¯¯:</strong> ${escapeHtml(response.hashData?.error || 'æœªçŸ¥é”™è¯¯')}
                    </div>
                ` : ''}
                ${response.hashData && response.hashData._note ? `
                    <div class="muted" style="margin-top: 12px; padding: 12px; background: rgba(156, 163, 175, 0.1); border: 1px solid rgba(156, 163, 175, 0.2); border-radius: 4px;">
                        ${escapeHtml(response.hashData._note)}
                    </div>
                ` : ''}
                <div style="margin-top: 16px;">
                    <button class="btn" style="background: var(--error);" onclick="event.stopPropagation(); deleteRedisKey('${escapeHtml(key)}')">åˆ é™¤é”®</button>
                </div>
            `;
            document.getElementById('redisKeyDetail').innerHTML = detailHtml;
        } catch (err) {
            console.error('viewRedisKeyDetail error:', err);
            const errorMsg = err.message || 'æœªçŸ¥é”™è¯¯';
            let errorText = 'åŠ è½½é”®è¯¦æƒ…å¤±è´¥: ' + errorMsg;
            if (errorMsg.includes('500') || errorMsg.includes('å“åº”ä¸ºç©º') || errorMsg.includes('Failed to fetch')) {
                errorText = 'åŠ è½½é”®è¯¦æƒ…å¤±è´¥: æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·æ£€æŸ¥åç«¯æ—¥å¿—æˆ–ç½‘ç»œè¿æ¥';
            }
            document.getElementById('redisKeyDetail').innerHTML = `<div class="error">${escapeHtml(errorText)}</div>`;
        }
    }

    async function deleteRedisKey(key) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤é”® ${key} å—ï¼Ÿ`)) {
            return;
        }
        try {
            const encodedKey = encodeURIComponent(key);
            const response = await fetch(`${apiBase}/api/redis/keys/${encodedKey}`, {
                method: 'DELETE'
            });
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const result = await response.json();
            if (result.success) {
                showSuccess('é”®åˆ é™¤æˆåŠŸ');
                searchRedisKeys();
            } else {
                showError('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (err) {
            console.error('deleteRedisKey error:', err);
            showError('åˆ é™¤å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
        }
    }

    // è¾…åŠ©å‡½æ•°ï¼šHTML è½¬ä¹‰
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>
