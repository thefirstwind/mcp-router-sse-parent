<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MCP Bridge 控制面板</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        :root {
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "PingFang SC", "Segoe UI", sans-serif;
            background-color: #f5f7fb;
            color: #0f172a;
        }
        body {
            margin: 0;
            padding: 32px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        .card {
            background: #fff;
            border-radius: 14px;
            padding: 20px;
            box-shadow: 0 15px 35px rgba(15,23,42,0.08);
        }
        .split {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        @media(max-width: 1200px) {
            .split { grid-template-columns: 1fr; }
        }
        .sessions-panel { max-height: 80vh; overflow: auto; }
        /* RESTful 页面专用布局：列表更宽，详情更窄 */
        #restful-tab .split {
            grid-template-columns: 1.5fr 1.5fr;
        }
        @media(max-width: 1200px) {
            #restful-tab .split { grid-template-columns: 1fr; }
        }
        .detail-panel > .card { margin-bottom: 0; }
        /* SSE 会话页面的 detail-panel 固定在右侧 */
        #sse-tab .detail-panel {
            position: sticky;
            top: 32px;
            align-self: start;
            max-height: calc(100vh - 64px);
            overflow-y: auto;
        }
        /* 最近路由日志表格容器，允许独立滚动 */
        #sse-tab .detail-panel > .card:last-child {
            max-height: 400px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #sse-tab .detail-panel > .card:last-child > h3 {
            flex-shrink: 0;
            margin-top: 0;
        }
        #sse-tab .detail-panel > .card:last-child > table {
            flex: 1;
            overflow-y: auto;
            display: block;
        }
        #sse-tab .detail-panel > .card:last-child > table thead {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 10;
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }
        #sessionSearch {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 10px;
            min-width: 200px;
        }
        tr.selected { background: #eef2ff; }
        .request-columns {
            display: grid;
            grid-template-columns: minmax(0, 0.95fr) minmax(0, 1.05fr);
            gap: 16px;
            min-height: 360px;
        }
        @media(max-width: 1100px) {
            .request-columns { grid-template-columns: 1fr; }
        }
        .request-list {
            max-height: 360px;
            overflow-y: auto;
        }
        .request-detail {
            border-left: 1px solid #e5e7eb;
            padding-left: 18px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        /* RESTful 页面的 request/response 占满宽度 */
        #restful-tab .request-columns {
            grid-template-columns: 1fr;
        }
        #restful-tab .request-detail {
            border-left: none;
            padding-left: 0;
        }
        .payload-block { display: flex; flex-direction: column; gap: 6px; }
        .payload-header { font-weight: 600; }
        pre {
            background: #0f172a;
            color: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            max-height: 240px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-word;
            margin: 0;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        /* RESTful 页面的 response 区域，完整显示不限制高度 */
        #restful-tab pre {
            max-height: none;
            min-height: 200px;
        }
        .muted {
            color: #6b7280;
            font-size: 13px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        th, td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
            word-break: break-all;
        }
        /* RESTful 请求列表的列宽优化 */
        #restfulRequestsTable th,
        #restfulRequestsTable td {
            padding: 12px 16px;
        }
        #restfulRequestsTable th:nth-child(1),
        #restfulRequestsTable td:nth-child(1) { width: 30%; } /* Server */
        #restfulRequestsTable th:nth-child(2),
        #restfulRequestsTable td:nth-child(2) { width: 40%; } /* Name (Tool) */
        #restfulRequestsTable th:nth-child(3),
        #restfulRequestsTable td:nth-child(3) { width: 15%; } /* Status */
        #restfulRequestsTable th:nth-child(4),
        #restfulRequestsTable td:nth-child(4) { width: 15%; } /* Time */
        .payload-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            color: #6b7280;
        }
        .copy-btn {
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: #fff;
            padding: 2px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .copy-btn.copied {
            border-color: #2563eb;
            color: #2563eb;
        }
        th {
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: .05em;
            font-size: 12px;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid transparent;
        }
        .badge.success {
            background: #ecfdf5;
            color: #047857;
        }
        .badge.fail {
            background: #fef2f2;
            color: #b91c1c;
        }
        .error {
            padding: 12px 16px;
            border-radius: 10px;
            background: #fef2f2;
            color: #b91c1c;
            margin-bottom: 16px;
            border: 1px solid #fecaca;
        }
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #2563eb;
        }
        .tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .filter-bar select,
        .filter-bar input {
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 6px 10px;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div class="header">
    <div>
        <h1 style="margin:0">MCP Bridge 控制面板</h1>
        <div class="muted" id="updatedAt">正在载入...</div>
    </div>
    <div>
        <a id="healthLink" href="/actuator/health" target="_blank" style="text-decoration:none;color:#2563eb;">健康检查</a>
    </div>
</div>

<div id="errorBox" class="error" style="display:none;"></div>

<div class="grid">
    <div class="card">
        <div class="muted">活跃会话</div>
        <div id="sessionCount" style="font-size:32px;font-weight:600;">-</div>
        <div class="muted">当前已注册的 SSE 会话</div>
    </div>
    <div class="card">
        <div class="muted">近 48 小时成功率</div>
        <div id="successRate" style="font-size:32px;font-weight:600;">-</div>
        <div class="muted">基于 routing_logs 统计</div>
    </div>
    <div class="card">
        <div class="muted">服务分布</div>
        <div id="serviceDistribution" style="font-size:14px;"></div>
    </div>
</div>

<div class="tabs">
    <button class="tab active" data-tab="sse">SSE 会话</button>
    <button class="tab" data-tab="restful">RESTful 请求</button>
</div>

<div class="tab-content active" id="sse-tab">
    <div class="split">
        <div class="card sessions-panel">
            <div class="panel-header">
                <div>
                    <h3>会话列表</h3>
                    <div class="muted">点击某条会话查看请求详情</div>
                </div>
            </div>
            <div class="filter-bar" style="margin-bottom: 16px;">
                <input id="sseServiceFilter" placeholder="服务名称（可选）" type="text">
            </div>
            <input id="sessionSearch" placeholder="按 sessionId 筛选" style="margin-bottom: 12px; width: 100%;">
            <table id="sessionsTable">
                <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Service</th>
                    <th>Status</th>
                    <th>Last Active</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="4" class="muted">正在加载...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card detail-panel">
            <div class="card">
                <h3>当前选中会话</h3>
                <div id="currentSessionInfo" class="muted">尚未选择任何会话</div>
            </div>

            <div class="card" style="margin-top:16px;">
                <h3>Session 请求详情</h3>
                <div class="muted" id="sessionLogHint">点击左侧会话以加载请求流水</div>
                <div class="request-columns">
                    <div class="request-list">
                        <table id="sessionLogsTable">
                            <thead>
                            <tr>
                                <th>Method</th>
                                <th>Path</th>
                                <th>Status</th>
                                <th>开始时间</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr><td colspan="4" class="muted">尚未选择会话</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="request-detail">
                        <div class="muted" id="requestDetailHint">选择列表中的请求查看 request / response</div>
                        <div class="payload-block">
                            <div class="payload-toolbar">
                                <div class="payload-header">Request</div>
                                <button class="copy-btn" data-target="requestPayload">复制</button>
                            </div>
                            <pre id="requestPayload"></pre>
                        </div>
                        <div class="payload-block">
                            <div class="payload-toolbar">
                                <div class="payload-header">Response</div>
                                <button class="copy-btn" data-target="responsePayload">复制</button>
                            </div>
                            <pre id="responsePayload"></pre>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:16px;">
                <h3>最近路由日志</h3>
                <table id="logsTable">
                    <thead>
                    <tr>
                        <th>Request ID</th>
                        <th>Session ID</th>
                        <th>Method</th>
                        <th>Server</th>
                        <th>Status</th>
                        <th>Duration</th>
                        <th>Start Time</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr><td colspan="7" class="muted">正在加载...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="restful-tab">
    <div class="split">
        <div class="card sessions-panel">
            <div class="panel-header">
                <div>
                    <h3>RESTful 请求列表</h3>
                    <div class="muted">点击某条请求查看详情</div>
                </div>
            </div>
            <div class="filter-bar">
                <input id="restfulServiceFilter" placeholder="服务名称（可选）" type="text">
                <select id="restfulMcpMethodFilter">
                    <option value="">所有 MCP 方法</option>
                    <option value="tools/call">tools/call</option>
                    <option value="tools/list">tools/list</option>
                    <option value="resources/list">resources/list</option>
                    <option value="resources/read">resources/read</option>
                    <option value="prompts/list">prompts/list</option>
                    <option value="prompts/get">prompts/get</option>
                    <option value="initialize">initialize</option>
                </select>
                <select id="restfulSessionIdFilter">
                    <option value="">所有请求</option>
                    <option value="true">有 SessionId</option>
                    <option value="false">无 SessionId</option>
                </select>
                <select id="restfulHoursFilter">
                    <option value="1">最近 1 小时</option>
                    <option value="6">最近 6 小时</option>
                    <option value="24">最近 24 小时</option>
                    <option value="48">最近 48 小时</option>
                </select>
                <button class="copy-btn" onclick="loadRestfulRequests()" style="padding: 6px 16px;">刷新</button>
            </div>
            <table id="restfulRequestsTable">
                <thead>
                <tr>
                    <th>Server</th>
                    <th>Name</th>
                    <th>Status</th>
                    <th>Time</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="4" class="muted">正在加载...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card detail-panel">
            <div class="card">
                <h3>请求详情</h3>
                <div id="restfulRequestInfo" class="muted">点击左侧请求查看详情</div>
            </div>

            <div class="card" style="margin-top:16px;">
                <h3>Request / Response</h3>
                <div class="muted" id="restfulRequestDetailHint">选择列表中的请求查看 request / response</div>
                <div class="request-detail">
                    <div class="payload-block">
                        <div class="payload-toolbar">
                            <div class="payload-header">Request</div>
                            <button class="copy-btn" id="copyRestfulRequestPayload">复制</button>
                        </div>
                        <pre id="restfulRequestPayload"></pre>
                    </div>
                    <div class="payload-block">
                        <div class="payload-toolbar">
                            <div class="payload-header">Response</div>
                            <button class="copy-btn" id="copyRestfulResponsePayload">复制</button>
                        </div>
                        <pre id="restfulResponsePayload"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const adminBasePath = (() => {
        const match = window.location.pathname.match(/^(.*)\/admin/);
        return match ? match[1] : '';
    })();
    const apiBase = `${adminBasePath}/admin`;
    const healthLink = document.getElementById('healthLink');
    if (healthLink) {
        healthLink.href = `${adminBasePath || ''}/actuator/health`;
    }

    let sessionCache = [];

    async function fetchJson(url) {
        const resp = await fetch(url);
        if (!resp.ok) {
            throw new Error(`请求 ${url} 失败: ${resp.status}`);
        }
        return resp.json();
    }

    function showError(message) {
        const box = document.getElementById('errorBox');
        box.textContent = message;
        box.style.display = 'block';
    }

    function clearError() {
        document.getElementById('errorBox').style.display = 'none';
    }

    function formatTime(value) {
        if (!value) {
            return 'N/A';
        }
        let date;
        if (Array.isArray(value)) {
            const [year, month = 1, day = 1, hour = 0, minute = 0, second = 0, nano = 0] = value;
            date = new Date(year, month - 1, day, hour, minute, second, Math.floor(nano / 1_000_000));
        } else {
            date = new Date(value);
        }
        if (Number.isNaN(date.getTime())) {
            return value;
        }
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    function attachPayloadCopyHandlers() {
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const target = document.getElementById(btn.dataset.target);
                if (target && navigator.clipboard) {
                    navigator.clipboard.writeText(target.textContent || '').then(() => {
                        btn.classList.add('copied');
                        btn.textContent = '已复制';
                        setTimeout(() => {
                            btn.classList.remove('copied');
                            btn.textContent = '复制';
                        }, 1500);
                    });
                }
            });
        });
    }

    function renderSummary(summary) {
        document.getElementById('sessionCount').textContent = summary.sessionCount ?? 0;
        document.getElementById('successRate').textContent = `${(summary.successRate ?? 0).toFixed(2)}%`;
        document.getElementById('updatedAt').textContent = `更新于：${formatTime(summary.generatedAt)}`;
    }

    function updateServiceDistribution(sessions) {
        if (!sessions || sessions.length === 0) {
            document.getElementById('serviceDistribution').textContent = '暂无数据';
            return;
        }
        const map = {};
        sessions.forEach(s => {
            const key = s.serviceName ?? '未绑定';
            const bucket = map[key] || { total: 0, active: 0 };
            bucket.total++;
            if (s.active) bucket.active++;
            map[key] = bucket;
        });
        const desc = Object.entries(map)
            .map(([service, stats]) => `${service}: ${stats.active}/${stats.total} active`)
            .join(' | ');
        document.getElementById('serviceDistribution').textContent = desc;
    }

    function selectSessionRow(sessionId) {
        document.querySelectorAll('#sessionsTable tbody tr').forEach(row => {
            row.classList.toggle('selected', row.dataset.sessionId === sessionId);
        });
    }

    function renderSessions(sessions) {
        sessionCache = sessions || [];
        // 不再在前端进行 sessionId 筛选，因为已经在后端完成
        const filtered = sessionCache;

        const tbody = document.querySelector('#sessionsTable tbody');
        if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">没有匹配的会话</td></tr>';
            return;
        }
        tbody.innerHTML = filtered.map(s => `
            <tr data-session-id="${s.sessionId}">
                <td>${s.sessionId}</td>
                <td>${s.serviceName ?? '未绑定'}</td>
                <td><span class="badge ${s.active ? 'success' : ''}">${s.active ? 'Active' : 'Closed'}</span></td>
                <td>${formatTime(s.lastActive)}</td>
            </tr>
        `).join('');

        tbody.querySelectorAll('tr[data-session-id]').forEach(row => {
            row.addEventListener('click', () => {
                const sessionId = row.dataset.sessionId;
                selectSessionRow(sessionId);
                highlightSessionInfo(sessionId);
                loadSessionLogs(sessionId);
            });
        });
    }

    function highlightSessionInfo(sessionId) {
        const session = sessionCache.find(s => s.sessionId === sessionId);
        if (!session) {
            document.getElementById('currentSessionInfo').textContent = '无法找到该会话';
            return;
        }
        document.getElementById('currentSessionInfo').innerHTML = `
            <div><strong>Session:</strong> ${session.sessionId}</div>
            <div><strong>Service:</strong> ${session.serviceName ?? '未绑定'}</div>
            <div><strong>Last Active:</strong> ${formatTime(session.lastActive)}</div>
        `;
    }

    function renderLogs(logs) {
        const tbody = document.querySelector('#logsTable tbody');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="muted">暂无日志</td></tr>';
            return;
        }
        tbody.innerHTML = logs.map(log => `
            <tr data-session-id="${log.sessionId || ''}" data-request-id="${log.requestId || ''}" style="cursor: pointer;">
                <td>${log.requestId ?? '-'}</td>
                <td>${log.sessionId ?? '-'}</td>
                <td>${log.mcpMethod ?? '-'}</td>
                <td>${log.serverName ?? '-'}</td>
                <td><span class="badge ${log.success ? 'success' : 'fail'}">${log.success ? 'SUCCESS' : 'FAILED'}</span></td>
                <td>${log.duration ?? '-'} ms</td>
                <td>${formatTime(log.startTime)}</td>
            </tr>
        `).join('');

        // 为每一行添加点击事件
        tbody.querySelectorAll('tr[data-session-id]').forEach(row => {
            row.addEventListener('click', () => {
                const sessionId = row.dataset.sessionId;
                if (sessionId && sessionId !== '-') {
                    // 加载该 session 的请求详情
                    loadSessionLogs(sessionId);
                    // 同时选中对应的会话行（如果存在）
                    selectSessionRow(sessionId);
                    highlightSessionInfo(sessionId);
                }
            });
        });
    }

    function renderSessionRequests(logs) {
        const tbody = document.querySelector('#sessionLogsTable tbody');
        if (!logs || logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">暂无请求</td></tr>';
            return;
        }
        tbody.innerHTML = logs.map(log => `
            <tr data-request-id="${log.requestId}">
                <td>${log.mcpMethod ?? '-'}</td>
                <td>${log.path ?? '-'}</td>
                <td>${log.responseStatus ?? '-'}</td>
                <td>${formatTime(log.startTime)}</td>
            </tr>
        `).join('');
        tbody.querySelectorAll('tr[data-request-id]').forEach((row, index) => {
            row.addEventListener('click', () => {
                selectRequestRow(row.dataset.requestId);
                showRequestDetail(logs[index]);
            });
        });
    }

    function selectRequestRow(requestId) {
        document.querySelectorAll('#sessionLogsTable tbody tr').forEach(row => {
            row.classList.toggle('selected', row.dataset.requestId === requestId);
        });
    }

    function showRequestDetail(log) {
        if (!log) {
            document.getElementById('requestDetailHint').textContent = '选择列表中的请求查看详情';
            document.getElementById('requestPayload').textContent = '';
            document.getElementById('responsePayload').textContent = '';
            return;
        }
        document.getElementById('requestDetailHint').textContent =
            `${log.method ?? '-'} ${log.path ?? ''} → ${log.responseStatus ?? '-'} | ${formatTime(log.startTime)}`;
        document.getElementById('requestPayload').textContent = log.requestBody ?? '';
        document.getElementById('responsePayload').textContent = log.responseBody ?? '';
    }

    async function loadSessionLogs(sessionId) {
        if (!sessionId) { return; }
        document.getElementById('sessionLogHint').textContent = `正在加载 ${sessionId} 的请求...`;
        const tbody = document.querySelector('#sessionLogsTable tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="muted">加载中...</td></tr>';
        try {
            const logs = await fetchJson(`${apiBase}/api/sessions/${sessionId}/logs`);
            renderSessionRequests(logs);
            document.getElementById('sessionLogHint').textContent = `当前 Session：${sessionId}`;
            if (logs && logs.length > 0) {
                showRequestDetail(logs[0]);
                selectRequestRow(logs[0].requestId);
            } else {
                showRequestDetail(null);
            }
        } catch (err) {
            console.error(err);
            document.getElementById('sessionLogHint').textContent = `加载失败：${err.message}`;
            tbody.innerHTML = '<tr><td colspan="4" class="muted">加载失败</td></tr>';
        }
    }

    async function loadDashboard() {
        try {
            clearError();
            const serviceName = document.getElementById('sseServiceFilter')?.value.trim() || null;
            const sessionId = document.getElementById('sessionSearch')?.value.trim() || null;

            const params = new URLSearchParams();
            if (serviceName) {
                params.append('serviceName', serviceName);
            }
            params.append('hours', '48'); // 路由日志默认 48 小时

            const sessionParams = new URLSearchParams();
            if (serviceName) {
                sessionParams.append('serviceName', serviceName);
            }
            // 当有 sessionId 筛选时，不传递 hours 参数（后端会查询所有时间）
            if (sessionId) {
                sessionParams.append('sessionId', sessionId);
            }

            const [summary, sessions, logs] = await Promise.all([
                fetchJson(`${apiBase}/api/summary`),
                fetchJson(`${apiBase}/api/sessions?${sessionParams}`),
                fetchJson(`${apiBase}/api/logs?${params}`),
            ]);
            renderSummary(summary);
            renderSessions(sessions);
            updateServiceDistribution(sessions);
            renderLogs(logs);
        } catch (err) {
            console.error(err);
            showError(err.message || '仪表盘数据加载失败');
        }
    }

    // SSE 会话页面的加载函数（与 loadDashboard 相同，但更明确）
    function loadSseDashboard() {
        loadDashboard();
    }

    // 标签页切换
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.dataset.tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(`${targetTab}-tab`).classList.add('active');

            if (targetTab === 'restful') {
                loadRestfulRequests();
            } else if (targetTab === 'sse') {
                loadSseDashboard();
            }
        });
    });

    // RESTful 请求相关函数
    let restfulRequestsCache = [];

    async function loadRestfulRequests() {
        const serviceName = document.getElementById('restfulServiceFilter').value.trim() || null;
        const mcpMethod = document.getElementById('restfulMcpMethodFilter').value || null;
        const hasSessionId = document.getElementById('restfulSessionIdFilter').value || null;
        const hours = parseInt(document.getElementById('restfulHoursFilter').value);

        const tbody = document.querySelector('#restfulRequestsTable tbody');
        tbody.innerHTML = '<tr><td colspan="4" class="muted">正在加载...</td></tr>';

        try {
            const params = new URLSearchParams({
                hours: hours,
                limit: 100
            });
            if (serviceName) {
                params.append('serviceName', serviceName);
            }
            if (mcpMethod) {
                params.append('mcpMethod', mcpMethod);
            }
            if (hasSessionId) {
                params.append('hasSessionId', hasSessionId);
            }

            const requests = await fetchJson(`${apiBase}/api/restful-requests?${params}`);
            restfulRequestsCache = requests || [];
            renderRestfulRequests(restfulRequestsCache);
        } catch (err) {
            console.error(err);
            tbody.innerHTML = '<tr><td colspan="4" class="muted">加载失败: ' + err.message + '</td></tr>';
        }
    }

    function renderRestfulRequests(requests) {
        const tbody = document.querySelector('#restfulRequestsTable tbody');
        if (!requests || requests.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="muted">暂无数据</td></tr>';
            return;
        }
        tbody.innerHTML = requests.map(req => {
            // 处理 toolName（可能为空字符串）
            const hasToolName = req.toolName && req.toolName.trim() !== '';

            // 显示 Name：优先显示 toolName，其次显示 mcpMethod
            let displayName = '-';
            if (hasToolName) {
                displayName = req.toolName;
            } else if (req.mcpMethod) {
                displayName = req.mcpMethod;
            } else {
                displayName = '-';
            }

            return `
            <tr data-request-id="${req.requestId}">
                <td>${req.serverName ?? '-'}</td>
                <td>${displayName}</td>
                <td>
                    <span class="badge ${req.success ? 'success' : 'fail'}">
                        ${req.responseStatus ?? '-'}
                    </span>
                </td>
                <td>${formatTime(req.startTime)}</td>
            </tr>
        `;
        }).join('');

        tbody.querySelectorAll('tr[data-request-id]').forEach((row, index) => {
            row.addEventListener('click', () => {
                selectRestfulRequestRow(row.dataset.requestId);
                showRestfulRequestDetail(requests[index]);
            });
        });
    }

    function selectRestfulRequestRow(requestId) {
        document.querySelectorAll('#restfulRequestsTable tbody tr').forEach(row => {
            row.classList.toggle('selected', row.dataset.requestId === requestId);
        });
    }

    async function showRestfulRequestDetail(request) {
        if (!request) {
            document.getElementById('restfulRequestInfo').textContent = '无法找到该请求';
            document.getElementById('restfulRequestPayload').textContent = '';
            document.getElementById('restfulResponsePayload').textContent = '';
            return;
        }

        document.getElementById('restfulRequestInfo').innerHTML = `
            <div><strong>Request ID:</strong> ${request.requestId}</div>
            <div><strong>Path:</strong> ${request.path ?? '-'}</div>
            <div><strong>Server:</strong> ${request.serverName ?? '-'}</div>
            <div><strong>MCP Method:</strong> ${request.mcpMethod ?? '-'}</div>
            <div><strong>Tool:</strong> ${request.toolName ?? '-'}</div>
            <div><strong>Status:</strong> ${request.responseStatus ?? '-'} | Duration: ${request.duration ?? '-'} ms</div>
            <div><strong>Time:</strong> ${formatTime(request.startTime)}</div>
            <div><strong>Client IP:</strong> ${request.clientIp ?? '-'}</div>
        `;

        try {
            const detail = await fetchJson(`${apiBase}/api/restful-requests/${request.requestId}`);
            if (detail) {
                document.getElementById('restfulRequestDetailHint').textContent =
                    `${detail.method ?? '-'} ${detail.path ?? ''} → ${detail.responseStatus ?? '-'} | ${formatTime(detail.startTime)}`;
                document.getElementById('restfulRequestPayload').textContent = detail.requestBody ?? '';
                document.getElementById('restfulResponsePayload').textContent = detail.responseBody ?? '';
            } else {
                document.getElementById('restfulRequestPayload').textContent = '';
                document.getElementById('restfulResponsePayload').textContent = '';
            }
        } catch (err) {
            console.error('Failed to load request detail:', err);
            document.getElementById('restfulRequestPayload').textContent = '';
            document.getElementById('restfulResponsePayload').textContent = '';
        }
    }

    // 绑定 RESTful 请求筛选器事件
    document.getElementById('restfulMcpMethodFilter').addEventListener('change', loadRestfulRequests);
    document.getElementById('restfulSessionIdFilter').addEventListener('change', loadRestfulRequests);
    document.getElementById('restfulHoursFilter').addEventListener('change', loadRestfulRequests);
    document.getElementById('restfulServiceFilter').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loadRestfulRequests();
        }
    });

    // 绑定 RESTful 请求的复制按钮
    document.getElementById('copyRestfulRequestPayload').addEventListener('click', () => {
        copyToClipboard('restfulRequestPayload', 'copyRestfulRequestPayload');
    });
    document.getElementById('copyRestfulResponsePayload').addEventListener('click', () => {
        copyToClipboard('restfulResponsePayload', 'copyRestfulResponsePayload');
    });

    // 绑定 SSE 会话页面的筛选器事件
    const sseServiceFilter = document.getElementById('sseServiceFilter');
    if (sseServiceFilter) {
        sseServiceFilter.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadSseDashboard();
            }
        });
    }

    // 当输入 sessionId 时，调用后端 API 重新加载数据（查询所有时间）
    document.getElementById('sessionSearch').addEventListener('input', () => {
        // 使用防抖，避免频繁请求
        clearTimeout(window.sessionSearchTimeout);
        window.sessionSearchTimeout = setTimeout(() => {
            loadDashboard();
        }, 300);
    });
    attachPayloadCopyHandlers();
    loadDashboard();
    setInterval(loadDashboard, 15000);
</script>
</body>
</html>

