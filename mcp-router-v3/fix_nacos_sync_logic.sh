#!/bin/bash

# =========================================================
# MCP Router V3 - Nacos åŒæ­¥é€»è¾‘ä¿®å¤è„šæœ¬
# =========================================================
# é—®é¢˜: å¯åŠ¨æ—¶ä»Ž Nacos åŒæ­¥æ•°æ®ä¼šé‡ç½® last_health_check
# ä¿®å¤: åœ¨ UPDATE æ—¶ä¸æ›´æ–° last_health_checkï¼Œä¿ç•™å®žé™…æ£€æŸ¥æ—¶é—´
# =========================================================

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®
MAPPER_FILE="src/main/resources/mapper/McpServerMapper.xml"
BACKUP_FILE="${MAPPER_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                          â•‘"
echo "â•‘              MCP Router V3 - Nacos åŒæ­¥é€»è¾‘ä¿®å¤                           â•‘"
echo "â•‘                                                                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# =========================================================
# 1. æ£€æŸ¥æ–‡ä»¶
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 1: æ£€æŸ¥æ–‡ä»¶${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if [ ! -f "$MAPPER_FILE" ]; then
    echo -e "${RED}âŒ æ–‡ä»¶ä¸å­˜åœ¨: $MAPPER_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… æ‰¾åˆ°æ–‡ä»¶: $MAPPER_FILE${NC}"
echo ""

# =========================================================
# 2. å¤‡ä»½æ–‡ä»¶
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 2: å¤‡ä»½åŽŸæ–‡ä»¶${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

cp "$MAPPER_FILE" "$BACKUP_FILE"
echo -e "${GREEN}âœ… å¤‡ä»½å®Œæˆ: $BACKUP_FILE${NC}"
backup_size=$(ls -lh "$BACKUP_FILE" | awk '{print $5}')
echo -e "   æ–‡ä»¶å¤§å°: ${backup_size}"
echo ""

# =========================================================
# 3. æ£€æŸ¥å½“å‰çŠ¶æ€
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 3: æ£€æŸ¥å½“å‰çŠ¶æ€${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

if grep -q "last_health_check = VALUES(last_health_check)" "$MAPPER_FILE"; then
    echo -e "${YELLOW}âš ï¸  å‘çŽ°é—®é¢˜ï¼šlast_health_check = VALUES(last_health_check)${NC}"
    echo ""
    echo "   é—®é¢˜ä»£ç ï¼š"
    grep -n "last_health_check = VALUES(last_health_check)" "$MAPPER_FILE" | sed 's/^/     /'
    echo ""
else
    echo -e "${GREEN}âœ… æœªå‘çŽ°é—®é¢˜ï¼Œå¯èƒ½å·²ç»ä¿®å¤${NC}"
    echo ""
    read -p "æ˜¯å¦ç»§ç»­ï¼Ÿ(y/N) " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "å–æ¶ˆæ“ä½œ"
        exit 0
    fi
fi

# =========================================================
# 4. åº”ç”¨ä¿®å¤
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 4: åº”ç”¨ä¿®å¤${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ä½¿ç”¨ sed æ³¨é‡ŠæŽ‰é—®é¢˜è¡Œ
if [[ "$OSTYPE" == "darwin"* ]]; then
    # macOS
    sed -i '' 's/^[[:space:]]*last_health_check = VALUES(last_health_check),/            -- last_health_check = VALUES(last_health_check),  -- âŒ ä¿®å¤: å¯åŠ¨æ—¶ä¸æ›´æ–°å¥åº·æ£€æŸ¥æ—¶é—´/' "$MAPPER_FILE"
else
    # Linux
    sed -i 's/^[[:space:]]*last_health_check = VALUES(last_health_check),/            -- last_health_check = VALUES(last_health_check),  -- âŒ ä¿®å¤: å¯åŠ¨æ—¶ä¸æ›´æ–°å¥åº·æ£€æŸ¥æ—¶é—´/' "$MAPPER_FILE"
fi

echo -e "${GREEN}âœ… ä¿®å¤å®Œæˆ${NC}"
echo ""

# =========================================================
# 5. éªŒè¯ä¿®å¤
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 5: éªŒè¯ä¿®å¤${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo "ä¿®å¤åŽçš„ä»£ç ï¼š"
echo ""
grep -A 5 -B 5 "last_health_check" "$MAPPER_FILE" | grep -A 5 -B 5 "ON DUPLICATE KEY UPDATE" | tail -20 | sed 's/^/   /'
echo ""

if grep -q "-- last_health_check = VALUES(last_health_check)" "$MAPPER_FILE"; then
    echo -e "${GREEN}âœ… éªŒè¯æˆåŠŸï¼šé—®é¢˜è¡Œå·²è¢«æ³¨é‡Š${NC}"
else
    echo -e "${RED}âŒ éªŒè¯å¤±è´¥ï¼šä¿®å¤å¯èƒ½ä¸å®Œæ•´${NC}"
    exit 1
fi
echo ""

# =========================================================
# 6. ç¼–è¯‘æµ‹è¯•
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 6: ç¼–è¯‘æµ‹è¯•${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo "æ­£åœ¨ç¼–è¯‘..."
if mvn clean compile -DskipTests > /tmp/mvn_compile.log 2>&1; then
    echo -e "${GREEN}âœ… ç¼–è¯‘æˆåŠŸ${NC}"
else
    echo -e "${RED}âŒ ç¼–è¯‘å¤±è´¥${NC}"
    echo ""
    echo "é”™è¯¯æ—¥å¿—ï¼š"
    tail -50 /tmp/mvn_compile.log | sed 's/^/   /'
    echo ""
    echo -e "${YELLOW}âš ï¸  æ­£åœ¨æ¢å¤å¤‡ä»½...${NC}"
    cp "$BACKUP_FILE" "$MAPPER_FILE"
    echo -e "${GREEN}âœ… å·²æ¢å¤å¤‡ä»½${NC}"
    exit 1
fi
echo ""

# =========================================================
# 7. ç”Ÿæˆä¿®å¤æŠ¥å‘Š
# =========================================================
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“ æ­¥éª¤ 7: ç”Ÿæˆä¿®å¤æŠ¥å‘Š${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

cat > NACOS_SYNC_FIX_REPORT.md << 'EOF'
# Nacos åŒæ­¥é€»è¾‘ä¿®å¤æŠ¥å‘Š

**æ—¥æœŸ**: $(date +"%Y-%m-%d %H:%M:%S")  
**çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆ

---

## ðŸŽ¯ ä¿®å¤å†…å®¹

### é—®é¢˜
å¯åŠ¨æ—¶ä»Ž Nacos åŒæ­¥æœåŠ¡åˆ°æ•°æ®åº“ä¼šé‡ç½® `last_health_check` å­—æ®µï¼Œå¯¼è‡´ï¼š
- å·²åœæ­¢æœåŠ¡çš„å¥åº·æ£€æŸ¥æ—¶é—´è¢«é‡ç½®
- è¶…æ—¶æ£€æŸ¥æœºåˆ¶å¤±æ•ˆ
- æ•°æ®åº“çŠ¶æ€ä¸å‡†ç¡®

### ä¿®å¤
ä¿®æ”¹ `McpServerMapper.xml` ä¸­çš„ `insertOrUpdate` SQLï¼š
- **åˆ é™¤**: `last_health_check = VALUES(last_health_check)`
- **æ•ˆæžœ**: UPDATE æ—¶ä¿ç•™åŽŸæœ‰çš„ `last_health_check` å€¼

### ä¿®æ”¹æ–‡ä»¶
- `src/main/resources/mapper/McpServerMapper.xml`

### å¤‡ä»½æ–‡ä»¶
- å¤‡ä»½ä¿å­˜åœ¨åŒç›®å½•ä¸‹ï¼Œä»¥ `.backup.YYYYMMDD_HHMMSS` ç»“å°¾

---

## ðŸ“Š ä¿®å¤æ•ˆæžœ

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤åŽ |
|------|--------|--------|
| æ–°æœåŠ¡æ³¨å†Œ | last_health_check = å¯åŠ¨æ—¶é—´ | last_health_check = å¯åŠ¨æ—¶é—´ |
| å·²å­˜åœ¨æœåŠ¡ï¼ˆè¿è¡Œä¸­ï¼‰ | last_health_check è¢«é‡ç½® | last_health_check **ä¿ç•™** âœ… |
| å·²å­˜åœ¨æœåŠ¡ï¼ˆå·²åœæ­¢ï¼‰ | last_health_check è¢«é‡ç½® | last_health_check **ä¿ç•™** âœ… |
| è¶…æ—¶æ£€æŸ¥ | å¯èƒ½å¤±æ•ˆ | **æ­£å¸¸å·¥ä½œ** âœ… |

---

## ðŸ§ª éªŒè¯æ­¥éª¤

### 1. åˆ›å»ºæµ‹è¯•æ•°æ®

```sql
INSERT INTO mcp_servers (server_key, server_name, server_group, host, port, 
    healthy, enabled, last_health_check, registered_at)
VALUES ('test-sync-fix@127.0.0.1:9999', 'test-sync-fix', 'mcp-server', 
    '127.0.0.1', 9999, 1, 1, 
    DATE_SUB(NOW(), INTERVAL 2 HOUR), NOW());
```

### 2. è®°å½•æ—¶é—´

```sql
SELECT server_key, last_health_check 
FROM mcp_servers 
WHERE server_key = 'test-sync-fix@127.0.0.1:9999';
```

### 3. é‡å¯åº”ç”¨

```bash
./restart.sh
```

### 4. éªŒè¯ç»“æžœ

```sql
SELECT server_key, last_health_check 
FROM mcp_servers 
WHERE server_key = 'test-sync-fix@127.0.0.1:9999';
```

**é¢„æœŸ**: `last_health_check` åº”è¯¥ä¿æŒä¸å˜ï¼ˆ2 å°æ—¶å‰ï¼‰

---

## ðŸ“ å›žæ»šæ–¹æ³•

å¦‚æžœéœ€è¦å›žæ»šï¼š

```bash
# æ‰¾åˆ°å¤‡ä»½æ–‡ä»¶
ls -lt src/main/resources/mapper/McpServerMapper.xml.backup.*

# æ¢å¤
cp src/main/resources/mapper/McpServerMapper.xml.backup.YYYYMMDD_HHMMSS \\
   src/main/resources/mapper/McpServerMapper.xml

# é‡æ–°ç¼–è¯‘
mvn clean compile -DskipTests
```

---

## âœ… ä¸‹ä¸€æ­¥

1. é‡æ–°æ‰“åŒ…åº”ç”¨
2. é‡å¯åº”ç”¨
3. éªŒè¯ä¿®å¤æ•ˆæžœ
4. ç›‘æŽ§æ—¥å¿—

---

**ä¿®å¤å®Œæˆæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
EOF

# æ›¿æ¢æ—¥æœŸå ä½ç¬¦
sed -i.tmp "s/\$(date +\"%Y-%m-%d %H:%M:%S\")/$(date +"%Y-%m-%d %H:%M:%S")/g" NACOS_SYNC_FIX_REPORT.md
rm -f NACOS_SYNC_FIX_REPORT.md.tmp

echo -e "${GREEN}âœ… ä¿®å¤æŠ¥å‘Šå·²ç”Ÿæˆ: NACOS_SYNC_FIX_REPORT.md${NC}"
echo ""

# =========================================================
# 8. å®Œæˆæ€»ç»“
# =========================================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                          â•‘"
echo "â•‘                          âœ… ä¿®å¤å®Œæˆ                                      â•‘"
echo "â•‘                                                                          â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}ðŸ“Š ä¿®å¤æ€»ç»“${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "   âœ… 1. æ–‡ä»¶å·²å¤‡ä»½: $BACKUP_FILE"
echo "   âœ… 2. SQL å·²ä¿®å¤: æ³¨é‡Šäº† last_health_check æ›´æ–°"
echo "   âœ… 3. ç¼–è¯‘é€šè¿‡: æ— è¯­æ³•é”™è¯¯"
echo "   âœ… 4. æŠ¥å‘Šç”Ÿæˆ: NACOS_SYNC_FIX_REPORT.md"
echo ""
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${YELLOW}ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ${NC}"
echo -e "${YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "   1. é‡æ–°æ‰“åŒ…: mvn clean package -DskipTests"
echo "   2. é‡å¯åº”ç”¨: ./restart.sh"
echo "   3. æŸ¥çœ‹æŠ¥å‘Š: cat NACOS_SYNC_FIX_REPORT.md"
echo "   4. éªŒè¯ä¿®å¤: æŒ‰ç…§æŠ¥å‘Šä¸­çš„éªŒè¯æ­¥éª¤æµ‹è¯•"
echo ""
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“š ç›¸å…³æ–‡æ¡£${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "   - é—®é¢˜åˆ†æž: cat NACOS_SYNC_LOGIC_ANALYSIS.md"
echo "   - ä¿®å¤æŠ¥å‘Š: cat NACOS_SYNC_FIX_REPORT.md"
echo ""
echo -e "${GREEN}âœ… ä¿®å¤è„šæœ¬æ‰§è¡Œå®Œæˆï¼${NC}"
echo ""


