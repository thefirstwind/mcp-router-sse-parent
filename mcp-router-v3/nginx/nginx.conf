# Nginx 配置文件 - MCP Router 负载均衡
# 简单的负载均衡配置，转发到 8051, 8052, 8053 端口

# DNS 解析配置：禁用 DNS 解析（upstream 使用 IP 地址，不需要 DNS）
# 注意：resolver 只在使用变量时才需要，这里 upstream 使用 IP，不需要 resolver
# resolver 127.0.0.1 valid=10s;
# resolver_timeout 1s;

# Events 块（必需）
# 注意：PID 文件使用 Nginx 默认位置，避免路径问题
events {
    worker_connections 1024;
}

http {
    # 错误日志配置（使用绝对路径，基于配置文件所在目录）
    # 注意：nginx 会基于配置文件所在目录解析相对路径
    # 配置文件在 nginx/ 目录，所以 logs/ 会解析为项目根目录的 logs/
    error_log /Users/shine/projects.mcp-router-sse-parent/mcp-router-v3/logs/nginx-error.log warn;
    access_log /Users/shine/projects.mcp-router-sse-parent/mcp-router-v3/logs/nginx-access.log;

    upstream mcp_router_backend {
        # 负载均衡策略：ip_hash 实现会话粘性（SSE 连接需要）
        ip_hash;
        
        # mcp-router-v3 实例（使用 IP 地址，避免 DNS 解析延迟）
        server 127.0.0.1:8051;
        server 127.0.0.1:8052;
        server 127.0.0.1:8053;
    }

    server {
        listen 80;
        listen [::]:80;  # 同时监听 IPv6
        server_name mcp-bridge.test;  # 生产环境替换为实际域名
        
        # ContextPath: /mcp-bridge
        # 将 /mcp-bridge/xxx 重写为 /xxx 并转发给后端
        location /mcp-bridge/ {
            # 去掉 /mcp-bridge 前缀，保留后续路径
            rewrite ^/mcp-bridge/(.*)$ /$1 break;
            
            proxy_pass http://mcp_router_backend;
            proxy_http_version 1.1;
            
            # 连接超时设置（关键：避免 5 秒延迟）
            proxy_connect_timeout 10s;     # 连接超时 10 秒
            proxy_send_timeout 600s;       # 发送超时 600 秒（SSE 长连接）
            proxy_read_timeout 600s;       # 读取超时 600 秒（SSE 长连接，10分钟）
            
            # 传递原始请求的 Host 和域名信息
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Prefix /mcp-bridge;  # 传递 contextPath 给后端
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # SSE/Streamable 特定配置
            proxy_buffering off;  # 禁用缓冲，确保 SSE/Streamable 实时传输
            proxy_cache off;
            proxy_set_header Connection "";
            proxy_set_header Cache-Control "no-cache";
            proxy_set_header X-Accel-Buffering "no";
        }
        
        # 根路径重定向到 /mcp-bridge（可选，根据需求决定是否保留）
        location = / {
            return 301 /mcp-bridge/;
        }
    }
}

