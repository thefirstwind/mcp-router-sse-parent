# Dify é›†æˆ MCP Bridge v3 è¯¦ç»†æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨ Dify ä¸­é›†æˆ MCP Bridge v3 çš„ä¸¤ä¸ªæ ¸å¿ƒæ¥å£ï¼Œå®ç°æ™ºèƒ½å·¥å…·å‘ç°å’Œè°ƒç”¨åŠŸèƒ½ã€‚

### æ ¸å¿ƒæ¥å£è¯´æ˜
- **æ¥å£1**: `/mcp/bridge/tools/{serviceName}` - è·å–æœåŠ¡çš„å·¥å…·åˆ—è¡¨
- **æ¥å£2**: `/mcp/bridge/route/{serviceName}` - è°ƒç”¨å…·ä½“å·¥å…·

### å®ç°æµç¨‹
1. é€šè¿‡æ¥å£1è·å–å¯ç”¨å·¥å…·åˆ—è¡¨
2. LLM ç†è§£å·¥å…·åŠŸèƒ½å’Œå‚æ•°
3. æ ¹æ®ç”¨æˆ·æ„å›¾é€‰æ‹©åˆé€‚çš„å·¥å…·
4. é€šè¿‡æ¥å£2è°ƒç”¨é€‰å®šçš„å·¥å…·

---

## ğŸš€ Dify é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºè‡ªå®šä¹‰å·¥å…·

#### 1.1 å·¥å…·å‘ç°æ¥å£é…ç½®

**è¿›å…¥ Dify å·¥ä½œå° â†’ å·¥å…· â†’ è‡ªå®šä¹‰å·¥å…· â†’ åˆ›å»ºå·¥å…·**

**åŸºç¡€ä¿¡æ¯**:
```yaml
å·¥å…·åç§°: MCP_Bridge_Tool_Discovery
å·¥å…·æè¿°: è·å– MCP Bridge æœåŠ¡çš„å¯ç”¨å·¥å…·åˆ—è¡¨
å·¥å…·å›¾æ ‡: ğŸ”§
```

**API é…ç½®**:
```yaml
# åŸºç¡€é…ç½®
è¯·æ±‚æ–¹æ³•: GET
è¯·æ±‚URL: http://localhost:8080/mcp/bridge/tools/{serviceName}
è®¤è¯æ–¹å¼: æ— è®¤è¯

# è·¯å¾„å‚æ•°
è·¯å¾„å‚æ•°:
  - å‚æ•°å: serviceName
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: true
    æè¿°: MCP æœåŠ¡åç§° (ä¾‹å¦‚: mcp-server-v6)
    é»˜è®¤å€¼: mcp-server-v6

# è¯·æ±‚å¤´
è¯·æ±‚å¤´:
  Content-Type: application/json
  Accept: application/json

# å“åº”é…ç½®
æˆåŠŸçŠ¶æ€ç : 200
å“åº”æ•°æ®ç±»å‹: JSON
```

**å·¥å…·å‚æ•°è®¾ç½®**:
```yaml
å‚æ•°é…ç½®:
  - å‚æ•°å: service_name
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: true
    æè¿°: è¦æŸ¥è¯¢çš„ MCP æœåŠ¡åç§°
    é»˜è®¤å€¼: mcp-server-v6
```

#### 1.2 å·¥å…·è°ƒç”¨æ¥å£é…ç½®

**åˆ›å»ºç¬¬äºŒä¸ªè‡ªå®šä¹‰å·¥å…·**:

**åŸºç¡€ä¿¡æ¯**:
```yaml
å·¥å…·åç§°: MCP_Bridge_Tool_Call
å·¥å…·æè¿°: è°ƒç”¨ MCP Bridge æœåŠ¡çš„å…·ä½“å·¥å…·
å·¥å…·å›¾æ ‡: âš¡
```

**API é…ç½®**:
```yaml
# åŸºç¡€é…ç½®
è¯·æ±‚æ–¹æ³•: POST
è¯·æ±‚URL: http://localhost:8080/mcp/bridge/route/{serviceName}
è®¤è¯æ–¹å¼: æ— è®¤è¯

# è·¯å¾„å‚æ•°
è·¯å¾„å‚æ•°:
  - å‚æ•°å: serviceName
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: true
    æè¿°: MCP æœåŠ¡åç§°
    é»˜è®¤å€¼: mcp-server-v6

# è¯·æ±‚ä½“
è¯·æ±‚ä½“ç±»å‹: JSON
è¯·æ±‚ä½“æ¨¡æ¿:
{
  "id": "{{request_id}}",
  "method": "tools/call",
  "params": {
    "name": "{{tool_name}}",
    "arguments": {{tool_arguments}}
  }
}

# è¯·æ±‚å¤´
è¯·æ±‚å¤´:
  Content-Type: application/json
  Accept: application/json
```

**å·¥å…·å‚æ•°è®¾ç½®**:
```yaml
å‚æ•°é…ç½®:
  - å‚æ•°å: service_name
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: true
    æè¿°: ç›®æ ‡ MCP æœåŠ¡åç§°
    
  - å‚æ•°å: tool_name
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: true
    æè¿°: è¦è°ƒç”¨çš„å·¥å…·åç§°
    
  - å‚æ•°å: tool_arguments
    å‚æ•°ç±»å‹: object
    æ˜¯å¦å¿…éœ€: false
    æè¿°: å·¥å…·è°ƒç”¨å‚æ•° (JSON å¯¹è±¡)
    é»˜è®¤å€¼: {}
    
  - å‚æ•°å: request_id
    å‚æ•°ç±»å‹: string
    æ˜¯å¦å¿…éœ€: false
    æè¿°: è¯·æ±‚å”¯ä¸€æ ‡è¯†
    é»˜è®¤å€¼: req-{{timestamp}}
```

### æ­¥éª¤ 2: åˆ›å»ºæ™ºèƒ½å·¥ä½œæµ

#### 2.1 åˆ›å»ºæ–°çš„å·¥ä½œæµåº”ç”¨

**åº”ç”¨é…ç½®**:
```yaml
åº”ç”¨ç±»å‹: å·¥ä½œæµ
åº”ç”¨åç§°: MCPæ™ºèƒ½å·¥å…·åŠ©æ‰‹
åº”ç”¨æè¿°: åŸºäº MCP Bridge çš„æ™ºèƒ½å·¥å…·è°ƒç”¨åŠ©æ‰‹
```

#### 2.2 è®¾è®¡å·¥ä½œæµèŠ‚ç‚¹

**èŠ‚ç‚¹1: å¼€å§‹èŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: å¼€å§‹
è¾“å…¥å˜é‡:
  - å˜é‡å: user_query
    å˜é‡ç±»å‹: text
    æè¿°: ç”¨æˆ·æŸ¥è¯¢æˆ–è¯·æ±‚
    ç¤ºä¾‹: "æŸ¥è¯¢IDä¸º1çš„äººå‘˜ä¿¡æ¯"
    
  - å˜é‡å: service_name
    å˜é‡ç±»å‹: text
    æè¿°: ç›®æ ‡æœåŠ¡åç§°
    é»˜è®¤å€¼: mcp-server-v6
```

**èŠ‚ç‚¹2: å·¥å…·å‘ç°èŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: å·¥å…·
èŠ‚ç‚¹åç§°: è·å–å·¥å…·åˆ—è¡¨
é€‰æ‹©å·¥å…·: MCP_Bridge_Tool_Discovery
å·¥å…·å‚æ•°:
  service_name: {{#start.service_name#}}
```

**èŠ‚ç‚¹3: LLM åˆ†æèŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: LLM
èŠ‚ç‚¹åç§°: åˆ†æç”¨æˆ·æ„å›¾
æ¨¡å‹: gpt-4 æˆ– claude-3
ç³»ç»Ÿæç¤ºè¯: |
  ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å·¥å…·é€‰æ‹©åŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·çš„æŸ¥è¯¢è¯·æ±‚å’Œå¯ç”¨çš„å·¥å…·åˆ—è¡¨ï¼Œåˆ†æç”¨æˆ·æ„å›¾å¹¶é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·ã€‚

  ## å¯ç”¨å·¥å…·åˆ—è¡¨
  {{#è·å–å·¥å…·åˆ—è¡¨.tools#}}

  ## ç”¨æˆ·æŸ¥è¯¢
  {{#start.user_query#}}

  ## ä»»åŠ¡è¦æ±‚
  1. åˆ†æç”¨æˆ·æŸ¥è¯¢çš„æ„å›¾
  2. ä»å¯ç”¨å·¥å…·ä¸­é€‰æ‹©æœ€åˆé€‚çš„å·¥å…·
  3. ç¡®å®šå·¥å…·è°ƒç”¨æ‰€éœ€çš„å‚æ•°
  4. è¾“å‡ºç»“æ„åŒ–çš„å·¥å…·è°ƒç”¨ä¿¡æ¯

  ## è¾“å‡ºæ ¼å¼
  è¯·æŒ‰ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡º:
  {
    "selected_tool": "å·¥å…·åç§°",
    "reasoning": "é€‰æ‹©åŸå› ",
    "arguments": {
      "å‚æ•°å": "å‚æ•°å€¼"
    },
    "confidence": 0.95
  }

  ## æ³¨æ„äº‹é¡¹
  - å¦‚æœç”¨æˆ·æŸ¥è¯¢ä¸æ˜ç¡®ï¼Œè¯·é€‰æ‹©æœ€å¯èƒ½çš„å·¥å…·
  - å‚æ•°å€¼éœ€è¦ä»ç”¨æˆ·æŸ¥è¯¢ä¸­æå–
  - å¦‚æœå‚æ•°ç¼ºå¤±ï¼Œä½¿ç”¨åˆç†çš„é»˜è®¤å€¼
  - confidence è¡¨ç¤ºé€‰æ‹©çš„ç½®ä¿¡åº¦ (0-1)

ç”¨æˆ·æç¤ºè¯: |
  ç”¨æˆ·æŸ¥è¯¢: {{#start.user_query#}}
  è¯·åˆ†æå¹¶é€‰æ‹©åˆé€‚çš„å·¥å…·ã€‚
```

**èŠ‚ç‚¹4: å‚æ•°æå–èŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: ä»£ç 
èŠ‚ç‚¹åç§°: æå–å·¥å…·å‚æ•°
ä»£ç è¯­è¨€: Python
ä»£ç å†…å®¹: |
  import json
  import re
  from datetime import datetime

  def main(llm_response: str, user_query: str) -> dict:
      try:
          # è§£æ LLM å“åº”
          response_data = json.loads(llm_response)
          
          # æå–åŸºç¡€ä¿¡æ¯
          tool_name = response_data.get('selected_tool', '')
          arguments = response_data.get('arguments', {})
          reasoning = response_data.get('reasoning', '')
          confidence = response_data.get('confidence', 0.0)
          
          # ç”Ÿæˆè¯·æ±‚ID
          request_id = f"req-{datetime.now().strftime('%Y%m%d%H%M%S')}"
          
          # å‚æ•°éªŒè¯å’Œè¡¥å……
          validated_args = validate_arguments(tool_name, arguments, user_query)
          
          return {
              "tool_name": tool_name,
              "tool_arguments": validated_args,
              "request_id": request_id,
              "reasoning": reasoning,
              "confidence": confidence,
              "success": True
          }
          
      except Exception as e:
          return {
              "error": str(e),
              "success": False,
              "tool_name": "",
              "tool_arguments": {},
              "request_id": f"error-{datetime.now().strftime('%Y%m%d%H%M%S')}"
          }

  def validate_arguments(tool_name: str, arguments: dict, user_query: str) -> dict:
      """éªŒè¯å’Œè¡¥å……å·¥å…·å‚æ•°"""
      
      if tool_name == "getPersonById":
          # ä»ç”¨æˆ·æŸ¥è¯¢ä¸­æå–ID
          id_match = re.search(r'ID[ä¸ºæ˜¯:ï¼š]\s*(\d+)|(\d+)\s*å·|ç¼–å·\s*(\d+)', user_query)
          if id_match:
              person_id = int(id_match.group(1) or id_match.group(2) or id_match.group(3))
              arguments["id"] = person_id
          elif "id" not in arguments:
              arguments["id"] = 1  # é»˜è®¤å€¼
              
      elif tool_name == "getAllPersons":
          # åˆ†é¡µå‚æ•°å¤„ç†
          if "page" not in arguments:
              arguments["page"] = 0
          if "size" not in arguments:
              arguments["size"] = 10
              
      elif tool_name == "addPerson":
          # ç¡®ä¿å¿…éœ€å‚æ•°å­˜åœ¨
          required_fields = ["firstName", "lastName", "age", "nationality", "gender"]
          for field in required_fields:
              if field not in arguments:
                  arguments[field] = extract_person_info(user_query, field)
      
      return arguments

  def extract_person_info(user_query: str, field: str) -> str:
      """ä»ç”¨æˆ·æŸ¥è¯¢ä¸­æå–äººå‘˜ä¿¡æ¯"""
      patterns = {
          "firstName": r'å§“å[æ˜¯ä¸º:ï¼š]\s*(\w+)',
          "lastName": r'å§“[æ˜¯ä¸º:ï¼š]\s*(\w+)',
          "age": r'å¹´é¾„[æ˜¯ä¸º:ï¼š]\s*(\d+)|(\d+)\s*å²',
          "nationality": r'å›½ç±[æ˜¯ä¸º:ï¼š]\s*(\w+)',
          "gender": r'æ€§åˆ«[æ˜¯ä¸º:ï¼š]\s*(ç”·|å¥³|MALE|FEMALE)'
      }
      
      pattern = patterns.get(field, '')
      if pattern:
          match = re.search(pattern, user_query)
          if match:
              return match.group(1) or match.group(2)
      
      # é»˜è®¤å€¼
      defaults = {
          "firstName": "Unknown",
          "lastName": "User",
          "age": "25",
          "nationality": "Unknown",
          "gender": "MALE"
      }
      
      return defaults.get(field, "Unknown")

è¾“å…¥å˜é‡:
  - llm_response: {{#åˆ†æç”¨æˆ·æ„å›¾.text#}}
  - user_query: {{#start.user_query#}}
```

**èŠ‚ç‚¹5: å·¥å…·è°ƒç”¨èŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: å·¥å…·
èŠ‚ç‚¹åç§°: æ‰§è¡Œå·¥å…·è°ƒç”¨
é€‰æ‹©å·¥å…·: MCP_Bridge_Tool_Call
å·¥å…·å‚æ•°:
  service_name: {{#start.service_name#}}
  tool_name: {{#æå–å·¥å…·å‚æ•°.tool_name#}}
  tool_arguments: {{#æå–å·¥å…·å‚æ•°.tool_arguments#}}
  request_id: {{#æå–å·¥å…·å‚æ•°.request_id#}}
```

**èŠ‚ç‚¹6: ç»“æœå¤„ç†èŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: LLM
èŠ‚ç‚¹åç§°: æ ¼å¼åŒ–å“åº”
æ¨¡å‹: gpt-4 æˆ– claude-3
ç³»ç»Ÿæç¤ºè¯: |
  ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å“åº”æ ¼å¼åŒ–åŠ©æ‰‹ã€‚å°†å·¥å…·è°ƒç”¨çš„ç»“æœè½¬æ¢ä¸ºè‡ªç„¶ã€å‹å¥½çš„ç”¨æˆ·å›å¤ã€‚

  ## åŸå§‹æŸ¥è¯¢
  {{#start.user_query#}}

  ## å·¥å…·è°ƒç”¨ä¿¡æ¯
  - é€‰æ‹©å·¥å…·: {{#æå–å·¥å…·å‚æ•°.tool_name#}}
  - é€‰æ‹©åŸå› : {{#æå–å·¥å…·å‚æ•°.reasoning#}}
  - ç½®ä¿¡åº¦: {{#æå–å·¥å…·å‚æ•°.confidence#}}

  ## å·¥å…·è°ƒç”¨ç»“æœ
  {{#æ‰§è¡Œå·¥å…·è°ƒç”¨.result#}}

  ## æ ¼å¼åŒ–è¦æ±‚
  1. ä½¿ç”¨è‡ªç„¶ã€å‹å¥½çš„è¯­è¨€
  2. çªå‡ºå…³é”®ä¿¡æ¯
  3. å¦‚æœå‡ºç°é”™è¯¯ï¼Œç»™å‡ºå‹å¥½çš„é”™è¯¯è¯´æ˜
  4. ä¿æŒå›å¤çš„ç®€æ´æ€§å’Œå‡†ç¡®æ€§

ç”¨æˆ·æç¤ºè¯: |
  è¯·å°†ä»¥ä¸Šå·¥å…·è°ƒç”¨ç»“æœæ ¼å¼åŒ–ä¸ºå‹å¥½çš„ç”¨æˆ·å›å¤ã€‚
```

**èŠ‚ç‚¹7: ç»“æŸèŠ‚ç‚¹**
```yaml
èŠ‚ç‚¹ç±»å‹: ç»“æŸ
è¾“å‡ºå˜é‡:
  - å˜é‡å: final_response
    å˜é‡å€¼: {{#æ ¼å¼åŒ–å“åº”.text#}}
    
  - å˜é‡å: tool_info
    å˜é‡å€¼: |
      {
        "selected_tool": "{{#æå–å·¥å…·å‚æ•°.tool_name#}}",
        "reasoning": "{{#æå–å·¥å…·å‚æ•°.reasoning#}}",
        "confidence": {{#æå–å·¥å…·å‚æ•°.confidence#}},
        "success": {{#æå–å·¥å…·å‚æ•°.success#}}
      }
      
  - å˜é‡å: raw_result
    å˜é‡å€¼: {{#æ‰§è¡Œå·¥å…·è°ƒç”¨.result#}}
```

### æ­¥éª¤ 3: é«˜çº§é…ç½®

#### 3.1 é”™è¯¯å¤„ç†åˆ†æ”¯

**æ·»åŠ æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: æ¡ä»¶åˆ†æ”¯
èŠ‚ç‚¹åç§°: æ£€æŸ¥å·¥å…·é€‰æ‹©ç»“æœ
æ¡ä»¶è®¾ç½®:
  æ¡ä»¶1: {{#æå–å·¥å…·å‚æ•°.success#}} == true
    ä¸‹ä¸€æ­¥: æ‰§è¡Œå·¥å…·è°ƒç”¨
  æ¡ä»¶2: {{#æå–å·¥å…·å‚æ•°.success#}} == false
    ä¸‹ä¸€æ­¥: é”™è¯¯å¤„ç†èŠ‚ç‚¹
```

**é”™è¯¯å¤„ç†èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: LLM
èŠ‚ç‚¹åç§°: é”™è¯¯å¤„ç†
ç³»ç»Ÿæç¤ºè¯: |
  å·¥å…·é€‰æ‹©è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·åˆ†æé”™è¯¯åŸå› å¹¶ç»™å‡ºå‹å¥½çš„å›å¤ã€‚

  ## ç”¨æˆ·æŸ¥è¯¢
  {{#start.user_query#}}

  ## é”™è¯¯ä¿¡æ¯
  {{#æå–å·¥å…·å‚æ•°.error#}}

  ## å¯ç”¨å·¥å…·åˆ—è¡¨
  {{#è·å–å·¥å…·åˆ—è¡¨.tools#}}

  è¯·ç»™å‡ºå‹å¥½çš„é”™è¯¯è¯´æ˜å’Œå»ºè®®ã€‚

ç”¨æˆ·æç¤ºè¯: |
  ç”¨æˆ·æŸ¥è¯¢: {{#start.user_query#}}
  è¯·åˆ†æé”™è¯¯å¹¶ç»™å‡ºå»ºè®®ã€‚
```

#### 3.2 å¤šæœåŠ¡æ”¯æŒ

**æœåŠ¡é€‰æ‹©èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: LLM
èŠ‚ç‚¹åç§°: é€‰æ‹©ç›®æ ‡æœåŠ¡
ç³»ç»Ÿæç¤ºè¯: |
  æ ¹æ®ç”¨æˆ·æŸ¥è¯¢ï¼Œé€‰æ‹©æœ€åˆé€‚çš„ MCP æœåŠ¡ã€‚

  ## å¯ç”¨æœåŠ¡åˆ—è¡¨
  - mcp-server-v3: åŸºç¡€äººå‘˜ç®¡ç†æœåŠ¡
  - mcp-server-v6: å¢å¼ºäººå‘˜ç®¡ç†æœåŠ¡ï¼Œæ”¯æŒæ›´å¤šåŠŸèƒ½
  - mcp-server-custom: è‡ªå®šä¹‰ä¸šåŠ¡æœåŠ¡

  ## ç”¨æˆ·æŸ¥è¯¢
  {{#start.user_query#}}

  ## è¾“å‡ºæ ¼å¼
  è¯·è¾“å‡ºæœåŠ¡åç§°ï¼Œä¾‹å¦‚: mcp-server-v6

ç”¨æˆ·æç¤ºè¯: |
  ç”¨æˆ·æŸ¥è¯¢: {{#start.user_query#}}
  è¯·é€‰æ‹©æœ€åˆé€‚çš„æœåŠ¡ã€‚
```

#### 3.3 ç¼“å­˜ä¼˜åŒ–

**æ·»åŠ ç¼“å­˜èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: ä»£ç 
èŠ‚ç‚¹åç§°: å·¥å…·åˆ—è¡¨ç¼“å­˜
ä»£ç å†…å®¹: |
  import json
  import time
  from typing import Dict, Any

  # ç®€å•å†…å­˜ç¼“å­˜ (ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨ Redis)
  cache = {}
  CACHE_TTL = 300  # 5åˆ†é’Ÿç¼“å­˜

  def main(service_name: str) -> Dict[str, Any]:
      cache_key = f"tools_{service_name}"
      current_time = time.time()
      
      # æ£€æŸ¥ç¼“å­˜
      if cache_key in cache:
          cached_data = cache[cache_key]
          if current_time - cached_data['timestamp'] < CACHE_TTL:
              return {
                  "use_cache": True,
                  "tools": cached_data['data'],
                  "cache_hit": True
              }
      
      # ç¼“å­˜æœªå‘½ä¸­æˆ–è¿‡æœŸ
      return {
          "use_cache": False,
          "cache_hit": False
      }

  def save_to_cache(service_name: str, tools_data: Any) -> Dict[str, Any]:
      cache_key = f"tools_{service_name}"
      cache[cache_key] = {
          "data": tools_data,
          "timestamp": time.time()
      }
      
      return {"cached": True}
```

### æ­¥éª¤ 4: æµ‹è¯•é…ç½®

#### 4.1 æµ‹è¯•ç”¨ä¾‹è®¾è®¡

**æµ‹è¯•ç”¨ä¾‹1: åŸºç¡€æŸ¥è¯¢**
```yaml
è¾“å…¥:
  user_query: "æŸ¥è¯¢IDä¸º1çš„äººå‘˜ä¿¡æ¯"
  service_name: "mcp-server-v6"

æœŸæœ›è¾“å‡º:
  - æ­£ç¡®è¯†åˆ« getPersonById å·¥å…·
  - æå–å‚æ•° id: 1
  - è¿”å›äººå‘˜è¯¦ç»†ä¿¡æ¯
```

**æµ‹è¯•ç”¨ä¾‹2: æ¨¡ç³ŠæŸ¥è¯¢**
```yaml
è¾“å…¥:
  user_query: "æˆ‘æƒ³çœ‹çœ‹æ‰€æœ‰ç”¨æˆ·"
  service_name: "mcp-server-v6"

æœŸæœ›è¾“å‡º:
  - æ­£ç¡®è¯†åˆ« getAllPersons å·¥å…·
  - ä½¿ç”¨é»˜è®¤åˆ†é¡µå‚æ•°
  - è¿”å›ç”¨æˆ·åˆ—è¡¨
```

**æµ‹è¯•ç”¨ä¾‹3: å¤æ‚æ“ä½œ**
```yaml
è¾“å…¥:
  user_query: "æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå§“åå«å¼ ä¸‰ï¼Œ25å²ï¼Œç”·æ€§ï¼Œä¸­å›½äºº"
  service_name: "mcp-server-v6"

æœŸæœ›è¾“å‡º:
  - æ­£ç¡®è¯†åˆ« addPerson å·¥å…·
  - æå–æ‰€æœ‰å¿…éœ€å‚æ•°
  - æˆåŠŸåˆ›å»ºæ–°ç”¨æˆ·
```

#### 4.2 è°ƒè¯•é…ç½®

**å¼€å¯è°ƒè¯•æ¨¡å¼**:
```yaml
å·¥ä½œæµè®¾ç½®:
  è°ƒè¯•æ¨¡å¼: å¼€å¯
  æ—¥å¿—çº§åˆ«: è¯¦ç»†
  ä¿å­˜ä¸­é—´ç»“æœ: æ˜¯
  
èŠ‚ç‚¹è°ƒè¯•:
  - åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹åæ·»åŠ è°ƒè¯•è¾“å‡º
  - ä¿å­˜ LLM çš„åŸå§‹å“åº”
  - è®°å½•å·¥å…·è°ƒç”¨çš„å®Œæ•´è¯·æ±‚å’Œå“åº”
```

**è°ƒè¯•è¾“å‡ºç¤ºä¾‹**:
```yaml
è°ƒè¯•èŠ‚ç‚¹é…ç½®:
  èŠ‚ç‚¹ç±»å‹: ä»£ç 
  èŠ‚ç‚¹åç§°: è°ƒè¯•è¾“å‡º
  ä»£ç å†…å®¹: |
    def main(**kwargs) -> dict:
        debug_info = {
            "timestamp": datetime.now().isoformat(),
            "node_inputs": kwargs,
            "processing_stage": "å·¥å…·é€‰æ‹©å®Œæˆ"
        }
        
        print(f"[DEBUG] {debug_info}")
        
        return {
            "debug_info": debug_info,
            "continue": True
        }
```

### æ­¥éª¤ 5: éƒ¨ç½²å’Œç›‘æ§

#### 5.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

**æ€§èƒ½ä¼˜åŒ–**:
```yaml
å·¥ä½œæµé…ç½®:
  å¹¶å‘å¤„ç†: å¯ç”¨
  æœ€å¤§å¹¶å‘æ•°: 10
  è¶…æ—¶è®¾ç½®: 30ç§’
  é‡è¯•æœºåˆ¶: å¯ç”¨
  é‡è¯•æ¬¡æ•°: 3
  
ç¼“å­˜é…ç½®:
  å¯ç”¨å·¥å…·åˆ—è¡¨ç¼“å­˜: æ˜¯
  ç¼“å­˜è¿‡æœŸæ—¶é—´: 5åˆ†é’Ÿ
  ç¼“å­˜æä¾›è€…: Redis
```

**å®‰å…¨é…ç½®**:
```yaml
å®‰å…¨è®¾ç½®:
  APIå¯†é’¥ç®¡ç†: å¯ç”¨
  è¯·æ±‚é¢‘ç‡é™åˆ¶: 100/åˆ†é’Ÿ
  IPç™½åå•: é…ç½®å…è®¸çš„IPæ®µ
  è¾“å…¥éªŒè¯: å¯ç”¨ä¸¥æ ¼éªŒè¯
  è¾“å‡ºè¿‡æ»¤: å¯ç”¨æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
```

#### 5.2 ç›‘æ§å’Œå‘Šè­¦

**ç›‘æ§æŒ‡æ ‡**:
```yaml
å…³é”®æŒ‡æ ‡:
  - å·¥ä½œæµæ‰§è¡ŒæˆåŠŸç‡
  - å¹³å‡å“åº”æ—¶é—´
  - å·¥å…·é€‰æ‹©å‡†ç¡®ç‡
  - é”™è¯¯ç±»å‹åˆ†å¸ƒ
  - ç”¨æˆ·æ»¡æ„åº¦

å‘Šè­¦è§„åˆ™:
  - æˆåŠŸç‡ < 95%
  - å“åº”æ—¶é—´ > 10ç§’
  - é”™è¯¯ç‡ > 5%
  - è¿ç»­å¤±è´¥ > 5æ¬¡
```

**æ—¥å¿—é…ç½®**:
```yaml
æ—¥å¿—è®¾ç½®:
  æ—¥å¿—çº§åˆ«: INFO
  ä¿ç•™æ—¶é—´: 30å¤©
  
è®°å½•å†…å®¹:
  - ç”¨æˆ·æŸ¥è¯¢åŸæ–‡
  - å·¥å…·é€‰æ‹©è¿‡ç¨‹
  - å‚æ•°æå–ç»“æœ
  - å·¥å…·è°ƒç”¨å“åº”
  - æœ€ç»ˆå›å¤å†…å®¹
  - æ‰§è¡Œæ—¶é•¿ç»Ÿè®¡
```

---

## ğŸ”§ é«˜çº§åŠŸèƒ½é…ç½®

### 1. å¤šè½®å¯¹è¯æ”¯æŒ

**å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†**:
```yaml
èŠ‚ç‚¹ç±»å‹: ä»£ç 
èŠ‚ç‚¹åç§°: ä¸Šä¸‹æ–‡ç®¡ç†
ä»£ç å†…å®¹: |
  def main(user_query: str, conversation_id: str = None) -> dict:
      # è·å–å¯¹è¯å†å²
      context = get_conversation_context(conversation_id)
      
      # åˆ†ææ˜¯å¦éœ€è¦ä¸Šä¸‹æ–‡ä¿¡æ¯
      needs_context = analyze_context_dependency(user_query)
      
      if needs_context and context:
          # åˆå¹¶ä¸Šä¸‹æ–‡ä¿¡æ¯
          enriched_query = f"""
          ## å¯¹è¯å†å²
          {context.get('history', '')}
          
          ## å½“å‰æŸ¥è¯¢
          {user_query}
          
          ## ä¸Šæ¬¡å·¥å…·è°ƒç”¨ç»“æœ
          {context.get('last_result', '')}
          """
          
          return {
              "enriched_query": enriched_query,
              "has_context": True,
              "conversation_id": conversation_id
          }
      
      return {
          "enriched_query": user_query,
          "has_context": False,
          "conversation_id": conversation_id or generate_conversation_id()
      }
```

### 2. æ™ºèƒ½å‚æ•°è¡¥å…¨

**å‚æ•°è¡¥å…¨èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: LLM
èŠ‚ç‚¹åç§°: æ™ºèƒ½å‚æ•°è¡¥å…¨
ç³»ç»Ÿæç¤ºè¯: |
  ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½å‚æ•°è¡¥å…¨åŠ©æ‰‹ã€‚å½“å·¥å…·è°ƒç”¨å‚æ•°ä¸å®Œæ•´æ—¶ï¼Œé€šè¿‡åˆ†æä¸Šä¸‹æ–‡å’Œå¸¸è§æ¨¡å¼æ¥è¡¥å…¨å‚æ•°ã€‚

  ## å·¥å…·å®šä¹‰
  {{#å·¥å…·å®šä¹‰#}}

  ## ç”¨æˆ·æŸ¥è¯¢
  {{#ç”¨æˆ·æŸ¥è¯¢#}}

  ## å½“å‰å‚æ•°
  {{#å½“å‰å‚æ•°#}}

  ## è¡¥å…¨ç­–ç•¥
  1. ä»ç”¨æˆ·æŸ¥è¯¢ä¸­æå–éšå«ä¿¡æ¯
  2. ä½¿ç”¨åˆç†çš„é»˜è®¤å€¼
  3. åŸºäºä¸Šä¸‹æ–‡æ¨æ–­ç¼ºå¤±å‚æ•°
  4. å¦‚æœæ— æ³•ç¡®å®šï¼Œè¯·æ±‚ç”¨æˆ·ç¡®è®¤

  è¯·è¾“å‡ºè¡¥å…¨åçš„å®Œæ•´å‚æ•°ã€‚
```

### 3. ç»“æœéªŒè¯å’Œä¿®æ­£

**ç»“æœéªŒè¯èŠ‚ç‚¹**:
```yaml
èŠ‚ç‚¹ç±»å‹: ä»£ç 
èŠ‚ç‚¹åç§°: ç»“æœéªŒè¯
ä»£ç å†…å®¹: |
  def main(tool_result: dict, user_query: str, tool_name: str) -> dict:
      """éªŒè¯å·¥å…·è°ƒç”¨ç»“æœçš„åˆç†æ€§"""
      
      validation_result = {
          "is_valid": True,
          "confidence": 1.0,
          "issues": [],
          "suggestions": []
      }
      
      # æ£€æŸ¥ç»“æœæ ¼å¼
      if not validate_result_format(tool_result, tool_name):
          validation_result["issues"].append("ç»“æœæ ¼å¼ä¸æ­£ç¡®")
          validation_result["is_valid"] = False
      
      # æ£€æŸ¥ç»“æœå†…å®¹
      if not validate_result_content(tool_result, user_query):
          validation_result["issues"].append("ç»“æœå†…å®¹ä¸æŸ¥è¯¢ä¸åŒ¹é…")
          validation_result["confidence"] *= 0.7
      
      # æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
      if not validate_data_completeness(tool_result, tool_name):
          validation_result["issues"].append("æ•°æ®ä¸å®Œæ•´")
          validation_result["confidence"] *= 0.8
          validation_result["suggestions"].append("å»ºè®®é‡æ–°è°ƒç”¨å·¥å…·")
      
      return validation_result
```

---

## ğŸ“Š æµ‹è¯•å’ŒéªŒè¯

### å®Œæ•´æµ‹è¯•æµç¨‹

**1. å•å…ƒæµ‹è¯•**:
```bash
# æµ‹è¯•å·¥å…·å‘ç°æ¥å£
curl -X GET "http://localhost:8080/mcp/bridge/tools/mcp-server-v6" \
  -H "Accept: application/json"

# æµ‹è¯•å·¥å…·è°ƒç”¨æ¥å£
curl -X POST "http://localhost:8080/mcp/bridge/route/mcp-server-v6" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "test-001",
    "method": "tools/call",
    "params": {
      "name": "getPersonById",
      "arguments": {"id": 1}
    }
  }'
```

**2. é›†æˆæµ‹è¯•**:
åœ¨ Dify ä¸­åˆ›å»ºæµ‹è¯•å¯¹è¯ï¼ŒéªŒè¯å®Œæ•´æµç¨‹ï¼š

```
ç”¨æˆ·: "æŸ¥è¯¢IDä¸º1çš„äººå‘˜ä¿¡æ¯"
æœŸæœ›: ç³»ç»Ÿè‡ªåŠ¨é€‰æ‹© getPersonById å·¥å…·å¹¶è¿”å›ç»“æœ

ç”¨æˆ·: "æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·"  
æœŸæœ›: ç³»ç»Ÿé€‰æ‹© getAllPersons å·¥å…·å¹¶è¿”å›ç”¨æˆ·åˆ—è¡¨

ç”¨æˆ·: "æ·»åŠ æ–°ç”¨æˆ·å¼ ä¸‰"
æœŸæœ›: ç³»ç»Ÿè¯†åˆ«éœ€è¦æ›´å¤šä¿¡æ¯å¹¶å¼•å¯¼ç”¨æˆ·è¡¥å……
```

**3. æ€§èƒ½æµ‹è¯•**:
```yaml
æµ‹è¯•æŒ‡æ ‡:
  - å·¥å…·å‘ç°å“åº”æ—¶é—´: < 1ç§’
  - å·¥å…·è°ƒç”¨å“åº”æ—¶é—´: < 3ç§’
  - æ•´ä½“å·¥ä½œæµå“åº”æ—¶é—´: < 10ç§’
  - å¹¶å‘æ”¯æŒ: 10ä¸ªå¹¶å‘å¯¹è¯
```

---

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

### 1. Prompt è®¾è®¡åŸåˆ™
- **æ˜ç¡®æ€§**: ç³»ç»Ÿæç¤ºè¯è¦æ˜ç¡®æè¿°ä»»åŠ¡ç›®æ ‡
- **ç»“æ„åŒ–**: ä½¿ç”¨ç»“æ„åŒ–çš„è¾“å‡ºæ ¼å¼
- **ç¤ºä¾‹å¯¼å‘**: æä¾›å…·ä½“çš„è¾“å…¥è¾“å‡ºç¤ºä¾‹
- **é”™è¯¯å¤„ç†**: åŒ…å«é”™è¯¯æƒ…å†µçš„å¤„ç†æŒ‡å¯¼

### 2. å·¥ä½œæµä¼˜åŒ–
- **æ¨¡å—åŒ–**: å°†å¤æ‚é€»è¾‘æ‹†åˆ†ä¸ºç‹¬ç«‹èŠ‚ç‚¹
- **å¯é‡ç”¨**: è®¾è®¡å¯é‡ç”¨çš„å­å·¥ä½œæµ
- **å¯æµ‹è¯•**: æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦ä¾¿äºç‹¬ç«‹æµ‹è¯•
- **å¯ç›‘æ§**: æ·»åŠ å…³é”®èŠ‚ç‚¹çš„ç›‘æ§å’Œæ—¥å¿—

### 3. é”™è¯¯å¤„ç†ç­–ç•¥
- **åˆ†çº§å¤„ç†**: åŒºåˆ†ç³»ç»Ÿé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
- **å‹å¥½æç¤º**: ç»™ç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
- **è‡ªåŠ¨é‡è¯•**: å¯¹ä¸´æ—¶æ€§é”™è¯¯å®ç°è‡ªåŠ¨é‡è¯•
- **é™çº§æ–¹æ¡ˆ**: æä¾›å¤‡é€‰çš„å¤„ç†æ–¹æ¡ˆ

### 4. æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è°ƒç”¨
- **å¹¶è¡Œå¤„ç†**: é€‚å½“ä½¿ç”¨å¹¶è¡ŒèŠ‚ç‚¹æé«˜æ•ˆç‡
- **èµ„æºç®¡ç†**: æ§åˆ¶å¹¶å‘æ•°é‡å’Œèµ„æºä½¿ç”¨
- **è¶…æ—¶æ§åˆ¶**: è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´

---

## ğŸš€ æ‰©å±•åŠŸèƒ½

### 1. æ”¯æŒæ›´å¤š MCP æœåŠ¡
ä¿®æ”¹æœåŠ¡é€‰æ‹©é€»è¾‘ï¼Œæ”¯æŒåŠ¨æ€å‘ç°å’Œé€‰æ‹©ä¸åŒçš„ MCP æœåŠ¡ã€‚

### 2. æ™ºèƒ½å­¦ä¹ åŠŸèƒ½
åŸºäºç”¨æˆ·è¡Œä¸ºæ•°æ®ï¼Œä¼˜åŒ–å·¥å…·é€‰æ‹©çš„å‡†ç¡®æ€§ã€‚

### 3. å¤šè¯­è¨€æ”¯æŒ
æ‰©å±•æ”¯æŒå¤šç§è¯­è¨€çš„æŸ¥è¯¢å’Œå“åº”ã€‚

### 4. è‡ªå®šä¹‰å·¥å…·
å…è®¸ç”¨æˆ·æ³¨å†Œå’Œä½¿ç”¨è‡ªå®šä¹‰çš„ MCP å·¥å…·ã€‚

---

> ğŸ’¡ **é›†æˆæç¤º**: 
> 1. å¼€å§‹æ—¶ä½¿ç”¨ç®€å•çš„æµ‹è¯•ç”¨ä¾‹éªŒè¯åŸºæœ¬åŠŸèƒ½
> 2. é€æ­¥å¢åŠ å¤æ‚çš„åœºæ™¯å’Œé”™è¯¯å¤„ç†
> 3. æŒç»­ä¼˜åŒ– Prompt æé«˜å·¥å…·é€‰æ‹©å‡†ç¡®æ€§
> 4. å»ºç«‹å®Œå–„çš„æµ‹è¯•å’Œç›‘æ§ä½“ç³»
> 5. æ ¹æ®ç”¨æˆ·åé¦ˆä¸æ–­æ”¹è¿›ç”¨æˆ·ä½“éªŒ
