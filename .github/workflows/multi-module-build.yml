name: Multi-Module Maven Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # 检测变更的模块
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      mcp-router: ${{ steps.filter.outputs.mcp-router }}
      mcp-server-v3: ${{ steps.filter.outputs.mcp-server-v3 }}
      mcp-server-v4: ${{ steps.filter.outputs.mcp-server-v4 }}
      mcp-server-v6: ${{ steps.filter.outputs.mcp-server-v6 }}
      mcp-client: ${{ steps.filter.outputs.mcp-client }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            mcp-router:
              - 'mcp-router-v3/**'
              - 'pom.xml'
            mcp-server-v3:
              - 'mcp-server-v3/**'
              - 'pom.xml'
            mcp-server-v4:
              - 'mcp-server-v4/**'
              - 'pom.xml'
            mcp-server-v6:
              - 'mcp-server-v6/**'
              - 'pom.xml'
            mcp-client:
              - 'mcp-client/**'
              - 'pom.xml'

  # 构建和测试
  build-and-test:
    needs: detect-changes
    runs-on: ubuntu-latest
    if: |
      needs.detect-changes.outputs.mcp-router == 'true' ||
      needs.detect-changes.outputs.mcp-server-v3 == 'true' ||
      needs.detect-changes.outputs.mcp-server-v4 == 'true' ||
      needs.detect-changes.outputs.mcp-server-v6 == 'true' ||
      needs.detect-changes.outputs.mcp-client == 'true'
    
    strategy:
      matrix:
        module: 
          - mcp-router-v3
          - mcp-server-v3
          - mcp-server-v4
          - mcp-server-v6
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: maven
      
      - name: Check if module changed
        id: check
        run: |
          MODULE=${{ matrix.module }}
          CHANGED="${{ needs.detect-changes.outputs[matrix.module] }}"
          echo "Module: $MODULE"
          echo "Changed: $CHANGED"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
      
      - name: Build ${{ matrix.module }}
        if: steps.check.outputs.changed == 'true'
        run: |
          cd ${{ matrix.module }}
          mvn clean install -DskipTests
      
      - name: Test ${{ matrix.module }}
        if: steps.check.outputs.changed == 'true'
        run: |
          cd ${{ matrix.module }}
          mvn test
      
      - name: Upload build artifacts
        if: steps.check.outputs.changed == 'true' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.module }}-jar
          path: ${{ matrix.module }}/target/*.jar
          retention-days: 7

  # 整体构建验证（可选，确保所有模块一起工作）
  full-build:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: maven
      
      - name: Full build
        run: mvn clean install
      
      - name: Run all tests
        run: mvn test
