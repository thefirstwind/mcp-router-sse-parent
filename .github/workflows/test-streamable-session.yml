name: Streamable Session Management Tests

on:
  pull_request:
    paths:
      - 'mcp-router-v3/src/main/java/com/pajk/mcpbridge/core/config/McpRouterServerConfig.java'
      - 'mcp-router-v3/src/main/java/com/pajk/mcpbridge/core/service/McpSessionService.java'
      - 'test_streamable_*.sh'
      - '.github/workflows/test-streamable-session.yml'
  push:
    branches:
      - main
      - 'bugfix/fix-streamable-*'
    paths:
      - 'mcp-router-v3/src/main/java/com/pajk/mcpbridge/core/**'
      - 'test_streamable_*.sh'

jobs:
  test-streamable-session:
    name: Test Streamable Session Management
    runs-on: ubuntu-latest
    
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      # å¯é€‰: NacosæœåŠ¡
      # nacos:
      #   image: nacos/nacos-server:latest
      #   ports:
      #     - 8848:8848
      #   env:
      #     MODE: standalone
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'corretto'
          cache: maven
      
      - name: Build mcp-router-v3
        run: |
          cd mcp-router-v3
          mvn clean package -DskipTests
      
      - name: Start mcp-router-v3
        run: |
          cd mcp-router-v3
          nohup mvn spring-boot:run > router.log 2>&1 &
          echo $! > router.pid
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          timeout 60 bash -c 'until curl -f http://localhost:8052/actuator/health; do sleep 2; done'
        env:
          SPRING_PROFILES_ACTIVE: test
      
      - name: Build and start mcp-server-v6 (æµ‹è¯•ç›®æ ‡æœåŠ¡)
        run: |
          cd mcp-server-v6
          mvn clean package -DskipTests
          nohup mvn spring-boot:run > server.log 2>&1 &
          echo $! > server.pid
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 10
      
      - name: Run quick tests
        run: |
          chmod +x test_streamable_session.sh
          ./test_streamable_session.sh
        env:
          ROUTER_URL: http://localhost:8052
          SERVICE_NAME: mcp-server-v6
      
      - name: Run comprehensive tests
        run: |
          chmod +x test_streamable_comprehensive.sh
          ./test_streamable_comprehensive.sh
        env:
          ROUTER_URL: http://localhost:8052
          SERVICE_NAME: mcp-server-v6
          REDIS_HOST: localhost
          REDIS_PORT: 6379
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test_results.log
            mcp-router-v3/router.log
            mcp-server-v6/server.log
      
      - name: Cleanup
        if: always()
        run: |
          # åœæ­¢æœåŠ¡
          if [ -f mcp-router-v3/router.pid ]; then
            kill $(cat mcp-router-v3/router.pid) || true
          fi
          if [ -f mcp-server-v6/server.pid ]; then
            kill $(cat mcp-server-v6/server.pid) || true
          fi
      
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let testResults = 'Test results not available';
            
            try {
              testResults = fs.readFileSync('test_results.log', 'utf8');
            } catch (err) {
              console.log('Could not read test results');
            }
            
            const output = `## ğŸ§ª Streamable Session Management Tests
            
            <details>
            <summary>Test Results</summary>
            
            \`\`\`
            ${testResults}
            \`\`\`
            
            </details>
            
            ğŸ“– [æŸ¥çœ‹åŠŸèƒ½æ–‡æ¡£](docs/features/streamable-session-management.md)
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
