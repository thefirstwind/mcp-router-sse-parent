#!/bin/bash
# Streamable Protocol Session Management Test
# ÊµãËØï Streamable ÂçèËÆÆÁöÑ session ‰ºöËØùÁÆ°ÁêÜ‰øÆÂ§ç

echo "üß™ Testing Streamable Protocol Session Management..."
echo ""

# ÈÖçÁΩÆ
ROUTER_URL="${ROUTER_URL:-http://localhost:18791}"
SERVICE_NAME="${SERVICE_NAME:-mcp-server-v6}"

echo "üì° Router URL: $ROUTER_URL"
echo "üéØ Service Name: $SERVICE_NAME"
echo ""

# ÊµãËØï 1: GET /mcp - È™åËØÅÂàùÂßãËøûÊé•Âíå session Ê∂àÊÅØ
echo "Test 1: GET /mcp - Verify session initialization"
echo "================================================"
echo "curl -N -H \"Accept: application/x-ndjson\" \"$ROUTER_URL/mcp/$SERVICE_NAME\""
echo ""
echo "Expected: First line should contain session info with type='session', sessionId, and messageEndpoint"
echo ""
echo "Running..."
timeout 3 curl -N -H "Accept: application/x-ndjson" "$ROUTER_URL/mcp/$SERVICE_NAME" 2>/dev/null | head -n 1
echo ""
echo ""

# ÊµãËØï 2: Ê£ÄÊü•ÂìçÂ∫îÂ§¥‰∏≠ÁöÑ Mcp-Session-Id
echo "Test 2: Check Mcp-Session-Id response header"
echo "============================================="
echo "curl -I \"$ROUTER_URL/mcp/$SERVICE_NAME\""
echo ""
echo "Expected: Response should include 'Mcp-Session-Id' header"
echo ""
echo "Running..."
curl -I "$ROUTER_URL/mcp/$SERVICE_NAME" 2>/dev/null | grep -i "mcp-session-id"
echo ""
echo ""

# ÊµãËØï 3: POST /mcp/message - È™åËØÅ sessionId Ëß£ÊûêÊó•Âøó
echo "Test 3: POST /mcp/message - Session ID resolution"
echo "=================================================="
echo "Test case 3a: With Mcp-Session-Id header"
echo ""
TEST_SESSION_ID="test-session-$(date +%s)"
echo "curl -X POST -H \"Content-Type: application/json\" \\"
echo "     -H \"Mcp-Session-Id: $TEST_SESSION_ID\" \\"
echo "     -d '{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"tools/list\"}' \\"
echo "     \"$ROUTER_URL/mcp/$SERVICE_NAME/message\""
echo ""
echo "Expected: Should log '‚úÖ Resolved sessionId from header'"
echo ""
echo "(Check server logs for resolution confirmation)"
echo ""
echo ""

echo "Test case 3b: With sessionId query parameter"
echo ""
echo "curl -X POST -H \"Content-Type: application/json\" \\"
echo "     -d '{\"jsonrpc\":\"2.0\",\"id\":\"2\",\"method\":\"tools/list\"}' \\"
echo "     \"$ROUTER_URL/mcp/$SERVICE_NAME/message?sessionId=$TEST_SESSION_ID\""
echo ""
echo "Expected: Should log '‚úÖ Resolved sessionId from query parameter'"
echo ""
echo "(Check server logs for resolution confirmation)"
echo ""
echo ""

echo "Test case 3c: Without sessionId"
echo ""
echo "curl -X POST -H \"Content-Type: application/json\" \\"
echo "     -d '{\"jsonrpc\":\"2.0\",\"id\":\"3\",\"method\":\"tools/list\"}' \\"
echo "     \"$ROUTER_URL/mcp/$SERVICE_NAME/message\""
echo ""
echo "Expected: Should log '‚ö†Ô∏è No sessionId found' warning and auto-generate sessionId"
echo ""
echo "(Check server logs for warning message)"
echo ""
echo ""

# ‰ΩøÁî®ËØ¥Êòé
echo "üìù Usage Instructions:"
echo "====================="
echo "1. Make sure mcp-router-v3 is running on port 18791"
echo "2. Run this script: ./test_streamable_session.sh"
echo "3. Check the router logs for detailed session resolution logging"
echo "4. Verify that the first NDJSON message contains session information"
echo ""
echo "üîç Log Analysis:"
echo "================"
echo "Look for these log patterns in mcp-router-v3 logs:"
echo "  - '‚úÖ Resolved sessionId from header' - sessionId from request header"
echo "  - '‚úÖ Resolved sessionId from query parameter' - sessionId from query param"
echo "  - '‚ö†Ô∏è No sessionId found' - missing sessionId (auto-generated)"
echo "  - 'üì° Streamable request' - streamable connection initiated"
echo ""
echo "‚úÖ Test script completed!"
